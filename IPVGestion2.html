<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión IPV @EricksProductions</title>
    <link rel="icon" type="image/png" href="./img/Logo.png">


</head>
<style>
   /*
     * 0. IMPORTS & GLOBAL RESET
     * ---------------------------------------------------------------
     */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&display=swap');


    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    /*
     * 1. ROOT VARIABLES & GLOBAL STYLES
     * ---------------------------------------------------------------
     */
    :root {
        --bg-dark: #0A0E1A;
        --bg-primary: #121829;
        --bg-glass: rgba(18, 24, 41, 0.6);
        --border-glass: rgba(136, 173, 255, 0.15);
        --border-highlight: rgba(136, 173, 255, 0.3);
        --primary-cyan: #00E0FF;
        --primary-magenta: #E100FF;
        --glow-cyan: rgba(0, 224, 255, 0.3);
        --glow-magenta: rgba(225, 0, 255, 0.25);
        --success-color: #00FF95;
        --danger-color: #FF3D71;
        --warning-color: #FFD600;
        --glow-success: rgba(0, 255, 149, 0.3);
        --glow-danger: rgba(255, 61, 113, 0.3);
        --text-primary: #E0E5FF;
        --text-secondary: #88ADFF;
        --text-headings: #FFFFFF;
        --font-main: 'Inter', sans-serif;
        --font-serif: 'Playfair Display', serif;
        --font-mono: 'Roboto Mono', monospace;
        --radius-sm: 6px;
        --radius-md: 12px;
        --radius-lg: 20px;
        --backdrop-blur: 12px;
        --transition-fast: 0.2s ease-out;
        --transition-slow: 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    body {
        font-family: var(--font-main);
        background-color: var(--bg-dark);
        color: var(--text-primary);
        overflow-x: hidden;
        position: relative;
    }

    body::before {
        content: '';
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        z-index: -1;
        background-image:
            radial-gradient(circle at 15% 20%, var(--glow-cyan) 0%, transparent 30%),
            radial-gradient(circle at 85% 75%, var(--glow-magenta) 0%, transparent 35%);
        background-repeat: no-repeat;
        opacity: 0.5;
    }

    /* Custom Scrollbars */
    ::-webkit-scrollbar { width: 10px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, var(--primary-cyan), var(--primary-magenta));
        border-radius: 10px;
        border: 2px solid var(--bg-primary);
    }

    .hidden {
        display: none !important;
    }
    
    /* Corrección del Ojo de Contraseña */
    input[type="password"] {
        color-scheme: dark; /* Hace el icono del ojo blanco/claro */
    }
    input[type="password"]::-ms-reveal,
    input[type="password"]::-ms-clear {
        filter: invert(1);
    }
    /* === FIN: _base.css === */


    /* === INICIO: _layout.css === */
    /* PARTIAL: _layout.css */

    .container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 20px;
        padding-top: 40px; 
        transition: filter var(--transition-slow);
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 24px;
        position: sticky;
        top: 10px;
        margin: 0 10px;
        z-index: 1000;
        background: var(--bg-glass);
        border: 1px solid var(--border-glass);
        border-radius: var(--radius-md);
        backdrop-filter: blur(var(--backdrop-blur));
        box-shadow: 0 4px 30px rgba(0,0,0,0.2);
        transition: transform 0.4s cubic-bezier(0.2, 0, 0, 1), box-shadow var(--transition-fast);
        flex-wrap: wrap;
    }

    .header.header-hidden {
        transform: translateY(calc(-100% - 20px));
    }

    .header-left, .header-center, .header-right {
        display: flex;
        align-items: center;
        gap: 16px;
    }
    .header-left {
        flex-grow: 1;
    }
    .header-center {
        flex-grow: 2;
        justify-content: center;
    }
    .header-right {
        flex-grow: 1;
        justify-content: flex-end;
    }

    .header .logo {
        height: 40px;
        width: 40px;
        object-fit: contain;
        transition: transform var(--transition-fast), filter var(--transition-fast);
    }

    .header .logo:hover {
        transform: scale(1.1) rotate(-5deg);
        filter: drop-shadow(0 0 10px var(--glow-cyan));
    }

    .header h1 {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--text-headings);
        text-shadow: 0 0 5px var(--glow-cyan);
    }

    .header-date-input {
        background: var(--bg-primary);
        border: 1px solid var(--border-glass);
        border-radius: var(--radius-sm);
        overflow: hidden;
        display: flex;
    }

    .header-date-input input[type="date"] {
        background: transparent;
        border: none;
        color: var(--text-primary);
        padding: 6px 10px;
        font-family: var(--font-main);
    }
    .header-date-input input[type="date"]::-webkit-calendar-picker-indicator {
        filter: invert(0.8) brightness(1.2);
        cursor: pointer;
    }

    .header-date-input button {
        background: transparent;
        border: none;
        color: var(--text-secondary);
        padding: 8px 10px;
        cursor: pointer;
        transition: background-color var(--transition-fast), color var(--transition-fast);
    }
    .header-date-input button:first-of-type { border-right: 1px solid var(--border-glass); }
    .header-date-input button:last-of-type { border-left: 1px solid var(--border-glass); }

    .header-date-input button:hover {
        background-color: var(--border-highlight);
        color: var(--primary-cyan);
    }

    #searchInput {
        background: var(--bg-primary);
        border: 1px solid var(--border-glass);
        border-radius: var(--radius-sm);
        padding: 8px 14px;
        color: var(--text-primary);
        width: 100%;
        max-width: 400px;
        transition: all var(--transition-fast);
    }

    #searchInput:focus {
        outline: none;
        border-color: var(--primary-cyan);
        box-shadow: 0 0 15px var(--glow-cyan);
    }

    .menu-toggle { display: none; }

    .hamburger-menu {
        display: flex;
        cursor: pointer;
        width: 28px;
        height: 22px;
        flex-direction: column;
        justify-content: space-between;
        z-index: 1052; /* Superior al menú para que siempre sea clickeable */
        position: relative;
        flex-shrink: 0;
    }

    .hamburger-menu span {
        display: block;
        width: 100%;
        height: 3px;
        background: var(--text-primary);
        border-radius: 3px;
        transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        transform-origin: center;
    }

    .menu-toggle:checked + .menu-backdrop + .container { filter: blur(4px) brightness(0.8); }
    .menu-toggle:checked ~ .hamburger-menu span:nth-child(1) { transform: translateY(9.5px) rotate(45deg); }
    .menu-toggle:checked ~ .hamburger-menu span:nth-child(2) { opacity: 0; }
    .menu-toggle:checked ~ .hamburger-menu span:nth-child(3) { transform: translateY(-9.5px) rotate(-45deg); }

    .header-menu {
        position: fixed;
        top: 0;
        right: -320px;
        width: 300px;
        max-width: 90vw;
        height: 100vh;
        background: var(--bg-glass);
        border-left: 1px solid var(--border-glass);
        backdrop-filter: blur(var(--backdrop-blur));
        box-shadow: -10px 0 30px rgba(0,0,0,0.3);
        padding: 80px 20px 20px 20px;
        z-index: 1051; /* Z-index del menú */
        overflow-y: auto;
        transition: right var(--transition-slow);
    }

    .menu-toggle:checked ~ .header-menu { right: 0; }

    .menu-backdrop {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1050; /* Z-index del fondo, justo debajo del menú */
        opacity: 0;
        visibility: hidden;
        transition: opacity var(--transition-fast), visibility var(--transition-fast);
    }

    .menu-toggle:checked ~ .menu-backdrop { opacity: 1; visibility: visible; }

    .header-menu h2 {
        color: var(--text-headings);
        border-bottom: 1px solid var(--border-glass);
        padding-bottom: 15px;
        margin-bottom: 20px;
        font-size: 1.5rem;
    }

    .header-menu-section { margin-bottom: 25px; }

    .header-menu-section h4 {
        color: var(--text-secondary);
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        margin-bottom: 12px;
    }

    #scroll-fab-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    #scroll-fab-container button {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: 1px solid var(--border-glass);
        background: var(--bg-glass);
        backdrop-filter: blur(var(--backdrop-blur));
        color: var(--primary-cyan);
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        opacity: 0;
        transform: scale(0.8) translateY(10px);
        pointer-events: none;
        transition: opacity 0.3s ease, transform 0.3s ease;
    }

    #scroll-fab-container button.visible {
        opacity: 1;
        transform: scale(1) translateY(0);
        pointer-events: auto;
    }

    #scroll-fab-container button:hover {
        background: var(--border-highlight);
        box-shadow: 0 0 20px var(--glow-cyan);
        transform: scale(1.1);
    }

    #scroll-fab-container button svg {
        stroke: currentColor;
        width: 24px;
        height: 24px;
    }

    @media (max-width: 768px) {
        .container {
            padding-top: 25px; /* Reducido de 170px, ajustado para el header alto en móviles */
        }

       .header {
            top: 0;
            margin: 0;
            border-radius: 0;
            padding: 10px 15px;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
        }

        .header-left {
            order: 1;
            width: calc(100% - 40px);
            gap: 10px;
        }

        #header-admin-btn {
            display: none;
        }

        .hamburger-menu {
            order: 2;
            margin-left: auto;
        }

        .header-date-input {
            order: 3;
            width: 100%;
            justify-content: center;
        }

        .header-center {
            order: 4;
            width: 100%;
        }

        #searchInput {
            max-width: none;
        }

        #scroll-fab-container {
            bottom: 15px;
            right: 15px;
        }
        #scroll-fab-container button {
            width: 45px;
            height: 45px;
        }
    }

    @media (max-width: 480px) {
        body { font-size: 14px; }
        .header h1 { font-size: 1rem; }
    }
    /* === FIN: _layout.css === */


    /* === INICIO: _login.css === */
    /* PARTIAL: _login.css */

    #login-screen-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 20px;
    }

    .login-container {
        display: grid;
        grid-template-columns: 1fr 1.3fr;
        max-width: 950px;
        width: 100%;
        min-height: 650px;
        background: var(--bg-glass);
        border: 1px solid var(--border-glass);
        border-radius: var(--radius-lg);
        box-shadow: 0 8px 60px rgba(0,0,0,0.4);
        backdrop-filter: blur(var(--backdrop-blur));
        overflow: hidden;
    }

    .branding-section {
        padding: 40px;
        background: rgba(0,0,0,0.2);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        text-align: center;
        border-right: 1px solid var(--border-glass);
    }

    .branding-footer p {
        font-size: 0.8rem;
        color: var(--text-secondary);
    }

    .form-section {
        padding: 40px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .logo-container { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .logo { width: 100px; object-fit: contain; margin-bottom: 20px; filter: drop-shadow(0 0 15px var(--glow-cyan)); }
    .app-title { font-size: 2.8rem; font-weight: 700; color: var(--text-headings); }
    .app-subtitle { color: var(--primary-cyan); font-weight: 500; }

    .form-container { width: 100%; }
    .form-header { margin-bottom: 30px; }
    .form-title { font-size: 2rem; color: var(--text-headings); }
    .form-subtitle { color: var(--text-secondary); }

    .divider {
        text-align: center;
        color: var(--text-secondary);
        margin: 25px 0;
        position: relative;
        font-size: 0.9rem;
    }
    .divider::before, .divider::after {
        content: '';
        position: absolute;
        top: 50%;
        width: 40%;
        height: 1px;
        background: var(--border-glass);
    }
    .divider::before { left: 0; }
    .divider::after { right: 0; }

    @media (max-width: 992px) {
        .login-container { grid-template-columns: 1fr; max-width: 500px; }
        .branding-section { display: none; }
    }




    /* === INICIO: _modals.css === */
    /* PARTIAL: _modals.css */

    .modal {
        position: fixed;
        left: 0; top: 0; width: 100%; height: 100%;
        display: none; justify-content: center; align-items: center;
        padding: 20px;
        z-index: 2000; /* Z-index base para todos los modales */
    }

    #alertModal, #confirmModal, #promptModal, .bc-modal {
        z-index: 3000; /* Z-index superior para modales de sistema */
    }

    .modal-backdrop {
        position: absolute; width: 100%; height: 100%;
        background-color: rgba(10, 14, 26, 0.7);
    }

    .modal-content {
        position: relative;
        background: var(--bg-glass);
        border: 1px solid var(--border-glass);
        border-radius: var(--radius-md);
        box-shadow: 0 8px 60px rgba(0,0,0,0.4);
        backdrop-filter: blur(var(--backdrop-blur));
        padding: 30px;
        width: 90%;
        max-width: 500px;
        display: flex;
        flex-direction: column;
        max-height: 90vh;
        animation: modal-fade-in 0.4s var(--transition-slow);
    }
    @keyframes modal-fade-in {
        from { opacity: 0; transform: scale(0.9) translateY(20px); }
        to { opacity: 1; transform: scale(1) translateY(0); }
    }

    .modal-content .close {
        position: absolute; top: 10px; right: 10px;
        width: 30px; height: 30px;
        display: flex; justify-content: center; align-items: center;
        background: transparent;
        border-radius: 50%;
        color: var(--text-secondary);
        font-size: 28px;
        cursor: pointer;
        transition: var(--transition-fast);
        z-index: 1;
    }

    .modal-content .close:hover {
        background-color: var(--border-highlight);
        color: var(--text-primary);
        transform: rotate(90deg);
    }

    .modal-scrollable-content {
        overflow-y: auto;
        flex-grow: 1;
        min-height: 0;
        padding-right: 10px;
        margin-right: -10px;
        scrollbar-width: thin;
        scrollbar-color: var(--primary-cyan) transparent;
    }
    .modal-scrollable-content::-webkit-scrollbar { width: 8px; }
    .modal-scrollable-content::-webkit-scrollbar-track { background: transparent; }
    .modal-scrollable-content::-webkit-scrollbar-thumb {
        background-color: var(--primary-cyan);
        border-radius: 4px;
    }

    .modal-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 15px;
        text-shadow: 0 0 10px var(--glow-cyan);
    }
    .alert-title { color: var(--warning-color); }
    .confirm-title { color: var(--primary-cyan); }
    .prompt-title { color: var(--primary-magenta); }

    .modal-message {
        margin-bottom: 25px;
        line-height: 1.6;
        color: var(--text-primary);
    }

    .modal-actions {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
        margin-top: 10px;
    }

    #loadingOverlay {
        position: fixed; top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(10, 14, 26, 0.8);
        backdrop-filter: blur(5px);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        flex-direction: column;
        gap: 20px;
        color: var(--text-primary);
    }
    #loadingOverlay::before {
        content: '';
        width: 60px; height: 60px;
        border: 5px solid var(--border-highlight);
        border-top-color: var(--primary-cyan);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 480px) {
        .modal-content { padding: 20px; width: 95%; }
    }
    /* === FIN: _modals.css === */


    /* === INICIO: _table.css === */
    /* PARTIAL: _table.css */

    .responsive-table-wrapper {
        background: var(--bg-glass);
        border: 1px solid var(--border-glass);
        border-radius: var(--radius-md);
        padding: 10px;
        overflow-x: auto;
        margin-bottom: 24px;
    }

    .responsive-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        min-width: 1200px;
    }

    .responsive-table thead {
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .responsive-table thead th {
        background: var(--bg-primary);
        color: var(--text-secondary);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 0.8rem;
        padding: 14px 10px;
        text-align: center;
        border-bottom: 2px solid var(--border-highlight);
    }
    .responsive-table thead th:first-child { border-top-left-radius: var(--radius-sm); }
    .responsive-table thead th:last-child { border-top-right-radius: var(--radius-sm); }
    .responsive-table thead th:nth-child(2) {
        text-align: left;
    }

    .responsive-table tbody td {
        padding: 12px 10px;
        vertical-align: middle;
        border-bottom: 1px solid var(--border-glass);
        text-align: center;
        position: relative;
    }

    .responsive-table tbody td:not(:first-child)::before {
        content: '';
        position: absolute;
        left: 0;
        top: 20%;
        height: 60%;
        width: 1px;
        background-color: var(--border-glass);
    }

    .responsive-table tbody td:nth-child(2) {
        text-align: left;
    }
    .responsive-table td input {
        width: 100%;
        min-width: 60px;
        background: transparent;
        border: 1px solid transparent;
        border-radius: var(--radius-sm);
        color: var(--text-primary);
        padding: 6px;
        transition: var(--transition-fast);
        font-family: var(--font-main);
        text-align: center;
        font-size: 16px;
    }
    .responsive-table td:nth-child(2) input {
        text-align: left;
    }

    .responsive-table td input:focus {
        outline: none;
        background: var(--bg-primary);
        border-color: var(--primary-cyan);
        box-shadow: 0 0 10px var(--glow-cyan);
    }
    .delete-button {
        background: transparent;
        border: none;
        color: var(--danger-color);
        cursor: pointer;
        font-size: 1.2rem;
        padding: 5px;
        transition: var(--transition-fast);
    }
    .delete-button:hover {
        color: #fff;
        text-shadow: 0 0 10px var(--glow-danger);
        transform: scale(1.2);
    }

    #product-list tr:not(.category-row):hover {
        background-color: var(--border-highlight);
    }

    .category-row {
        background: var(--bg-primary);
        font-weight: 600;
        cursor: pointer;
        color: var(--primary-cyan);
    }
    .category-row td {
        text-align: left !important;
    }
    .category-row td::before {
        display: none;
    }

    .toggle-icon {
        display: inline-block;
        width: 1.2em;
        transition: transform var(--transition-fast);
    }

    .responsive-table th:first-child,
    .responsive-table td:first-child {
        width: 1%;
        padding-left: 8px;
        padding-right: 8px;
        text-align: center;
    }

    .fila-error { background-color: rgba(255, 61, 113, 0.15) !important; }
    .fila-stock-cero { color: var(--text-secondary); opacity: 0.8; }

    #total-products-count {
        color: var(--text-secondary);
        font-size: 0.8em;
        font-weight: 600;
        margin-left: 8px;
    }
    #zero-stock-count {
        color: var(--warning-color);
        font-size: 0.8em;
        font-weight: 600;
        margin-left: 4px;
    }


    @media (max-width: 768px) {
        .responsive-table-wrapper {
            padding: 5px;
        }
        .responsive-table {
            min-width: 0;
        }
        .responsive-table thead th,
        .responsive-table tbody td {
            padding: 10px 4px;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .responsive-table thead th:first-child,
        .responsive-table tbody tr:not(.category-row) td:first-child {
            display: none;
        }

        .responsive-table th:nth-child(2),
        .responsive-table td:nth-child(2) {
            width: 35%;
            white-space: normal;
            padding-left: 10px;
        }

        .responsive-table td input[type="number"] {
            padding: 4px 2px;
            font-size: 0.85rem;
            min-width: 50px;
        }
        .category-row td {
            padding-left: 10px !important;
        }
    }
    /* === FIN: _table.css === */


    /* === INICIO: _components.css === */
    /* PARTIAL: _components.css */

    .btn {
        width: 100%;
        padding: 12px;
        border-radius: var(--radius-sm);
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: all var(--transition-fast);
        border: 1px solid transparent;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .btn-primary {
        background-image: linear-gradient(135deg, var(--primary-cyan) 0%, var(--primary-magenta) 100%);
        color: var(--bg-dark);
        border: none;
    }

    .btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .btn-primary:hover {
        box-shadow: 0 4px 20px var(--glow-cyan);
    }

    .btn:active {
        transform: translateY(-1px);
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    .form-group { margin-bottom: 20px; }
    .form-label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); }

    .form-input, #businessSelect {
        width: 100%;
        padding: 12px 15px;
        background: var(--bg-primary);
        border: 1px solid var(--border-glass);
        border-radius: var(--radius-sm);
        color: var(--text-primary);
        font-size: 1rem;
        transition: var(--transition-fast);
    }

    #businessSelect option { background: var(--bg-primary); color: var(--text-primary); }

    .input-with-icon {
      position: relative;
    }

    .input-with-icon .input-icon {
      position: absolute;
      left: 0.875rem;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      align-items: center;
      justify-content: center;
      width: 1.25rem;
      height: 1.25rem;
      font-size: 1.1rem;
      color: var(--text-secondary);
      pointer-events: none;
    }

    .input-with-icon .form-input {
      padding-left: calc(0.875rem + 1.25rem + 0.75rem);
    }

    /* Ajuste para pantallas pequeñas */
    @media (max-width: 576px) {
      .input-with-icon .input-icon {
        left: 0.75rem;
        font-size: 1.1rem;
        transform: translateY(-50%);
      }
      .input-with-icon .form-input {
        padding-left: calc(0.75rem + 1.25rem + 0.6rem);
      }
    }




    #loginModal .input-with-icon .form-input { padding-left: 45px; }

    .form-input:focus, #businessSelect:focus {
        outline: none;
        border-color: var(--primary-cyan);
        box-shadow: 0 0 15px var(--glow-cyan);
    }

    .form-footer { margin-top: 20px; text-align: center; }
    .form-switch { font-size: 0.9rem; color: var(--text-secondary); }
    .form-switch a { color: var(--primary-cyan); text-decoration: none; font-weight: 500; }
    .form-switch a:hover { text-decoration: underline; text-shadow: 0 0 5px var(--glow-cyan); }

    .modal-content form { display: flex; flex-direction: column; gap: 10px; }
    .modal-content form label { font-size: 0.9rem; color: var(--text-secondary); margin-top: 5px; }
    .modal-content input, .modal-content select, .modal-content textarea {
        width: 100%;
        padding: 12px 15px;
        margin: 0;
        box-sizing: border-box;
        background: var(--bg-primary);
        border: 1px solid var(--border-glass);
        border-radius: var(--radius-sm);
        color: var(--text-primary);
        font-size: 1rem;
        transition: var(--transition-fast);
        font-family: var(--font-main);
    }

    .modal-content input:focus, .modal-content select:focus, .modal-content textarea:focus {
        outline: none;
        border-color: var(--primary-cyan);
        box-shadow: 0 0 15px var(--glow-cyan);
    }

    .modal-content select option { background: var(--bg-primary); }

    .modal-content form button {
        width: 100%;
        padding: 12px;
        margin-top: 10px;
        border-radius: var(--radius-sm);
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: all var(--transition-fast);
        border: 1px solid transparent;
        text-transform: uppercase; letter-spacing: 1px;
        background-image: linear-gradient(135deg, var(--primary-cyan) 0%, var(--primary-magenta) 100%);
        color: var(--bg-dark);
    }

    .modal-content form button:hover {
        box-shadow: 0 2px 20px var(--glow-cyan);
        transform: translateY(-2px);
    }

    .button-container {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-bottom: 24px;
        padding: 15px;
        background: var(--bg-glass);
        border-radius: var(--radius-md);
        border: 1px solid var(--border-glass);
    }

    .button-container button {
        display: flex; align-items: center; gap: 8px;
        padding: 10px 18px;
        background: var(--bg-primary);
        border: 1px solid var(--border-glass);
        color: var(--text-secondary);
        border-radius: var(--radius-sm);
        font-weight: 500;
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .button-container button:hover {
        color: var(--primary-cyan);
        background-color: var(--border-highlight);
        border-color: var(--primary-cyan);
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }

    .button-container button.active {
        color: var(--primary-cyan);
        background-color: var(--border-highlight);
        border-color: var(--primary-cyan);
        box-shadow: 0 0 10px var(--glow-cyan);
    }

    .button-container button:active {
        transform: translateY(0);
    }

    .button-container button[data-action="deleteSelectedBtn"]:hover { color: var(--danger-color); border-color: var(--danger-color); }
    .button-container button[data-action="addProductBtn"]:hover { color: var(--success-color); border-color: var(--success-color); }
    .button-container button[data-action="toggleAllBtn"]:hover, .button-container button[data-action="showZeroStockBtn"]:hover, .button-container button[data-action="openCalculatorBtn"]:hover, .button-container button[data-action="openBillCounterBtn"]:hover {
        color: var(--primary-cyan); border-color: var(--primary-cyan);
    }

    .section-box {
        background: var(--bg-glass);
        border: 1px solid var(--border-glass);
        border-radius: var(--radius-md);
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    .section-box h2 {
        color: var(--text-headings);
        font-size: 1.4rem;
        margin-top: 0;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--border-glass);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .gastos-list .gasto-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--bg-primary);
        padding: 10px 15px;
        border-radius: var(--radius-sm);
        margin-bottom: 8px;
        border-left: 3px solid var(--primary-magenta);
    }
    .gasto-tag {
        font-size: 0.75rem;
        font-weight: 600;
        padding: 2px 8px;
        border-radius: 10px;
        margin-left: 10px;
        text-transform: uppercase;
    }
    .gasto-type--gasto {
        background-color: rgba(255, 61, 113, 0.2);
        color: var(--danger-color);
    }
    .gasto-type--recogida {
        background-color: rgba(136, 173, 255, 0.2);
        color: var(--text-secondary);
    }

    .add-gasto-button {
        width: 100%;
        padding: 12px;
        margin-top: 15px;
        background: transparent;
        border: 1px dashed var(--border-highlight);
        color: var(--text-secondary);
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: var(--transition-fast);
        font-family: var(--font-main);
        font-weight: 500;
    }
    .add-gasto-button:hover {
        background-color: var(--border-highlight);
        color: var(--text-primary);
        border-style: solid;
    }

    #notas-dia {
        width: 100%; min-height: 120px;
        background: var(--bg-primary);
        border: 1px solid var(--border-glass);
        border-radius: var(--radius-sm);
        color: var(--text-primary);
        padding: 12px;
        font-family: var(--font-main);
        font-size: 16px;
    }
    #notas-dia:focus {
        outline: none;
        border-color: var(--primary-magenta);
        box-shadow: 0 0 15px var(--glow-magenta);
    }

    .totals-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 15px;
    }
    .totals-grid p {
        background: var(--bg-primary);
        padding: 12px 15px;
        border-radius: var(--radius-sm);
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.95rem;
    }
    .totals-grid strong {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--primary-cyan);
        text-shadow: 0 0 5px var(--glow-cyan);
    }
    .totals-grid hr {
        grid-column: 1 / -1;
        border: none;
        height: 1px;
        background-color: var(--border-glass);
        margin: 5px 0;
    }

    .predefined-notes-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
    }
    .predefined-note-item { display: flex; flex-direction: column; gap: 8px; }
    .predefined-note-item label { font-size: 0.9rem; color: var(--text-secondary); }
    .predefined-note-item input, .predefined-note-item select {
        background: var(--bg-primary); border: 1px solid var(--border-glass); padding: 8px 10px; border-radius: var(--radius-sm); color: var(--text-primary); font-size: 16px;
    }
    .predefined-note-item .note-input-group { display: flex; gap: 8px; }
    .predefined-note-item input[type="number"] { -moz-appearance: textfield; }
    #note-diferencia-monto:disabled { background: rgba(0,0,0,0.3); opacity: 0.5; cursor: not-allowed; }

    .admin-toggle-btn {
        padding: 6px 12px;
        background: var(--bg-primary);
        border: 1px solid var(--text-secondary);
        border-radius: var(--radius-sm);
        color: var(--text-secondary);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition-fast);
        position: relative;
        user-select: none;
    }
    .admin-toggle-btn.admin-active {
        background: var(--success-color);
        color: var(--bg-dark);
        border-color: var(--success-color);
        animation: pulse-admin 2s infinite;
    }

    #menu-admin-btn { display: none; }

    .header.admin-mode-active {
        box-shadow: 0 0 20px var(--glow-success);
    }
    @keyframes pulse-admin {
        0% { box-shadow: 0 0 0 0 var(--glow-success); }
        70% { box-shadow: 0 0 0 10px rgba(0, 255, 149, 0); }
        100% { box-shadow: 0 0 0 0 rgba(0, 255, 149, 0); }
    }

    .custom-select-wrapper { position: relative; }
    #worker-display.header-button { display: block; width: 100%; position: relative; }
    .custom-select-wrapper::after {
        content: '▼';
        position: absolute;
        right: 15px; top: 50%;
        transform: translateY(-50%);
        font-size: 0.8rem;
        color: var(--text-secondary);
        pointer-events: none;
    }
    .custom-select {
        position: absolute;
        top: 0; left: 0;
        width: 100%; height: 100%;
        opacity: 0;
        cursor: pointer;
    }

    .filter-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 20px;
    }
    .filter-buttons button, .btn-modal-action {
        padding: 8px 15px;
        border-radius: var(--radius-sm);
        background: var(--bg-primary);
        border: 1px solid var(--border-glass);
        color: var(--text-secondary);
        font-family: var(--font-main);
        font-size: 0.9rem;
        cursor: pointer;
        transition: var(--transition-fast);
    }
    .filter-buttons button:hover, .btn-modal-action:hover {
        color: var(--primary-cyan);
        background-color: var(--border-highlight);
        border-color: var(--primary-cyan);
        box-shadow: 0 0 10px var(--glow-cyan);
    }

    .btn-modal-action {
        background-image: linear-gradient(135deg, var(--primary-cyan) 0%, var(--primary-magenta) 100%);
        color: var(--bg-dark);
        border: none;
        font-weight: 600;
    }

    .modal-form-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
        margin-bottom: 15px;
    }
    .modal-form-group label {
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    .summary-card {
        background: var(--bg-primary);
        padding: 15px;
        border-radius: var(--radius-sm);
        margin-bottom: 10px;
        border-left: 3px solid var(--primary-cyan);
    }
    .summary-card h4 {
        color: var(--text-secondary);
        margin-top: 0;
        margin-bottom: 5px;
        font-size: 0.9rem;
    }

    .btn-modal {
        padding: 10px 20px;
        border-radius: var(--radius-sm);
        font-weight: 600;
        cursor: pointer;
        transition: all var(--transition-fast);
        border: 1px solid transparent;
        font-size: 0.9rem;
    }

    .btn-modal.btn-primary {
        background-image: linear-gradient(135deg, var(--primary-cyan) 0%, var(--primary-magenta) 100%);
        color: var(--bg-dark);
    }
    .btn-modal.btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px var(--glow-cyan);
    }

    .btn-modal.btn-secondary {
        background: transparent;
        border: 1px solid var(--border-highlight);
        color: var(--text-secondary);
    }
    .btn-modal.btn-secondary:hover {
        background: var(--border-highlight);
        color: var(--text-primary);
        border-color: var(--text-secondary);
    }

    .header-menu .header-button {
        display: block;
        width: 100%;
        text-align: left;
        background: rgba(0,0,0,0.2);
        border: 1px solid var(--border-glass);
        border-radius: var(--radius-sm);
        color: var(--text-primary);
        padding: 10px 15px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all var(--transition-fast);
        font-family: var(--font-main);
        font-size: 0.95rem;
    }

    .header-menu .header-button:hover {
        background: var(--border-highlight);
        color: var(--primary-cyan);
        transform: translateX(5px);
        border-color: var(--primary-cyan);
    }

    .header-menu .header-button:active { transform: translateX(5px) scale(0.98); }

    .session-controls { display: flex; flex-direction: column; gap: 8px; }

    #sync-status { display: flex; align-items: center; gap: 10px; }
    #sync-indicator {
        width: 12px; height: 12px;
        border-radius: 50%;
        transition: background-color 0.3s, box-shadow 0.3s;
    }

    #syncButton {
        flex-grow: 1;
        background-image: linear-gradient(135deg, var(--primary-cyan) 0%, var(--primary-magenta) 100%);
        color: var(--bg-dark);
        font-weight: 600;
        border: none;
    }

    #syncButton:hover {
        color: var(--bg-dark);
        transform: none;
        box-shadow: 0 0 15px var(--glow-cyan), 0 0 25px var(--glow-magenta);
    }

    @media (max-width: 768px) {
        #menu-admin-btn {
            display: block;
        }
        .button-container button[data-action="deleteSelectedBtn"] {
            display: none;
        }
    }
    @media (max-width: 600px) {
        .button-container button span { display: none; }
        .button-container button { padding: 12px; }
        .totals-grid { grid-template-columns: 1fr; }
    }



    /* === FIN: _components.css === */


    /* === INICIO: _calculators.css === */
    /* PARTIAL: _calculators.css */

    #calculatorModal .modal-content { padding: 0; max-width: 320px; background: var(--bg-primary); }
    #calculatorModal .calculator-display { padding: 30px 20px; text-align: right; word-wrap: break-word; }
    #calculatorModal #calcPrevious { color: var(--text-secondary); font-size: 1.2rem; min-height: 1.5rem;}
    #calculatorModal #calcCurrent { font-size: 2.5rem; color: var(--text-headings); min-height: 3rem;}
    #calculatorModal .calculator-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1px; background: var(--border-glass); }
    #calculatorModal .calculator-grid button {
        padding: 20px; font-size: 1.5rem; border: none;
        background: var(--bg-glass);
        color: var(--text-primary); cursor: pointer; transition: var(--transition-fast);
    }
    #calculatorModal .calculator-grid button:hover { background: var(--border-highlight); }
    #calculatorModal .calculator-grid button:active { transform: scale(0.95); }
    #calculatorModal .calculator-grid .span-two { grid-column: span 2; }
    #calculatorModal .calculator-grid .operator { color: var(--primary-cyan); }
    #calculatorModal .calculator-grid .special { color: var(--danger-color); }
    #calculatorModal .calculator-grid .equals {
        background-image: linear-gradient(135deg, var(--primary-cyan), var(--primary-magenta));
        color: var(--bg-dark);
    }

    #pizza-calculator-section {
        padding: 0;
    }
    #pizza-calculator-section summary {
        list-style: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        padding: 24px;
        transition: background-color var(--transition-fast);
        border-radius: var(--radius-md);
    }
    #pizza-calculator-section summary::-webkit-details-marker {
        display: none;
    }
    #pizza-calculator-section[open] > summary {
        border-bottom: 1px solid var(--border-glass);
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
    }
    #pizza-calculator-section summary:hover {
        background-color: var(--border-highlight);
    }
    #pizza-calculator-section summary h2 {
        margin: 0;
        padding: 0;
        border: none;
    }
    .summary-chevron {
        border-style: solid;
        border-color: var(--text-secondary);
        border-width: 0 2px 2px 0;
        display: inline-block;
        padding: 4px;
        transform: rotate(45deg);
        transition: transform 0.3s ease-out;
    }
    details[open] > summary .summary-chevron {
        transform: rotate(-135deg);
        margin-top: -5px;
    }
    .pizza-calculator-content {
        padding: 24px;
    }
    .pizza-panel {
        background: var(--bg-primary); padding: 20px;
        border-radius: var(--radius-md); margin-bottom: 20px;
        border: 1px solid var(--border-glass);
    }
    .pizza-panel h3 { font-size: 1rem; color: var(--text-secondary); margin-bottom: 15px; }
    .pizza-panel .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; }
    .pizza-panel .form-group { display: flex; flex-direction: column; gap: 8px; }
    .pizza-panel label { font-size: 0.8rem; color: var(--text-secondary); }
    .pizza-panel input[type="number"] { padding: 8px; background: var(--bg-dark); color: var(--text-primary); -moz-appearance: textfield; font-size: 16px; border: 1px solid var(--border-glass);}
    .pizza-panel input[type="number"]::-webkit-outer-spin-button, .pizza-panel input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .pizza-panel .btn { padding: 10px 15px; font-size: 0.9rem; }
    .pizza-panel .btn-primary { background-image: linear-gradient(135deg, var(--primary-cyan), #67c6d6); color: var(--bg-dark); border: none; }
    .pizza-panel .btn-danger { background-image: linear-gradient(135deg, var(--danger-color), #f87171); color: var(--bg-dark); border: none; }
    .pizza-panel .btn-secondary { background-image: linear-gradient(135deg, #6b7280, #4b5563); color: var(--text-primary); border: none; }
    .pizza-panel .toggle-button {
        width: 100%; display: flex; justify-content: space-between; align-items: center;
        background: var(--bg-glass); border: 1px solid var(--border-glass);
        color: var(--text-primary); transition: var(--transition-fast);
    }
    .pizza-panel .toggle-button svg { transition: transform var(--transition-fast); }
    #pizza-calculator-section .toggle-button.active svg { transform: rotate(180deg); }
    .pizza-panel .optional-content { padding-top: 20px; border-top: 1px solid var(--border-glass); margin-top: 15px; }
    #pizza-results-container { display: flex; flex-direction: column; gap: 15px; }
    #pizza-results-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
    .pizza-panel .result-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
    .pizza-panel .total-box {
        padding: 15px; border-radius: var(--radius-sm);
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        text-align: center;
    }
    .pizza-panel .total-box h3, .pizza-panel .total-box h4, .pizza-panel .total-box h5 {
        font-size: 0.9rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;
    }
    .pizza-panel .total-box p { font-size: 1.6rem; font-weight: 700; color: var(--text-headings); line-height: 1.2; }
    .pizza-panel .expense { background: rgba(255, 61, 113, 0.1); border-left: 3px solid var(--danger-color); }
    .pizza-panel .income { background: rgba(0, 255, 149, 0.1); border-left: 3px solid var(--success-color); }
    .pizza-panel .balance { background: rgba(0, 224, 255, 0.1); border-left: 3px solid var(--primary-cyan); }
    .pizza-panel .info { background: rgba(136, 173, 255, 0.1); border-left: 3px solid var(--text-secondary); }
    .pizza-panel .small h3, .pizza-panel .small h5 { font-size: 0.8rem; }
    .pizza-panel .small p { font-size: 1.1rem; }
    #pizza-total-gastos { flex-direction: row; justify-content: space-between; align-items: center; }
    .pizza-panel .hint-text { text-align: center; color: var(--text-secondary); padding: 20px; }
    .pizza-panel .result-divider { border: none; height: 1px; background-color: var(--border-glass); margin: 20px 0; }
    #pizza-calculator-section summary {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 15px;
    }

    #pizza-calculator-section summary h2 {
        flex-shrink: 0;
    }

    .pizza-summary-preview {
        display: flex;
        gap: 12px;
        margin-left: auto;
        flex-wrap: nowrap;
    }

    .summary-preview-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 4px 12px;
        border-radius: var(--radius-sm);
        background-color: var(--bg-primary);
        border-top: 2px solid;
        min-width: 100px;
        text-align: center;
    }

    .summary-preview-item span {
        font-size: 0.7rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .summary-preview-item strong {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-headings);
        line-height: 1.2;
    }

    .summary-preview-item.income { border-color: var(--success-color); }
    .summary-preview-item.income strong { color: var(--success-color); }

    .summary-preview-item.balance { border-color: var(--primary-cyan); }
    .summary-preview-item.balance strong { color: var(--primary-cyan); }

    .summary-preview-item.expense { border-color: var(--danger-color); }
    .summary-preview-item.expense strong { color: var(--danger-color); }

    #billCounterModal .modal-content {
        max-width: 450px;
        padding: 0;
        overflow: hidden;
        background: var(--bg-primary);
    }
    #billCounterModal .bc-header {
        padding: 15px 20px;
        background: var(--bg-dark);
        border-bottom: 1px solid var(--border-glass);
    }
    #billCounterModal .bc-header-totals {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px 15px;
        margin-bottom: 15px;
        text-align: center;
        font-size: 0.9rem;
    }
    #billCounterModal #bc_total { color: var(--success-color); font-weight: 600; }
    #billCounterModal #bc_inactiveTotal { color: var(--warning-color); font-weight: 600; }
    #billCounterModal #bc_grandTotal {
        grid-column: 1 / -1;
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-cyan);
        margin-top: 5px;
        padding-top: 10px;
        border-top: 1px solid var(--border-glass);
        text-shadow: 0 0 8px var(--glow-cyan);
    }
    #billCounterModal .bc-header-buttons { display: flex; gap: 10px; }
    #billCounterModal .bc-header-buttons .header-btn {
        flex-grow: 1;
        padding: 8px 12px;
        font-size: 0.85rem;
        font-weight: 600;
        border-radius: var(--radius-sm);
        background: var(--bg-glass);
        border: 1px solid var(--border-glass);
        color: var(--text-secondary);
        cursor: pointer;
        transition: var(--transition-fast);
    }
    #billCounterModal .bc-header-buttons .header-btn:hover { background: var(--border-highlight); color: var(--text-primary); }

    #billCounterModal .bc-body-scrollable {
        padding: 20px;
        display: grid;
        grid-template-columns: 1fr; /* Siempre una columna */
        gap: 12px;
    }
    #billCounterModal .bill-row {
        display: grid;
        grid-template-columns: 60px 1fr 90px auto;
        align-items: center;
        gap: 15px;
        padding: 10px 15px;
        background: var(--bg-dark);
        border-radius: var(--radius-sm);
        border: 1px solid var(--border-glass);
        transition: var(--transition-fast);
    }
    #billCounterModal .bill-row:hover { transform: translateY(-2px); border-color: var(--primary-cyan); box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
    #billCounterModal .bill-row.inactive { opacity: 0.5; background: #222; }

    #billCounterModal .bill-row label {
        font-weight: 600;
        font-size: 1rem;
        color: var(--primary-cyan);
        justify-self: start;
    }
    #billCounterModal .bill-row input[type="number"] {
        padding: 8px;
        font-size: 1.1rem;
        text-align: center;
        background: var(--bg-primary);
        border: 1px solid var(--border-glass);
        color: var(--text-primary);
        -moz-appearance: textfield;
    }
    #billCounterModal .individual-total {
        font-size: 0.9rem;
        color: var(--text-secondary);
        text-align: right;
        font-family: var(--font-mono);
    }
    #billCounterModal .bill-toggle {
        appearance: none;
        justify-self: center;
        width: 22px; height: 22px;
        border: 2px solid var(--border-highlight);
        border-radius: 4px;
        cursor: pointer;
        transition: 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    #billCounterModal .bill-toggle:checked {
        background-color: var(--primary-cyan);
        border-color: var(--primary-cyan);
    }
    #billCounterModal .bill-toggle:checked::after {
        content: '✓';
        color: var(--bg-dark);
        font-size: 1rem;
        font-weight: bold;
    }

    @media (max-width: 768px) {
        #pizza-calculator-section summary {
            flex-wrap: wrap;
            gap: 10px;
        }
        .pizza-summary-preview {
            width: 100%;
            margin-top: 10px;
            margin-left: 0;
            justify-content: center;
        }
        .summary-preview-item {
            flex-grow: 1;
            min-width: 90px;
            padding: 4px 8px;
        }
        .summary-preview-item span {
            font-size: 0.65rem;
        }
        .summary-preview-item strong {
            font-size: 0.9rem;
        }
    }
    /* === FIN: _calculators.css === */


    /* === INICIO: _promo-themes.css === */
    /* PARTIAL: _promo-themes.css */

    @keyframes promo-fade-in {
        from { opacity: 0; transform: translateY(-30px) scale(0.95); }
        to { opacity: 1; transform: translateY(0) scale(1); }
    }

    #alertModal[class*="promo-modal-"] .modal-content {
        animation: promo-fade-in 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        box-shadow: 0 10px 50px rgba(0,0,0,0.5);
        max-width: 550px;
        padding: 40px;
        text-align: center;
        position: relative;
        overflow: hidden;
    }
    #alertModal[class*="promo-modal-"] .modal-title {
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 20px;
        line-height: 1.2;
    }
    #alertModal[class*="promo-modal-"] .modal-message {
        font-size: 1.1rem;
        line-height: 1.7;
        margin-bottom: 30px;
    }
    #alertModal[class*="promo-modal-"] #alertOkButton {
        padding: 12px 25px;
        font-size: 1rem;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        border-radius: var(--radius-sm);
        border: none;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    #alertModal[class*="promo-modal-"] #alertOkButton:hover {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 8px 25px rgba(0,0,0,0.4);
    }

    /* Set 1: Original */
    .promo-modal-gold-rush .modal-content { background: linear-gradient(145deg, #2c2513, #4a3f21), url('https://www.transparenttextures.com/patterns/black-felt.png'); border: 2px double #c9b037; border-radius: var(--radius-sm); }
    .promo-modal-gold-rush .modal-title { font-family: var(--font-serif); color: #ffd700; text-shadow: 0 2px 3px #000; }
    .promo-modal-gold-rush .modal-message { color: #f0e6d2; }
    .promo-modal-gold-rush #alertOkButton { background: linear-gradient(to right, #c9b037, #ffd700); color: #2b2b2b; font-weight: bold; }

    .promo-modal-cyber-neon .modal-content { background: #0a0e1a; border: 2px solid var(--primary-cyan); border-radius: 0; box-shadow: 0 0 40px var(--glow-cyan), inset 0 0 20px rgba(225, 0, 255, 0.3); }
    .promo-modal-cyber-neon .modal-title { color: var(--primary-magenta); text-shadow: 0 0 15px var(--glow-magenta); font-family: var(--font-mono); }
    .promo-modal-cyber-neon .modal-message { font-family: var(--font-mono); color: var(--text-primary); }
    .promo-modal-cyber-neon #alertOkButton { background: var(--primary-cyan); color: var(--bg-dark); border-radius: 0; font-weight: bold; }

    .promo-modal-velvet-lounge .modal-content { background: linear-gradient(to bottom right, #4c0000, #1c0000); border: 1px solid #a02c2c; border-radius: 25px; }
    .promo-modal-velvet-lounge .modal-title { font-family: var(--font-serif); color: #ffcdd2; text-shadow: 1px 1px 5px #000; }
    .promo-modal-velvet-lounge .modal-message { color: #f5e6e8; }
    .promo-modal-velvet-lounge #alertOkButton { background: #8c2a2a; color: #fff; border-radius: 50px; }

    .promo-modal-galaxy-dream .modal-content { background: #000010 url('https://www.transparenttextures.com/patterns/stardust.png'); border: 2px solid #7c4dff; border-radius: 50% 10px; }
    .promo-modal-galaxy-dream .modal-title { color: #bb86fc; text-shadow: 0 0 20px #bb86fc; }
    .promo-modal-galaxy-dream .modal-message { color: #e3e4fa; }
    .promo-modal-galaxy-dream #alertOkButton { background: linear-gradient(45deg, #7c4dff, #bb86fc); color: #fff; border-radius: 8px; }

    .promo-modal-emerald-envy .modal-content { background: linear-gradient(135deg, #0f3433, #0c2b2a); border: none; border-left: 8px solid #4db6ac; border-radius: var(--radius-sm); text-align: left; }
    .promo-modal-emerald-envy .modal-title { color: #80cbc4; text-transform: uppercase; }
    .promo-modal-emerald-envy .modal-message { color: #e0f2f1; }
    .promo-modal-emerald-envy #alertOkButton { background: #26a69a; color: #004d40; font-weight: bold; }

    .promo-modal-arctic-ice .modal-content { background: #f8fdff; border: 2px solid #90caf9; border-radius: 0; }
    .promo-modal-arctic-ice .modal-title { color: #1976d2; }
    .promo-modal-arctic-ice .modal-message { color: #0d47a1; }
    .promo-modal-arctic-ice #alertOkButton { background: #42a5f5; color: #fff; }

    .promo-modal-fire-and-fury .modal-content { background: radial-gradient(circle, #430c0c, #1e0505); border: 2px solid #ff7043; text-transform: uppercase; }
    .promo-modal-fire-and-fury .modal-title { color: #ffa726; text-shadow: 0 0 10px #ff5722; animation: flicker 1.5s infinite alternate; }
    @keyframes flicker { 0%, 18%, 22%, 25%, 53%, 57%, 100% { text-shadow: 0 0 4px #fff, 0 0 11px #ff5722, 0 0 19px #ff5722; } 20%, 24%, 55% { text-shadow: none; } }
    .promo-modal-fire-and-fury .modal-message { color: #ffecb3; }
    .promo-modal-fire-and-fury #alertOkButton { background: linear-gradient(to right, #ff7043, #ff5722); color: #fff; }

    .promo-modal-ocean-depths .modal-content { background: linear-gradient(160deg, #001f3f, #003366); border: 1px solid #03a9f4; border-radius: 30px; }
    .promo-modal-ocean-depths .modal-content::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, transparent, rgba(3, 169, 244, 0.5), transparent); }
    .promo-modal-ocean-depths .modal-title { color: #4fc3f7; }
    .promo-modal-ocean-depths .modal-message { color: #b3e5fc; }
    .promo-modal-ocean-depths #alertOkButton { background: #039be5; color: #fff; border-radius: 30px; }

    .promo-modal-royal-purple .modal-content { background: linear-gradient(to bottom left, #311b92, #4527a0); border: 1px solid #b39ddb; border-radius: var(--radius-md); }
    .promo-modal-royal-purple .modal-title { font-family: var(--font-serif); color: #d1c4e9; border-bottom: 2px solid #9575cd; display: inline-block; padding-bottom: 5px; }
    .promo-modal-royal-purple .modal-message { color: #ede7f6; }
    .promo-modal-royal-purple #alertOkButton { background: #7e57c2; color: #fff; box-shadow: 0 0 15px rgba(126, 87, 194, 0.5); }

    .promo-modal-monochrome-matrix .modal-content { background: #111; border: 1px solid #333; border-radius: 0; font-family: var(--font-mono); text-shadow: 0 0 8px #00ff00; }
    .promo-modal-monochrome-matrix .modal-title { color: #fff; text-transform: uppercase; }
    .promo-modal-monochrome-matrix .modal-message { color: #00ff00; }
    .promo-modal-monochrome-matrix #alertOkButton { background: #00ff00; color: #000; font-weight: bold; border-radius: 0; }

    /* Set 2: Avanzado y Creativo */
    .promo-modal-pixel-power .modal-content {
        background: #1e1e1e;
        border: 4px solid #fff;
        border-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'><rect x='0' y='0' width='10' height='10' fill='white'/><rect x='90' y='0' width='10' height='10' fill='white'/><rect x='0' y='90' width='10' height='10' fill='white'/><rect x='90' y='90' width='10' height='10' fill='white'/></svg>") 10;
        image-rendering: pixelated;
        box-shadow: 0 0 0 4px #1e1e1e;
    }

    .promo-modal-pixel-power .modal-title { font-family: var(--font-mono); color: #ffff00; text-shadow: 3px 3px 0 #ff00ff; }
    .promo-modal-pixel-power .modal-message { font-family: var(--font-mono); color: #fff; }
    .promo-modal-pixel-power #alertOkButton { font-family: var(--font-mono); background: #00ff00; color: #000; box-shadow: inset -4px -4px 0px 0px #008000; border: none; }

    .promo-modal-art-deco .modal-content { background: #1a1a1a; border: 1px solid #c9b037; box-shadow: 0 0 30px rgba(201, 176, 55, 0.3); position: relative; }
    .promo-modal-art-deco .modal-content::before, .promo-modal-art-deco .modal-content::after { content: ''; position: absolute; width: 50px; height: 50px; border-style: solid; border-color: #c9b037; }
    .promo-modal-art-deco .modal-content::before { top: 15px; left: 15px; border-width: 2px 0 0 2px; }
    .promo-modal-art-deco .modal-content::after { bottom: 15px; right: 15px; border-width: 0 2px 2px 0; }
    .promo-modal-art-deco .modal-title { font-family: var(--font-serif); color: #f0e6d2; letter-spacing: 2px; }
    .promo-modal-art-deco .modal-message { color: #dcd0b3; }
    .promo-modal-art-deco #alertOkButton { background: #c9b037; color: #1a1a1a; font-family: var(--font-serif); letter-spacing: 1px; }

    .promo-modal-vintage-news .modal-content { background: #fdf5e6; border: 1px solid #dcd3c3; border-radius: 0; box-shadow: 5px 5px 15px rgba(0,0,0,0.3); }
    .promo-modal-vintage-news .modal-title { font-family: var(--font-serif); color: #000; border-bottom: 4px double #000; padding-bottom: 10px; }
    .promo-modal-vintage-news .modal-message { font-family: Georgia, serif; color: #4d4d4d; }
    .promo-modal-vintage-news #alertOkButton { background: #5a5a5a; color: #fff; font-family: var(--font-main); }

    .promo-modal-comic-blast .modal-content { background: #ffff00; border: 4px solid #000; border-radius: 12px; transform: rotate(-2deg); }
    .promo-modal-comic-blast .modal-title { font-family: 'Impact', sans-serif; color: #ff0000; font-size: 2.5rem; text-shadow: 3px 3px 0 #000; }
    .promo-modal-comic-blast .modal-message { font-weight: bold; color: #000; }
    .promo-modal-comic-blast #alertOkButton { background: #0000ff; color: #fff; font-family: 'Impact', sans-serif; letter-spacing: 2px; border: 2px solid #000; }

    .promo-modal-steampunk-gear .modal-content { background: #6a4f3b url('https://www.transparenttextures.com/patterns/brushed-alum.png'); border: 8px solid transparent; border-image: linear-gradient(45deg, #a47b57, #603813) 1; box-shadow: inset 0 0 20px #000; }
    .promo-modal-steampunk-gear .modal-title { font-family: var(--font-serif); color: #fff1c2; text-shadow: 2px 2px 2px #2f1b0c; }
    .promo-modal-steampunk-gear .modal-message { color: #f3e5ab; }
    .promo-modal-steampunk-gear #alertOkButton { background: #4d2d11; color: #fff1c2; border: 2px solid #a47b57; }

    .promo-modal-zen-minimal .modal-content { background: #fff; border: none; border-radius: var(--radius-lg); box-shadow: 0 15px 40px rgba(0,0,0,0.1); text-align: left; }
    .promo-modal-zen-minimal .modal-title { color: #000; font-weight: 500; }
    .promo-modal-zen-minimal .modal-message { color: #666; }
    .promo-modal-zen-minimal #alertOkButton { background: #333; color: #fff; font-weight: 500; }

    .promo-modal-street-grunge .modal-content { background: #e0e0e0 url('https://www.transparenttextures.com/patterns/concrete-wall.png'); border: none; border-radius: 0; box-shadow: none; padding: 30px; clip-path: polygon(0 0, 100% 5%, 95% 100%, 5% 95%); }
    .promo-modal-street-grunge .modal-title { font-family: 'Impact', sans-serif; font-size: 2.5rem; color: #ff3d71; -webkit-text-stroke: 1px black; }
    .promo-modal-street-grunge .modal-message { color: #1a1a1a; font-weight: 500; }
    .promo-modal-street-grunge #alertOkButton { background: #1a1a1a; color: #fff; border-radius: 0; transform: skew(-15deg); }

    .promo-modal-hollywood-premiere .modal-content { background: radial-gradient(circle, #333, #000); border: 2px solid #ffd700; border-radius: 15px; position: relative; box-shadow: 0 0 50px rgba(255, 215, 0, 0.4); }
    .promo-modal-hollywood-premiere .modal-content::before { content: '★ ★ ★ ★ ★'; position: absolute; top: 20px; left: 0; right: 0; font-size: 1.5rem; color: #ffd700; opacity: 0.8; }
    .promo-modal-hollywood-premiere .modal-title { font-family: var(--font-serif); color: #ffd700; margin-top: 30px; }
    .promo-modal-hollywood-premiere .modal-message { color: #fff; }
    .promo-modal-hollywood-premiere #alertOkButton { background: #ffd700; color: #000; font-weight: bold; }

    .promo-modal-top-secret .modal-content { background: #f4f1e9; border: 1px solid #ccc; border-radius: 0; font-family: var(--font-mono); }
    .promo-modal-top-secret .modal-title { background: #ff0000; color: #fff; padding: 5px 10px; display: inline-block; font-size: 1.5rem; font-weight: bold; transform: rotate(-5deg); margin-bottom: 30px; }
    .promo-modal-top-secret .modal-message { color: #000; }
    .promo-modal-top-secret #alertOkButton { background: #d9534f; color: #fff; font-family: var(--font-mono); text-transform: none; }

    .promo-modal-tiki-fiesta .modal-content { background: #ffecd3 url('https://www.transparenttextures.com/patterns/wood-pattern.png'); border: 10px solid transparent; border-image: url('data:image/svg+xml;utf8,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><rect width="100" height="100" fill="%238d6e63"/><path d="M0 0 L50 50 L0 100 Z M100 0 L50 50 L100 100 Z" fill="%235d4037" /></svg>') 20 round; }
    .promo-modal-tiki-fiesta .modal-title { font-family: 'Impact', sans-serif; color: #ff7043; -webkit-text-stroke: 1px #3e2723; }
    .promo-modal-tiki-fiesta .modal-message { color: #5d4037; font-weight: 500; }
    .promo-modal-tiki-fiesta .modal-message b { color: #009688; }
    .promo-modal-tiki-fiesta #alertOkButton { background: #ff7043; color: #fff; border-radius: 20px; border: 2px solid #3e2723; }
    /* === FIN: _promo-themes.css === */
    @media (max-width: 600px) {
        .predefined-notes-container {
            grid-template-columns: 1fr; /* Cambia a una sola columna */
        }

        .predefined-note-item .note-input-group {
            flex-direction: column; /* Apila el select y el input verticalmente */
        }

        /* Opcional: Para que los botones de la barra de herramientas no tengan texto en móviles */
        .button-container button span {
            display: none;
        }
        .button-container button {
            padding: 12px;
        }
        .totals-grid {
            grid-template-columns: 1fr;
        }
    }
    /* === ESTILOS PARA MOSTRAR EL NOMBRE DEL TRABAJADOR === */
    #worker-name-display {
        display: flex;
        align-items: center;
        gap: 8px;
        background: var(--bg-primary);
        padding: 6px 12px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border-glass);
        color: var(--primary-cyan);
        font-weight: 600;
        font-size: 0.9rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 200px;
    }

    #worker-name-display span {
        overflow: hidden;
        text-overflow: ellipsis;
    }

    @media (max-width: 768px) {
        /* En móvil, lo movemos a su propia línea para que no comprima el resto */
        #worker-name-display {
            order: 5; /* Se mostrará al final de los elementos del header */
            width: 100%;
            justify-content: center;
            max-width: none;
            margin-top: 5px;
        }
    }
/* Indicadores de Stock de Almacén */
.wh-indicator {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-left: 8px;
    cursor: help;
    position: relative;
    border: 1px solid rgba(255,255,255,0.2);
}
.wh-indicator.wh-ok { background-color: var(--success-color); box-shadow: 0 0 5px var(--success-color); }
.wh-indicator.wh-low { background-color: var(--warning-color); box-shadow: 0 0 5px var(--warning-color); }
.wh-indicator.wh-empty { background-color: var(--danger-color); box-shadow: 0 0 5px var(--danger-color); }

/* Tooltip simple para el stock */
.wh-indicator:hover::after {
    content: attr(data-stock);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: var(--bg-dark);
    border: 1px solid var(--border-glass);
    padding: 4px 8px;
    border-radius: 4px;
    white-space: nowrap;
    font-size: 0.75rem;
    color: #fff;
    pointer-events: none;
    z-index: 10;
    margin-bottom: 5px;
}
/* Corrección de alineación para la celda de nombre */
.name-cell-wrapper {
    display: flex;
    align-items: center;
    justify-content: space-between; /* Nombre a la izq, punto a la der */
    width: 100%;
    min-height: 24px; /* Altura mínima consistente */
}

.name-cell-text {
    text-align: left;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-right: 8px; /* Espacio entre nombre y punto */
}

/* Ajuste para que la columna de nombre en la tabla no centre el contenido */
.responsive-table tbody td:nth-child(2) {
    text-align: left !important;
    vertical-align: middle;
}
/* Estilos para la lista de cambio de costos y Checkboxes Personalizados */
.cost-change-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--bg-primary);
    padding: 12px 15px; /* Un poco más de padding lateral */
    border-radius: var(--radius-sm);
    margin-bottom: 8px;
    border: 1px solid var(--border-glass);
    gap: 15px; /* Espacio entre el checkbox y el texto */
    transition: background-color 0.2s ease;
}

.cost-change-item:hover {
    background-color: rgba(255, 255, 255, 0.03);
    border-color: var(--border-highlight);
}

/* === ESTILOS NUEVOS PARA EL CHECKBOX NEON === */
.cost-update-checkbox {
    /* Elimina el estilo por defecto del navegador */
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    
    width: 22px;
    height: 22px;
    min-width: 22px; /* Evita que se aplaste */
    
    border: 2px solid var(--text-secondary);
    border-radius: 6px; /* Bordes ligeramente redondeados */
    background-color: transparent;
    cursor: pointer;
    position: relative;
    transition: all 0.2s ease;
    display: grid;
    place-content: center;
}

/* Efecto Hover */
.cost-update-checkbox:hover {
    border-color: var(--primary-cyan);
    box-shadow: 0 0 8px var(--glow-cyan);
}

/* Estado Marcado (Checked) */
.cost-update-checkbox:checked {
    background-color: var(--primary-cyan);
    border-color: var(--primary-cyan);
    box-shadow: 0 0 10px var(--glow-cyan);
}

/* El símbolo de check (Palomita) */
.cost-update-checkbox::before {
    content: "";
    width: 12px;
    height: 12px;
    transform: scale(0); /* Oculto por defecto */
    transition: 0.2s transform ease-in-out;
    box-shadow: inset 1em 1em var(--bg-dark); /* Color del check */
    transform-origin: center;
    clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
    background-color: var(--bg-dark);
}

.cost-update-checkbox:checked::before {
    transform: scale(1); /* Mostrar al marcar */
}

/* Ajuste para el texto "Seleccionar Todos" */
.select-all-container {
    margin-bottom: 15px; 
    padding-bottom: 15px; 
    border-bottom: 1px solid var(--border-glass); 
    display: flex; 
    align-items: center; 
    gap: 15px;
}

.select-all-label {
    cursor: pointer; 
    color: var(--text-primary); 
    font-weight: 600;
    font-size: 0.95rem;
    user-select: none;
}

.cost-change-name {
    font-weight: 600;
    color: var(--text-primary);
    flex-grow: 1;
}

.cost-values {
    display: flex;
    align-items: center;
    gap: 10px;
    font-family: var(--font-mono);
    font-size: 0.9rem;
}

.old-cost {
    color: var(--danger-color);
    text-decoration: line-through;
    opacity: 0.7;
}

.arrow-sep {
    color: var(--text-secondary);
    font-size: 0.8rem;
}

.new-cost {
    color: var(--success-color);
    font-weight: bold;
}

/* === ESTILOS FIXED PARA BORRADOR COMPACTO (PANTALLA COMPLETA) === */

/* Forzar modal a pantalla completa sin bordes */
#draftModal {
    padding: 0 !important;
}

#draftModal .modal-content {
    width: 100% !important;
    height: 100% !important;
    max-width: 100% !important;
    max-height: 100vh !important;
    border-radius: 0 !important;
    border: none !important;
    display: flex;
    flex-direction: column;
    padding: 0 !important;
    background: var(--bg-dark);
}

/* Encabezado Ultra Compacto */
.draft-header-compact {
    background: var(--bg-glass);
    border-bottom: 1px solid var(--border-glass);
    padding: 8px;
    display: flex;
    gap: 8px;
    align-items: center;
    justify-content: space-between;
    flex-wrap: nowrap;
    backdrop-filter: blur(10px);
    z-index: 50;
}

.draft-header-title {
    font-size: 0.9rem;
    font-weight: 700;
    color: var(--text-primary);
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 5px;
}

.draft-controls-group {
    display: flex;
    gap: 5px;
    flex-grow: 1;
    justify-content: flex-end;
}

.btn-draft-compact {
    padding: 6px 10px;
    font-size: 0.75rem;
    border-radius: 4px;
    border: 1px solid var(--border-glass);
    background: var(--bg-primary);
    color: var(--text-primary);
    cursor: pointer;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 4px;
    white-space: nowrap;
}

.btn-draft-action {
    background-image: linear-gradient(135deg, var(--primary-cyan) 0%, var(--primary-magenta) 100%);
    color: var(--bg-dark);
    border: none;
}

/* Tabla Ajustada */
#draft-table {
    width: 100% !important;
    border-collapse: collapse;
    table-layout: fixed;
}

#draft-table th, 
#draft-table td {
    padding: 4px 2px !important;
    vertical-align: middle !important;
    font-size: 0.8rem !important;
    white-space: nowrap;
}

#draft-table th {
    background: var(--bg-primary);
    color: var(--text-secondary);
    font-size: 0.7rem !important;
    text-transform: uppercase;
}

/* --- ANCHOS DE COLUMNAS (5 Columnas) --- */
/* 1. PRODUCTO (El resto del espacio) */
#draft-table th:nth-child(1),
#draft-table td:nth-child(1) {
    display: table-cell !important;
    width: auto !important; 
    text-align: left !important;
    padding-left: 8px !important;
    overflow: hidden;
    text-overflow: ellipsis;
    font-weight: 600;
    color: var(--text-primary);
}

/* 2. INI (Inicio - Solo lectura) */
#draft-table th:nth-child(2),
#draft-table td:nth-child(2) {
    width: 30px !important;
    text-align: center !important;
    color: var(--text-secondary);
    font-size: 0.75rem !important;
}

/* 3. ENT (Entradas - Editable) */
#draft-table th:nth-child(3),
#draft-table td:nth-child(3) {
    width: 45px !important;
    text-align: center !important;
}

/* 4. FIN (Finales/Físico - Editable) */
#draft-table th:nth-child(4),
#draft-table td:nth-child(4) {
    width: 45px !important;
    text-align: center !important;
}

/* 5. OK (Botón) */
#draft-table th:nth-child(5),
#draft-table td:nth-child(5) {
    width: 35px !important;
    text-align: center !important;
}

/* Inputs dentro de la tabla */
#draft-table .draft-input {
    width: 100% !important;
    height: 32px !important;
    padding: 0 !important;
    font-size: 0.95rem !important;
    text-align: center;
    background: rgba(0, 0, 0, 0.4) !important;
    border: 1px solid var(--border-glass);
    border-radius: 4px;
    color: white;
}

/* Color específico para Entradas para diferenciarlo */
#draft-table .draft-input.input-entrada {
    color: var(--success-color);
    border-color: rgba(0, 255, 149, 0.3);
}

#draft-table .draft-input:focus {
    border-color: var(--primary-cyan);
    background: var(--bg-primary) !important;
    z-index: 10;
}

.differs {
    background: rgba(0, 224, 255, 0.1) !important;
    border-color: var(--primary-cyan) !important;
}

/* Botón Icono */
.btn-icon-apply {
    width: 30px !important;
    height: 30px !important;
    padding: 0 !important;
    margin: 0 auto !important;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 224, 255, 0.15);
    border: 1px solid var(--primary-cyan);
    border-radius: 4px;
    color: var(--primary-cyan);
    cursor: pointer;
}
</style>
<body>

<!-- SVG Sprite para Iconos -->
<svg style="display: none;"  width="0" height="0" >
    <symbol id="icon-chevron-up" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></symbol>
    <symbol id="icon-chevron-down" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></symbol>
    <symbol id="icon-calculator" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="16" y1="14" x2="16" y2="18"/><g><line x1="8" y1="10" x2="8" y2="10"/><line x1="12" y1="10" x2="12" y2="10"/><line x1="8" y1="14" x2="8" y2="14"/><line x1="12" y1="14" x2="12" y2="14"/><line x1="8" y1="18" x2="8" y2="18"/><line x1="12" y1="18" x2="12" y2="18"/></g></symbol>
    <symbol id="icon-dollar" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="2" x2="12" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></symbol>
    <symbol id="icon-add" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></symbol>
    <symbol id="icon-box" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></symbol>
    <symbol id="icon-pizza" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 00-9.4 12.5l9.4 7.5 9.4-7.5A10 10 0 0012 2z"/><path d="M12 12L2.6 4.5"/><path d="M12 12l9.4-7.5"/><path d="M12 12v10"/><path d="M7 13a2 2 0 100-4 2 2 0 000 4z"/></symbol>
    <symbol id="icon-trash" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></symbol>
    <symbol id="icon-refresh" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10"></path><path d="M20.49 15a9 9 0 0 1-14.85 3.36L1 14"></path></symbol>
    <symbol id="icon-eye" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></symbol>
    <symbol id="icon-eye-off" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></symbol>
    <!-- ===== NUEVO ICONO DE ESCUDO ===== -->
    <symbol id="icon-shield" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></symbol>
</svg>

<div id="login-screen-wrapper">
    <div id="loginModal" class="login-container">
        <div class="branding-section">
            <div class="logo-container">
                <img style="display: none;" src="./img/Logo.png" alt="Logo IPV" class="logo">
                <h1 class="app-title">Gestión IPV</h1>
                <p class="app-subtitle">Tu inventario, simple y en la nube.</p>
            </div>
            <div class="branding-footer">
                <p>Sistema seguro • Encriptación de datos</p>
                <p id="app-version-display" style="margin-top: 10px; color: var(--text-secondary);"></p>
            </div>
        </div>
        <div class="form-section">
            <div class="form-container">
                <form id="loginForm">
                    <div class="form-header">
                        <h2 class="form-title">Iniciar Sesión</h2>
                        <p class="form-subtitle">Ingresa los datos para acceder al sistema.</p>
                    </div>
                    <div class="form-group">
                        <label for="businessNameInput" class="form-label">Negocio</label>
                        <div class="input-with-icon">
                            <i class="input-icon">🏪</i>
                            <input type="text" id="businessNameInput" class="form-input" placeholder="Nombre de tu negocio" required autocomplete="organization">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="workerNameInput" class="form-label">Tu Nombre (Opcional)</label>
                        <div class="input-with-icon">
                            <i class="input-icon fa-solid fa-user-tie"></i>
                            <input
                                    type="text"
                                    id="workerNameInput"
                                    class="form-input"
                                    placeholder="Ej: Juan Perez"
                                    autocomplete="username"
                            >
                            <small style="color: var(--text-secondary); font-size: 0.8em;">
                                Deja en blanco si eres el dueño e introduce la contraseña del negocio.
                            </small>
                        </div>
                    </div>


                    <div class="form-group">
                        <label for="passwordInput" class="form-label">Contraseña o PIN</label>
                        <div class="input-with-icon">
                            <i class="input-icon">🔒</i>
                            <input type="password" id="passwordInput" class="form-input" placeholder="Contraseña (dueño) o PIN (trabajador)" required autocomplete="current-password">
                        </div>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary"><span>Acceder al sistema</span></button>
                    </div>
                    <div class="form-footer">
                        <p class="form-switch">¿No tienes una cuenta? <a href="#" data-action="switchToCreate">Crear negocio</a></p>
                        <p class="form-switch"><a href="#" data-action="localMode">Modo local sin conexión</a></p>
                    </div>
                </form>
                <form id="createForm" class="hidden">
                    <div class="form-header">
                        <h2 class="form-title">Crear Nuevo Negocio</h2>
                        <p class="form-subtitle">Al registrar tu negocio puedes utilizar nuestro Sistema de IPV libre de costo durante un mes.</p>
                    </div>
                    <div class="form-group">
                        <label for="newBusinessName" class="form-label">Nombre del Negocio</label>
                        <input type="text" id="newBusinessName" class="form-input" placeholder="Ej: Mi Tienda" required autocomplete="organization">
                    </div>
                    <div class="form-group">
                        <label for="newAdminEmail" class="form-label">Email Administrador</label>
                        <input type="email" id="newAdminEmail" class="form-input" placeholder="tucorreo@ejemplo.com" required autocomplete="email">
                    </div>
                    <div class="form-group">
                        <label for="newPassword" class="form-label">Contraseña</label>
                        <input type="password" id="newPassword" class="form-input" placeholder="••••••••" required autocomplete="new-password">
                    </div>

                    <!-- ===== SECCIÓN DE ENCRIPTACIÓN ===== -->
                    <div class="form-group" style="background: rgba(136, 173, 255, 0.1); padding: 15px; border-radius: var(--radius-sm); border: 1px solid var(--border-glass);">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="enableEncryption" style="width: auto;">
                            <label for="enableEncryption" class="form-label" style="margin-bottom: 0;">Activar Encriptación de Conocimiento Cero</label>
                        </div>
                        <p style="font-size: 0.8em; color: var(--text-secondary); margin-top: 10px;">
                            <strong style="color: var(--success-color);">¡Tu Privacidad, Nuestra Prioridad!</strong>
                            <br>
                            Al activar esta opción, tus datos se encriptan con una clave que solo tú posees.
                            Nadie, ni siquiera nosotros, podrá acceder a tu información. Tu negocio, tus datos.
                        </p>
                    </div>

                    <div class="form-group">
                        <button type="submit" class="btn btn-primary"><span>Registrar Negocio</span></button>
                    </div>
                    <div class="form-footer">
                        <p class="form-switch">¿Ya tienes una cuenta? <a href="#" data-action="switchToLogin">Iniciar sesión</a></p>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div id="loadingOverlay"><p id="loadingMessage">Procesando...</p></div>

<header class="header hidden" id="header">
    <div class="header-left">
        <img style="display: none;" src="./img/Logo.png" alt="Logo" class="logo">
        <h1 id="businessTitle">IPV Dependiente</h1>
        <div id="worker-name-display" class="hidden">👤 <span></span></div>
        <button id="header-admin-btn" class="admin-toggle-btn" data-action="toggle-admin-mode">ADMIN</button>
        <div class="header-date-input">
            <button title="Día Anterior" data-action="prevDayBtn">◀</button>
            <input type="date" id="dateInput">
            <button title="Día Siguiente" data-action="nextDayBtn">▶</button>
        </div>
    </div>

    <div class="header-center">
        <input type="text" id="searchInput" placeholder="Buscar productos...">
    </div>

    <label for="menu-toggle" class="hamburger-menu"><span></span><span></span><span></span></label>
</header>

<input type="checkbox" id="menu-toggle" class="menu-toggle">
<label for="menu-toggle" class="menu-backdrop"></label>
<nav class="header-menu">
    <h2>Menú de Acciones</h2>
    <section class="header-menu-section">
        <h4>Herramientas</h4>
        <button class="header-button" data-action="menu-sync-warehouse" style="border-left: 3px solid #E100FF;">⬇ Descargar Catálogo Almacén</button>
        <button class="header-button" data-action="menu-open-draft" style="border-left: 3px solid #00E0FF;">
    📝 Borrador de Conteo (Interactivo)
</button>
<button class="header-button" data-action="toggle-theme" style="border-left: 3px solid #FFD600;">
    ☀ Cambiar Tema (Claro/Oscuro)
</button>
        <button class="header-button" data-action="menu-audit-costs">Auditoría de Costos</button>
        <button class="header-button" data-action="menu-audit-products">Auditoría Prod.</button>
        <button class="header-button" data-action="menu-reset-day">Reiniciar Día</button>
        <button class="header-button" data-action="menu-end-of-day">Cierre de Día</button>
        <button class="header-button" data-action="menu-clear-cache">Limpiar Caché Local</button>
        <button class="header-button" data-action="menu-change-pin">Cambiar PIN Admin</button>
    </section>
    <section class="header-menu-section hidden" id="owner-admin-section">
        <h4>Gestión del Negocio</h4>
        <button class="header-button" data-action="open-business-admin">Gestionar Trabajadores</button>
    </section>

    <section class="header-menu-section"><h4>Reportes</h4><button class="header-button" data-action="menu-financial-summary">Resumen Financiero</button><button class="header-button" data-action="menu-performance-report">Rendimiento Prod.</button><button class="header-button" data-action="menu-compare-periods">Comparar Períodos</button></section>
    <section class="header-menu-section"><h4>Datos</h4><button class="header-button" data-action="menu-copy-report">Copiar Reporte</button><button class="header-button" data-action="menu-export-day">Exportar Día</button><button class="header-button" data-action="menu-import-day">Importar Día</button></section>
    <section class="header-menu-section"><h4>Información</h4><button class="header-button" data-action="menu-about">Acerca de / Cambios</button></section>
    <section class="header-menu-section"><h4>Usuario y Sesión</h4>
        <div class="session-controls">
            <button id="menu-admin-btn" class="header-button admin-toggle-btn" data-action="toggle-admin-mode">Modo Admin</button>
            <button class="header-button" data-action="menu-change-password">Cambiar Contraseña</button>
            <div id="sync-status">
                <span id="sync-indicator" style="width:12px; height:12px; border-radius:50%;"></span>
                <button id="syncButton" class="header-button" data-action="syncButton">Sincronizar</button>
            </div>
            <button id="logoutBtn" class="header-button" data-action="logoutBtn">Salir</button>
        </div>
    </section>
</nav>



<div class="button-container">
        <button data-action="deleteSelectedBtn" aria-label="Eliminar productos seleccionados" title="Eliminar productos seleccionados"><svg width="20" height="20" aria-hidden="true"><use xlink:href="#icon-trash"></use></svg></button>
        <button data-action="addProductBtn" aria-label="Añadir nuevo producto" title="Añadir nuevo producto"><svg width="20" height="20" aria-hidden="true"><use xlink:href="#icon-add"></use></svg></button>
        <button data-action="toggleAllBtn">Expandir/Contraer</button>
        <button data-action="toggle-admin-mode" class="admin-toggle-btn" aria-label="Activar modo administrador" title="Activar modo administrador">
            <svg width="20" height="20" aria-hidden="true"><use xlink:href="#icon-shield"></use></svg>
            <span>Admin</span>
        </button>
        <button data-action="showZeroStockBtn" aria-label="Mostrar lista de productos con stock cero" title="Mostrar lista de productos con stock cero"><svg width="20" height="20" aria-hidden="true"><use xlink:href="#icon-box"></use></svg><span>Stock Cero</span></button>
        <button data-action="toggle-hide-zero-stock" aria-label="Ocultar productos con stock cero" title="Ocultar productos con stock cero"><svg width="20" height="20" aria-hidden="true"><use id="eye-icon" xlink:href="#icon-eye"></use></svg></button>
        <button data-action="openCalculatorBtn" aria-label="Abrir calculadora" title="Abrir calculadora"><svg width="20" height="20" aria-hidden="true"><use xlink:href="#icon-calculator"></use></svg></button>
        <button data-action="openBillCounterBtn" aria-label="Abrir contador de billetes" title="Abrir contador de billetes"><svg width="20" height="20" aria-hidden="true"><use xlink:href="#icon-dollar"></use></svg></button>
        
 <button data-action="refresh-data" aria-label="Refrescar datos" title="Refrescar datos">
            <svg width="20" height="20" aria-hidden="true"><use xlink:href="#icon-refresh"></use></svg>
        </button>

        <button data-action="menu-open-draft" aria-label="Abrir Borrador de Conteo" title="Abrir Borrador de Conteo" style="color: var(--primary-cyan); border-color: var(--primary-cyan);">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
        </button>

       
    </div>
    <div class="responsive-table-wrapper">
        <table class="responsive-table" id="product-table">
            <thead>
            <tr>
                <th><input type="checkbox" id="selectAllCheckbox"></th>
                <th>
                    Productos
                    <span id="total-products-count"></span>
                    <span id="zero-stock-count"></span>
                </th>
                <th>Inicio</th>
                <th>Entrada</th>
                <th>Finales</th>
                <th>Vendido</th>
                <th class="admin-only hidden">Costo</th>
                <th>Precio</th>
                <th>Importe</th>
                <th class="admin-only hidden">Ganancias</th>
                <th>Acciones</th>
            </tr>
            </thead>
            <tbody id="product-list"></tbody>
        </table>
    </div>
    <section class="section-box">
        <h2>Gastos y Recogidas</h2>
        <div class="gastos-list" id="gastos-list"></div>
        <button class="add-gasto-button" data-action="addGastoBtn">Añadir Gasto / Recogida</button>
    </section>

    <details class="section-box" id="pizza-calculator-section">
        <summary>
            <h2>
                <svg width="24" height="24" aria-hidden="true"><use xlink:href="#icon-pizza"></use></svg>
                Calculadora de Pizzas
            </h2>
            <div id="pizza-summary-preview" class="pizza-summary-preview"></div>
            <div class="summary-chevron"></div>
        </summary>
        <div class="pizza-calculator-content">
            <div class="pizza-panel">
                <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; margin-bottom: 20px;">
                    <button class="btn btn-danger" id="pizza-clear-btn">Limpiar</button>
                    <button class="btn btn-secondary" id="pizza-copy-report-btn">Copiar</button>
                </div>
            </div>
            <div class="pizza-panel">
                <h3>Ingredientes Base y Costos</h3>
                <div class="input-grid">
                    <div class="form-group"><label>Jarros Harina</label><input type="number" step="any" id="pizza-jarrosHarina"></div>
                    <div class="form-group"><label>Costo / Jarro</label><input type="number" step="0.01" id="pizza-costoJarro"></div>
                    <div class="form-group"><label>Lbs Queso</label><input type="number" step="any" id="pizza-librasQueso"></div>
                    <div class="form-group"><label>Costo / Lb Queso</label><input type="number" step="0.01" id="pizza-costoQueso"></div>
                    <div class="form-group"><label>Mano de Obra</label><input type="number" step="0.01" id="pizza-manoObra"></div>
                </div>
            </div>
            <div class="pizza-panel">
                <h3>Otros Gastos Variables</h3>
                <div class="input-grid">
                    <div class="form-group"><label>Carbón</label><input type="number" step="0.01" id="pizza-costoCarbon"></div>
                    <div class="form-group"><label>Levadura</label><input type="number" step="0.01" id="pizza-costoLevadura"></div>
                    <div class="form-group"><label>Grasa</label><input type="number" step="0.01" id="pizza-costoGrasa"></div>
                    <div class="form-group"><label>Color</label><input type="number" step="0.01" id="pizza-costoColor"></div>
                    <div class="form-group"><label>Polvoreo</label><input type="number" step="0.01" id="pizza-costoPolvoreo"></div>
                    <div class="form-group"><label>Otros</label><input type="number" step="0.01" id="pizza-costoOtros"></div>
                </div>
                <div id="pizza-total-gastos" class="total-box expense">
                    <h4>Total Otros Gastos</h4><p>$0.00</p>
                </div>
            </div>
            <div class="pizza-panel">
                <h3>Ventas (Pizza Base)</h3>
                <div class="input-grid">
                    <div class="form-group"><label>Precio Venta / Pizza</label><input type="number" step="0.01" id="pizza-precioVenta"></div>
                    <div class="form-group"><label>Cant. Pizzas Vendidas</label><input type="number" step="any" id="pizza-cantidadPizzas"></div>
                </div>
            </div>
            <div class="pizza-panel">
                <button class="btn btn-secondary toggle-button" id="pizza-toggle-jamon">
                    <span>Jamón</span><svg width="18" height="18" viewBox="0 0 24 24"><path fill="currentColor" d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z"/></svg>
                </button>
                <div id="pizza-jamon-section" class="optional-content" style="display: none;">
                    <div class="input-grid">
                        <div class="form-group"><label>Lbs Jamón</label><input type="number" step="any" id="pizza-librasJamon"></div>
                        <div class="form-group"><label>Costo / Lb Jamón</label><input type="number" step="0.01" id="pizza-costoJamon"></div>
                        <div class="form-group"><label>Cant. Pizzas Jamón</label><input type="number" step="any" id="pizza-cantidadPizzasJamon"></div>
                        <div class="form-group"><label>Precio Venta Jamón</label><input type="number" step="0.01" id="pizza-precioVentaJamon"></div>
                    </div>
                </div>
            </div>
            <div class="pizza-panel">
                <button class="btn btn-secondary toggle-button" id="pizza-toggle-salchicha">
                    <span>Salchicha</span><svg width="18" height="18" viewBox="0 0 24 24"><path fill="currentColor" d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z"/></svg>
                </button>
                <div id="pizza-salchicha-section" class="optional-content" style="display: none;">
                    <h3>Cálculos de Salchicha (por Raciones)</h3>
                    <div class="input-grid">
                        <div class="form-group"><label>Unidades Salchicha</label><input type="number" step="any" id="pizza-unidadesSalchicha"></div>
                        <div class="form-group"><label>Costo / Unidad</label><input type="number" step="0.01" id="pizza-costoUnidadSalchicha"></div>
                        <div class="form-group"><label>Raciones / Unidad</label><input type="number" step="any" id="pizza-racionesPorUnidad"></div>
                        <div class="form-group"><label>Cant. Raciones Vendidas</label><input type="number" step="any" id="pizza-cantidadRacionesVendidas"></div>
                        <div class="form-group"><label>Precio Venta / Ración</label><input type="number" step="0.01" id="pizza-precioVentaRacion"></div>
                    </div>
                </div>
            </div>
            <div class="pizza-panel">
                <h2>Resultados del Día</h2>
                <div id="pizza-results-container">
                    <p class="hint-text">Rellena los campos para ver los resultados.</p>
                </div>
            </div>
        </div>
    </details>

    <section class="section-box">
        <h2 style="display: none;">Notas Predefinidas</h2>
        <div class="predefined-notes-container">
            <div class="predefined-note-item">
                <label for="note-diferencia-tipo">Diferencia de Caja (CUP):</label>
                <div class="note-input-group">
                    <select id="note-diferencia-tipo"><option value="ninguna">Sin Diferencia</option><option value="falto">Faltó</option><option value="sobro">Sobró</option></select>
                    <input type="number" id="note-diferencia-monto" placeholder="Monto">
                </div>
            </div>
        </div>
    </section>
    <section class="section-box">
        <h2>Notas del Día</h2>
        <textarea id="notas-dia" placeholder="Escribe aquí notas importantes..."></textarea>
    </section>

    <section id="totales-resumen" class="section-box admin-only-row hidden">
        <h2 class="admin-only-row hidden">Totales del Día</h2>
        <div class="totals-grid admin-only-row hidden">
            <p>Ingresos Brutos (Ventas):<strong id="total-importe">0.00</strong></p>
            <p>Total Recogidas de Efectivo:<strong id="total-recogidas">0.00</strong></p>
            <p>Total despues de Gastos:<strong id="efectivo-teorico-caja">0.00</strong></p>

            <hr>
            <p>Ganancia Bruta (Productos-Tabla):<strong id="total-ganancias">0.00</strong></p>
            <p>Gastos Operativos:<strong id="total-gastos-operativos">0.00</strong></p>
            <p>Ganancia despues de gastos:<strong id="ganancia-neta-operativa">0.00</strong></p>
            <hr>
            <p>Costo Total en Stock:<strong id="total-stock-cost">0.00</strong></p>
            <p>Valor Total en Stock (Venta):<strong id="total-stock-value">0.00</strong></p>
        </div>
    </section>

</main> <!-- Cierre del main#container -->
<!-- MÓDULO DE INSUMOS / CONSUMO INTERNO -->
<section class="section-box">
    <h2>Consumo de Insumos (Descuento de Almacén)</h2>
    <p style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 15px;">
        Registra aquí materiales gastables (servilletas, cajas, nylon) para descontarlos del inventario sin afectar la venta.
    </p>
    
    <!-- Lista visual de insumos agregados hoy -->
    <div id="insumos-list" class="gastos-list"></div>

    <!-- Formulario rápido para agregar insumo -->
    <div style="display: flex; gap: 10px; margin-top: 15px; align-items: center;">
        <div style="flex-grow: 1; position: relative;">
            <input type="text" id="insumo-name" class="form-input" placeholder="Nombre del insumo..." list="warehouse-list" autocomplete="off">
        </div>
        <input type="number" id="insumo-qty" class="form-input" placeholder="Cant." style="width: 80px;">
        <button id="addInsumoBtn" class="btn btn-primary" style="width: auto; padding: 10px 20px;">
            <svg width="20" height="20" aria-hidden="true"><use xlink:href="#icon-add"></use></svg>
        </button>
    </div>
</section>
<div id="scroll-fab-container">
    <button id="scrollToBottomBtn" title="Ir al final">
        <svg width="24" height="24"><use xlink:href="#icon-chevron-down"></use></svg>
    </button>
    <button id="scrollToTopBtn" title="Ir al inicio">
        <svg width="24" height="24"><use xlink:href="#icon-chevron-up"></use></svg>
    </button>
</div>

<input type="file" id="file-input" class="hidden">

<!-- =============================================================== -->
<!-- INICIO: SECCIÓN DE MODALES                                     -->
<!-- =============================================================== -->

<div id="alertModal" class="modal"><div class="modal-backdrop"></div><div class="modal-content"><span class="close">&times;</span><h2 id="alertTitle" class="modal-title alert-title">Alerta</h2><div id="alertMessage" class="modal-message" style="max-height: 400px; overflow-y: auto;">Este es un mensaje de alerta.</div><div class="modal-actions"><button id="alertOkButton" class="btn-modal btn-primary">Entendido</button></div></div></div>
<div id="confirmModal" class="modal"><div class="modal-backdrop"></div><div class="modal-content"><span class="close">&times;</span><h2 id="confirmTitle" class="modal-title confirm-title">Confirmación</h2><p id="confirmMessage" class="modal-message">¿Estás seguro?</p><div class="modal-actions"><button id="confirmNo" class="btn-modal btn-secondary">Cancelar</button><button id="confirmYes" class="btn-modal btn-primary">Confirmar</button></div></div></div>
<div id="promptModal" class="modal"><div class="modal-backdrop"></div><div class="modal-content"><span class="close">&times;</span><h2 id="promptTitle" class="modal-title prompt-title">Entrada Requerida</h2><p id="promptMessage" class="modal-message">Por favor, introduce un valor:</p><form id="promptForm"><input type="text" id="promptInput" class="form-input" required autocomplete="off"><div class="modal-actions"><button type="button" id="promptCancel" class="btn-modal btn-secondary">Cancelar</button><button type="submit" class="btn-modal btn-primary">Aceptar</button></div></form></div></div>

<div id="product-modal" class="modal">
    <div class="modal-backdrop"></div>
    <div class="modal-content modal-scrollable-content">
        <span class="close">&times;</span>
        <h2>Añadir Producto</h2>
        <form id="addProductForm">
            <label for="modal-product-category">Categoría:</label>
            <select id="modal-product-category"></select>
            
            <!-- CAMBIO: Se añade list="warehouse-list" y autocomplete="off" -->
            <input type="text" id="modal-product-name" placeholder="Nombre (varios con comas)" list="warehouse-list" required autocomplete="off">
            
            <!-- NUEVO: Esta lista se llena automáticamente con JS al descargar el catálogo -->
            <datalist id="warehouse-list"></datalist>
            
            <input type="number" id="modal-product-start" placeholder="Inicio">
            <input type="number" id="modal-product-cost" placeholder="Costo">
            <input type="number" id="modal-product-price" placeholder="Precio">
            <button type="submit">Añadir</button>
        </form>
    </div>
</div>
<div id="gastos-modal" class="modal"><div class="modal-backdrop"></div><div class="modal-content modal-scrollable-content"><span class="close">&times;</span><h2>Añadir Gasto/Recogida</h2><form id="addGastoForm"><label for="gasto-type">Tipo:</label><select id="gasto-type"><option value="gasto">Gasto Operativo (Afecta Ganancia)</option><option value="recogida">Recogida de Efectivo (No afecta Ganancia)</option></select><input type="text" id="gastos-description" placeholder="Descripción" required><input type="number" id="gastos-amount" placeholder="Monto" required><button type="submit">Añadir</button></form></div></div>
<div id="pinModal" class="modal"><div class="modal-backdrop"></div><div class="modal-content"><span class="close">&times;</span><h2>Acceso Admin</h2><form id="pinForm"><input type="password" id="pinInput" placeholder="PIN" inputmode="numeric" maxlength="4" autocomplete="one-time-code"><button type="submit">Acceder</button></form></div></div>
<div id="zeroStockModal" class="modal"><div class="modal-backdrop"></div><div class="modal-content"><span class="close">&times;</span><h2>Productos con Stock Cero</h2><div class="modal-scrollable-content"><ul id="zeroStockList"></ul></div><div class="modal-actions"><button id="copyZeroStockBtn" class="btn-modal btn-primary" data-action="copyZeroStockList">Copiar Lista</button></div></div></div>
<div id="zeroCostModal" class="modal"><div class="modal-backdrop"></div><div class="modal-content" style="max-width: 600px;"><span class="close">&times;</span><h2>Auditoría de Productos con Costo Cero</h2><div class="modal-scrollable-content"><p>Aquí se listan los productos del día actual que tienen un costo de 0.00. Corrige los costos para asegurar cálculos de ganancia correctos.</p><div id="zeroCostListContainer" style="margin-top: 15px;"></div></div></div></div>
<div id="dataAuditModal" class="modal"><div class="modal-backdrop"></div><div class="modal-content" style="max-width: 800px;"><span class="close">&times;</span><h2>Auditoría de Productos</h2><div class="modal-form-group"><label>Nombre del Producto:</label><input type="text" id="audit-product-name" placeholder="Escribe el nombre del producto..." style="flex-grow: 1;"><button class="btn-modal-action" data-action="runAuditBtn">Auditar</button></div><div id="audit-results" class="modal-scrollable-content"><p>Escribe el nombre de un producto y haz clic en "Auditar" para ver su historial.</p></div></div></div>
<div id="performanceReportModal" class="modal"><div class="modal-backdrop"></div><div class="modal-content" style="max-width: 700px;"><span class="close">&times;</span><h2>Reporte de Rendimiento</h2><div class="modal-form-group"><label>Desde:</label><input type="date" id="perf-start-date"><label>Hasta:</label><input type="date" id="perf-end-date"></div><button class="btn-modal-action" data-action="generatePerformanceReportBtn">Generar Reporte</button><div id="performance-content" class="modal-scrollable-content" style="margin-top:20px;"><p>Selecciona un rango de fechas para ver el rendimiento de los productos.</p></div></div></div>
<div id="comparisonModal" class="modal"><div class="modal-backdrop"></div><div class="modal-content" style="max-width: 900px;"><span class="close">&times;</span><h2>Comparación de Períodos</h2><div class="modal-scrollable-content"> <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;"><div><h4>Período A</h4><div class="modal-form-group"><label>Desde:</label><input type="date" id="comp-a-start"><label>Hasta:</label><input type="date" id="comp-a-end"></div></div><div><h4>Período B</h4><div class="modal-form-group"><label>Desde:</label><input type="date" id="comp-b-start"><label>Hasta:</label><input type="date" id="comp-b-end"></div></div></div><button class="btn-modal-action" data-action="runComparisonBtn" style="width:100%;">Comparar</button><div id="comparison-results" style="margin-top: 20px;"><p>Selecciona dos rangos de fecha para comparar.</p></div></div></div></div>
<div id="financialSummaryModal" class="modal"><div class="modal-backdrop"></div><div class="modal-content" style="max-width: 600px;"><span class="close">&times;</span><h2>Resumen Financiero</h2><div class="modal-scrollable-content"><div class="filter-buttons"><button data-period="week">Esta Semana</button><button data-period="month">Este Mes</button><button data-period="last_month">Mes Pasado</button><button data-period="all">Todo</button></div><div id="summary-content"></div></div></div></div>
<div id="calculatorModal" class="modal"><div class="modal-backdrop"></div><div class="modal-content"><div class="calculator-display"><div id="calcPrevious" class="muted"></div><div id="calcCurrent">0</div></div><div class="calculator-grid"><button class="span-two special" data-action="clear">AC</button><button class="special" data-action="delete">DEL</button><button class="operator" data-action="operator">÷</button><button data-action="number">7</button><button data-action="number">8</button><button data-action="number">9</button><button class="operator" data-action="operator">×</button><button data-action="number">4</button><button data-action="number">5</button><button data-action="number">6</button><button class="operator" data-action="operator">-</button><button data-action="number">1</button><button data-action="number">2</button><button data-action="number">3</button><button class="operator" data-action="operator">+</button><button data-action="number">0</button><button data-action="number">00</button><button data-action="number">.</button><button class="equals" data-action="equals">=</button></div></div></div>
<div id="billCounterModal" class="modal"><div class="modal-backdrop"></div><div class="modal-content"><span class="close">&times;</span><div class="bc-header"><div class="bc-header-totals"><div id="bc_total">Activos: $0</div><div id="bc_inactiveTotal">Inactivos: $0</div><div id="bc_grandTotal">Total: $0</div></div><div class="bc-header-buttons"><button class="header-btn" data-action="bc_save">Guardar</button><button class="header-btn" data-action="bc_history">Historial</button><button class="header-btn" data-action="bc_clear_prompt">Limpiar</button></div></div><div class="bc-body-scrollable"><div class="bill-row" id="bc_row1000"><label>1000 x</label><input type="number" id="bc_bill1000" value="0"><div class="individual-total" id="bc_total1000">$0</div><input type="checkbox" class="bill-toggle" id="bc_toggle1000" checked></div><div class="bill-row" id="bc_row500"><label>500 x</label><input type="number" id="bc_bill500" value="0"><div class="individual-total" id="bc_total500">$0</div><input type="checkbox" class="bill-toggle" id="bc_toggle500" checked></div><div class="bill-row" id="bc_row200"><label>200 x</label><input type="number" id="bc_bill200" value="0"><div class="individual-total" id="bc_total200">$0</div><input type="checkbox" class="bill-toggle" id="bc_toggle200" checked></div><div class="bill-row" id="bc_row100"><label>100 x</label><input type="number" id="bc_bill100" value="0"><div class="individual-total" id="bc_total100">$0</div><input type="checkbox" class="bill-toggle" id="bc_toggle100" checked></div><div class="bill-row" id="bc_row50"><label>50 x</label><input type="number" id="bc_bill50" value="0"><div class="individual-total" id="bc_total50">$0</div><input type="checkbox" class="bill-toggle" id="bc_toggle50" checked></div><div class="bill-row" id="bc_row20"><label>20 x</label><input type="number" id="bc_bill20" value="0"><div class="individual-total" id="bc_total20">$0</div><input type="checkbox" class="bill-toggle" id="bc_toggle20" checked></div><div class="bill-row" id="bc_row10"><label>10 x</label><input type="number" id="bc_bill10" value="0"><div class="individual-total" id="bc_total10">$0</div><input type="checkbox" class="bill-toggle" id="bc_toggle10" checked></div><div class="bill-row" id="bc_row5"><label>5 x</label><input type="number" id="bc_bill5" value="0"><div class="individual-total" id="bc_total5">$0</div><input type="checkbox" class="bill-toggle" id="bc_toggle5" checked></div></div></div></div>
<div id="bc_confirmModal" class="modal bc-modal"><div class="modal-backdrop"></div><div class="modal-content"><span class="close">&times;</span><p>¿Limpiar todos los valores?</p><div class="modal-actions"><button data-action="bc_cancel_clear" class="btn-modal btn-secondary">No</button><button data-action="bc_confirm_clear" class="btn-modal btn-primary">Sí</button></div></div></div>
<div id="bc_historyModal" class="modal bc-modal"><div class="modal-backdrop"></div><div class="modal-content"><span class="close">&times;</span><h2>Historial de Conteos</h2><ul id="bc_historyList" class="modal-scrollable-content"></ul></div></div>
<div id="bc_historyDetailModal" class="modal bc-modal"><div class="modal-backdrop"></div><div class="modal-content modal-scrollable-content"><span class="close">&times;</span><h2>Detalle del Conteo</h2><div id="bc_historyDetailContent"></div></div></div>
<div id="payment-lock-modal" class="modal is-persistent" style="display: none; z-index: 9999;"><div class="modal-backdrop" style="background-color: rgba(0,0,0,0.85); backdrop-filter: blur(5px);"></div><div class="modal-content" style="max-width: 500px; text-align: center;"><img style="display: none;" src="./img/Logo.png" alt="Logo IPV" style="width: 80px; margin-bottom: 20px;"><h2 class="modal-title" style="color: var(--danger-color); display: flex; align-items: center; justify-content: center; gap: 10px;"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
    Acceso Interrumpido</h2><p class="modal-message" style="font-size: 1.1em; line-height: 1.6;"><strong>El pago de tu cuota de servicio está pendiente.</strong><br><br>
    Para restaurar el acceso completo a IPV Gestión, es necesario regularizar tu pago.</p><div style="margin-top: 25px; text-align: center;"><p style="margin: 0 0 15px 0; font-size: 1em; color: var(--text-secondary);"><strong>Siguientes pasos:</strong></p><a href="https://wa.me/5355189657" target="_blank" style="display: inline-block; padding: 12px 25px; background-color: #25D366; color: white; text-decoration: none; border-radius: 8px; font-weight: bold; font-size: 1.1em; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px;">
    Contactar y Pagar</a><div style="border-top: 1px solid var(--border-glass); padding-top: 20px;"><button data-action="check-payment-status" style="display: inline-block; padding: 10px 20px; background-color: transparent; color: var(--primary-cyan); border: 1px solid var(--primary-cyan); border-radius: 8px; font-weight: bold; font-size: 1em; cursor: pointer; transition: all 0.2s ease;">
    Ya pagué, verificar acceso</button><p style="font-size: 0.85em; color: var(--text-secondary); margin-top: 10px;">Haz clic aquí después de confirmar el pago.</p></div></div></div></div>

<div id="businessAdminModal" class="modal">
    <div class="modal-backdrop"></div>
    <div class="modal-content" style="max-width: 800px;">
        <span class="close">&times;</span>
        <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-glass); padding-bottom: 15px; margin-bottom: 15px;">
            <h2 class="modal-title" style="margin: 0; padding: 0; border: none;">Panel de Trabajadores</h2>
            <button class="btn-modal btn-primary" data-action="add-worker-prompt">Añadir Trabajador</button>
        </div>
        <p class="modal-message">Desactiva el acceso a tus trabajadores. Esta acción es permanente y no se puede deshacer desde esta pantalla.</p>
        <div class="modal-scrollable-content">
            <table class="responsive-table">
                <thead>
                <tr>
                    <th>Trabajador</th>
                    <th>Estado</th>
                    <th>Última Conexión</th>
                    <th>Acciones</th>
                </tr>
                </thead>
                <tbody id="workers-list-tbody">
                <!-- Filas generadas por JS -->
                </tbody>
            </table>
        </div>
    </div>
</div>
<!-- Modal de Confirmación de Actualización de Costos -->
<div id="costUpdateModal" class="modal">
    <div class="modal-backdrop"></div>
    <div class="modal-content" style="max-width: 500px;">
        <span class="close" data-action="closeCostModal">&times;</span>
        <h2>Actualización de Costos</h2>
        <p class="modal-message">Se han detectado diferencias con el Almacén Central. Revisa los cambios antes de aplicar:</p>
        
        <!-- Aquí se insertará la lista dinámica -->
        <div id="costUpdateList" class="modal-scrollable-content" style="max-height: 300px; margin-bottom: 20px;"></div>
        
        <div class="modal-actions">
            <button class="btn-modal btn-secondary" data-action="closeCostModal">Cancelar</button>
            <button class="btn-modal btn-primary" data-action="confirmCostUpdate">Confirmar Cambios</button>
        </div>
    </div>
</div>

<!-- MODAL DE BORRADOR DE CONTEO -->
<div id="draftModal" class="modal">
    <div class="modal-backdrop"></div>
    <div class="modal-content" style="max-width: 900px; height: 90vh;">
        <span class="close">&times;</span>
        
        <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-glass); padding-bottom: 15px; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
            <div>
                <h2 class="modal-title" style="margin: 0;">📝 Borrador de Conteo</h2>
                <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">
                    Los cambios se guardan en este dispositivo automáticamente.
                </p>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn-modal btn-secondary" onclick="clearDraftData()">🗑️ Limpiar Borrador</button>
                <button class="btn-modal btn-primary" onclick="applyAllDraftCounts()">✅ Aplicar TODO al IPV</button>
            </div>
        </div>

        <div class="modal-scrollable-content">
            <table class="responsive-table" id="draft-table">
                <thead>
                    <tr>
                        <th style="width: 40%;">Producto</th>
                        <th style="width: 15%;">Sistema</th>
                        <th style="width: 25%;">Conteo Físico</th>
                        <th style="width: 20%;">Acción</th>
                    </tr>
                </thead>
                <tbody id="draft-table-body">
                    <!-- Se llena con JS -->
                </tbody>
            </table>
        </div>
    </div>
</div>
<!-- Librerías para generar PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<!-- Librería de Encriptación -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<!-- Lógica Principal de la App -->
<script>

(function() { 
    const APP_VERSION = "3.4 - Smart Autocomplete"; 

    // =========================================================
    // CONFIGURACIÓN DEL PIN DE ADMINISTRADOR (ESTÁTICO)
    // =========================================================
    const STATIC_ADMIN_PIN = "8608"; 
    // =========================================================

    // --- FUNCIÓN PUENTE PARA NOTIFICACIONES ANDROID ---
    function sendAndroidNotification(title, message) {
        if (typeof window.AndroidApp !== 'undefined' && window.AndroidApp.showNotification) {
            window.AndroidApp.showNotification(title, message);
        } else {
            console.log("Notificación (Simulada):", title, message);
        }
    }

    // --- CONFIGURACIÓN DE API ---
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxXPrYOX3BqE8aBqVzTNO7pfjw6oWm1a90nu9gDXjA8cs-tl_8Q1SEFQI4suSoS-K0MZQ/exec';

    async function apiCall(body) {
        try {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'cors',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(body),
                redirect: 'follow'
            });
            if (!response.ok) {
                throw new Error(`Error de red: ${response.statusText}`);
            }
            return await response.json();
        } catch (error) {
            console.error("Error en apiCall:", error);
            throw error;
        }
    }

    const DeviceManager = {
        getDeviceId: function() {
            let deviceId = localStorage.getItem('ipv_device_id');
            if (!deviceId) {
                deviceId = generateUUID(); 
                localStorage.setItem('ipv_device_id', deviceId);
            }
            return deviceId;
        }
    };

    const ApiClient = {
        login: (businessName, password) => apiCall({ action: 'login', businessName, password }),
        workerLogin: (businessName, workerName, workerPin, deviceId) => apiCall({ action: 'workerLogin', businessName, workerName, workerPin, deviceId }),
        createWorker: (businessName, password, newWorkerName, newWorkerPin) => apiCall({ action: 'createWorker', businessName, password, newWorkerName, newWorkerPin }),
        getWorkers: (businessName, password) => apiCall({ action: 'getWorkers', businessName, password }),
        deleteWorker: (businessName, password, workerId) => apiCall({ action: 'deleteWorker', businessName, password, workerId }),
        createBusiness: (businessName, password, adminEmail, enableEncryption, encryptedSecretKey) => apiCall({ action: 'create', businessName, password, adminEmail, enableEncryption, encryptedSecretKey }),
        deleteBusiness: (businessName, creationKey) => apiCall({ action: 'deleteBusiness', businessName, creationKey }),
        getDailyData: (businessName, password, date) => apiCall({ action: 'getDailyData', businessName, password, date }),
        sync: (businessName, password, date, dataToSync) => apiCall({ action: 'sync', businessName, password, date, dataToSync }),
        getHistoricalData: (businessName, password) => apiCall({ action: 'getHistoricalData', businessName, password }),
        checkStatus: (businessName) => apiCall({ action: 'checkStatus', businessName }),
        verifyAdminPin: (businessName, password, pin) => apiCall({ action: 'verifyAdminPin', businessName, password, pin }),
        setAdminPin: (businessName, password, newPin, oldPin) => apiCall({ action: 'setAdminPin', businessName, password, newPin, oldPin }),
        changePassword: (businessName, oldPassword, newPassword) => apiCall({ action: 'changePassword', businessName, oldPassword, newPassword }),
        getEncryptedSecretKey: (businessName, password) => apiCall({ action: 'getEncryptedSecretKey', businessName, password }),
        updateEncryptedSecretKey: (businessName, password, newEncryptedSecretKey) => apiCall({ action: 'updateEncryptedSecretKey', businessName, password, newEncryptedSecretKey }),
        getWarehouseData: (businessName, password) => apiCall({ action: 'getWarehouseData', businessName, password })
    };

    const StatusChecker = {
        intervalId: null,
        async check() {
            if (!Session.businessName || Session.businessName === "local_mode") return;
            try {
                const response = await apiCall({ action: 'checkStatus', businessName: Session.businessName });
                if (response.status === 'success') {
                    this.unlockScreen();
                    localStorage.removeItem('ipv_lock_status');

                    const lastShownMessage = sessionStorage.getItem('ipv_last_shown_message');

                    if (response.message && response.message !== lastShownMessage) {
                        showAlert(response.message, "Mensaje del Administrador");
                        sendAndroidNotification("Mensaje Administrativo", response.message);
                        sessionStorage.setItem('ipv_last_shown_message', response.message);

                    } else if (!response.message && lastShownMessage) {
                        sessionStorage.removeItem('ipv_last_shown_message');
                    }
                }
            } catch (error) {
                console.error("Error durante el chequeo de estado:", error);
            }
        },
        lockScreen(message) { console.log("Intento de bloqueo ignorado"); },
        unlockScreen() {
            const modal = document.getElementById('payment-lock-modal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }
        },
        start() {
            this.check();
            if (this.intervalId) clearInterval(this.intervalId);
            this.intervalId = setInterval(() => this.check(), 30000);
        },
        stop() {
            if (this.intervalId) {
                clearInterval(this.intervalId);
                this.intervalId = null;
            }
        }
    };

    // --- MODALES Y UTILIDADES ---
    function toggleModal(modalId, show) {
        const modal = document.getElementById(modalId);
        if (!modal) return;
        modal.style.display = show ? 'flex' : 'none';
        document.body.style.overflow = show ? 'hidden' : '';
    }
    
    function showAlert(message, title = 'Alerta', options = {}) {
        return new Promise(resolve => {
            const modal = document.getElementById('alertModal');
            const titleEl = document.getElementById('alertTitle');
            const messageEl = document.getElementById('alertMessage');
            const okButton = document.getElementById('alertOkButton');
            if (!modal || !titleEl || !messageEl || !okButton) { alert(message); return resolve(); }
            modal.className = 'modal'; 
            if (options.className) modal.classList.add(options.className);
            const modalContent = modal.querySelector('.modal-content');
            modalContent.style.padding = '';
            titleEl.style.display = '';
            okButton.style.display = '';
            let isHTML = false;
            let finalContent = '';
            if (typeof message === 'string') {
                const trimmedMessage = message.trim();
                if (trimmedMessage.startsWith('<div') || trimmedMessage.startsWith('<style')) {
                    isHTML = true; finalContent = trimmedMessage;
                } else {
                    finalContent = escapeHtml(trimmedMessage).replace(/\n/g, '<br>');
                }
            }
            messageEl.innerHTML = finalContent;
            titleEl.textContent = title;
            if (isHTML) {
                modal.classList.add('html-content-modal');
                modalContent.style.padding = '0'; titleEl.style.display = 'none'; okButton.style.display = 'none';
            }
            const controller = new AbortController();
            const signal = controller.signal;
            const closeHandler = () => { toggleModal('alertModal', false); modal.className = 'modal'; controller.abort(); resolve(); };
            okButton.addEventListener('click', closeHandler, { signal });
            modal.querySelector('.modal-backdrop').addEventListener('click', closeHandler, { signal });
            modal.querySelector('.close').addEventListener('click', closeHandler, { signal });
            toggleModal('alertModal', true);
            if (!isHTML) { okButton.focus(); }
        });
    }

    function showConfirm(message, title = 'Confirmación') {
        return new Promise(resolve => {
            const modal = document.getElementById('confirmModal');
            const titleEl = document.getElementById('confirmTitle');
            const messageEl = document.getElementById('confirmMessage');
            const yesButton = document.getElementById('confirmYes');
            const noButton = document.getElementById('confirmNo');
            if (!modal || !titleEl || !messageEl || !yesButton || !noButton) return resolve(confirm(message));
            titleEl.textContent = title;
            messageEl.textContent = message;
            const controller = new AbortController();
            const cleanupAndResolve = (value) => { toggleModal('confirmModal', false); controller.abort(); resolve(value); };
            yesButton.addEventListener('click', () => cleanupAndResolve(true), { signal: controller.signal });
            noButton.addEventListener('click', () => cleanupAndResolve(false), { signal: controller.signal });
            modal.querySelector('.modal-backdrop').addEventListener('click', () => cleanupAndResolve(false), { signal: controller.signal });
            modal.querySelector('.close').addEventListener('click', () => cleanupAndResolve(false), { signal: controller.signal });
            toggleModal('confirmModal', true);
            yesButton.focus();
        });
    }

    function showPrompt(message, title = 'Entrada Requerida', inputType = 'text', isRequired = true) { 
        return new Promise(resolve => {
            const modal = document.getElementById('promptModal');
            const titleEl = document.getElementById('promptTitle');
            const messageEl = document.getElementById('promptMessage');
            const inputEl = document.getElementById('promptInput');
            const formEl = document.getElementById('promptForm');
            const cancelButton = document.getElementById('promptCancel');
            if (!modal || !titleEl || !messageEl || !inputEl || !formEl) return resolve(prompt(message));
            titleEl.textContent = title;
            messageEl.textContent = message;
            inputEl.value = '';
            inputEl.type = inputType;
            if (isRequired) { inputEl.setAttribute('required', 'required'); } else { inputEl.removeAttribute('required'); }
            const controller = new AbortController();
            const cleanupAndResolve = (value) => { toggleModal('promptModal', false); inputEl.type = 'text'; inputEl.setAttribute('required', 'required'); controller.abort(); resolve(value); };
            formEl.addEventListener('submit', (e) => { e.preventDefault(); cleanupAndResolve(inputEl.value); }, { signal: controller.signal });
            cancelButton.addEventListener('click', () => cleanupAndResolve(null), { signal: controller.signal });
            modal.querySelector('.modal-backdrop').addEventListener('click', () => cleanupAndResolve(null), { signal: controller.signal });
            modal.querySelector('.close').addEventListener('click', () => cleanupAndResolve(null), { signal: controller.signal });
            toggleModal('promptModal', true);
            inputEl.focus();
        });
    }

    // --- SESSION ---
    const Session = {
        businessName: null,
        password: null,
        encryptionKey: null,
        isAdmin: localStorage.getItem('ipv_isAdmin') === 'true',
        isOwner: false,
        currentDate: new Date().toISOString().split('T')[0],
        setAdmin(status) { this.isAdmin = status; if (status) { localStorage.setItem('ipv_isAdmin', 'true'); } else { localStorage.removeItem('ipv_isAdmin'); } },
        save() { if (this.encryptionKey) { sessionStorage.setItem('ipv_encryption_key', this.encryptionKey); } localStorage.setItem('ipv_session', JSON.stringify({ businessName: this.businessName, password: this.password })); },
        load() { this.encryptionKey = sessionStorage.getItem('ipv_encryption_key'); const saved = localStorage.getItem('ipv_session'); if (saved) { try { const sessionData = JSON.parse(saved); if (typeof sessionData.businessName === 'string' && sessionData.businessName.length > 0) { this.businessName = sessionData.businessName; this.password = sessionData.password; this.isAdmin = localStorage.getItem('ipv_isAdmin') === 'true'; return true; } } catch (e) { this.clear(); } } return false; },
        clear() { this.businessName = null; this.password = null; this.encryptionKey = null; this.isOwner = false; this.setAdmin(false); localStorage.removeItem('ipv_session'); localStorage.removeItem('ipv_last_selected_date'); localStorage.removeItem('ipv_is_owner'); sessionStorage.removeItem('ipv_encryption_key'); sessionStorage.removeItem('ipv_worker_name'); }
    };

    // --- UTILS ---
    async function hashString(text) {
        const encoder = new TextEncoder();
        const data = encoder.encode(text);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }
    function encryptData(data, key) { if (!key) return JSON.stringify(data); try { const jsonString = JSON.stringify(data); return CryptoJS.AES.encrypt(jsonString, key).toString(); } catch (e) { console.error("Error al encriptar datos:", e); return null; } }
    function decryptData(encryptedData, key) { if (!key) { try { return JSON.parse(encryptedData); } catch (e) { return null; } } try { const bytes = CryptoJS.AES.decrypt(encryptedData, key); const decryptedString = bytes.toString(CryptoJS.enc.Utf8); if (!decryptedString) { return { error: "invalid_key" }; } return JSON.parse(decryptedString); } catch (e) { console.error("Error al desencriptar:", e); return { error: "decryption_failed" }; } }
    function generateUUID() { return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c => (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)); }
    function getAllHistoricalData(currentBusinessName) { const all = []; const prefix = `ipv_data_${currentBusinessName}_`; for (const key in localStorage) { if (key.startsWith(prefix)) { try { all.push({ date: key.replace(prefix, ''), data: JSON.parse(localStorage.getItem(key)) }); } catch (e) { console.error(`Error parseando datos locales para ${key}`, e); } } } all.sort((a, b) => new Date(b.date) - new Date(a.date)); return all; }
    function getFilteredHistoricalData(startDate, endDate, currentBusinessName) { const allData = getAllHistoricalData(currentBusinessName); if (!startDate && !endDate) return allData; const start = startDate ? new Date(startDate + 'T00:00:00Z') : null; const end = endDate ? new Date(endDate + 'T23:59:59Z') : null; return allData.filter(day => { const itemDate = new Date(day.date + 'T12:00:00Z'); return (!start || itemDate >= start) && (!end || itemDate <= end); }); }
    function normalizeData(data, businessName) { if (!data || !data.products) return data; const ID_MAP_KEY = `ipv_id_map_${businessName}`; let idMap = JSON.parse(localStorage.getItem(ID_MAP_KEY)) || {}; let mapWasModified = false; const productConsolidationMap = new Map(); (data.products || []).forEach(p => { if (!p || !p.name) return; const isInvalidId = !p.id || typeof p.id !== 'string' || p.id.length < 15; let finalId = p.id; if (isInvalidId) { const oldIdKey = String(p.id); if (idMap[oldIdKey]) { finalId = idMap[oldIdKey]; } else { const newId = generateUUID(); idMap[oldIdKey] = newId; finalId = newId; mapWasModified = true; } } p.id = finalId; const existingProduct = productConsolidationMap.get(p.id); if (!existingProduct || new Date(p.lastModified || 0) > new Date(existingProduct.lastModified || 0)) { if (p.isActive === undefined) p.isActive = true; productConsolidationMap.set(p.id, p); } }); if (mapWasModified) localStorage.setItem(ID_MAP_KEY, JSON.stringify(idMap)); data.products = Array.from(productConsolidationMap.values()); return data; }
    async function createNewDayDataFromPrevious(Session) {
    const { businessName, password, currentDate } = Session;
    
    // Intentar buscar hasta 30 días atrás
    for (let i = 1; i <= 30; i++) {
        const d = new Date(currentDate + "T12:00:00Z");
        d.setUTCDate(d.getUTCDate() - i);
        const searchDate = d.toISOString().split("T")[0];
        
        console.log(`Buscando datos válidos en: ${searchDate}`);

        // 1. Intentar LocalStorage
        const prevStorageKey = `ipv_data_${businessName}_${searchDate}`;
        let foundData = null;
        try {
            const rawLocal = JSON.parse(localStorage.getItem(prevStorageKey));
            foundData = unwrapDataRecursively(rawLocal);
        } catch (e) {}

        // 2. Si no hay local, intentar Nube
        if ((!foundData || !foundData.products || foundData.products.length === 0) && navigator.onLine && businessName !== "local_mode") {
            try {
                const response = await ApiClient.getDailyData(businessName, password, searchDate);
                if (response.status === "success" && response.data) {
                    let cloudData = response.data;
                    if (cloudData.isEncrypted) {
                        const decrypted = decryptData(cloudData.payload, Session.encryptionKey);
                        if (decrypted && !decrypted.error) cloudData = decrypted;
                        else cloudData = null;
                    }
                    foundData = unwrapDataRecursively(cloudData);
                }
            } catch (e) {
                console.error("Error buscando en nube:", e);
            }
        }

        // 3. Si encontramos datos válidos
        if (foundData && foundData.products && foundData.products.length > 0) {
            console.log(`¡Datos encontrados en ${searchDate}!`);

            // === LÓGICA PARA OBTENER EL NOMBRE DEL DÍA ===
            // Creamos una fecha a mediodía para evitar errores de zona horaria
            const dateObj = new Date(searchDate + "T12:00:00");
            // Obtenemos el nombre del día en español (ej: "viernes")
            const dayName = dateObj.toLocaleDateString('es-ES', { weekday: 'long' });
            // Ponemos la primera letra en mayúscula (ej: "Viernes")
            const dayNameCap = dayName.charAt(0).toUpperCase() + dayName.slice(1);
            // =============================================

            // Ocultamos el cargando
            hideLoading(); 

            await showAlert(
                `<div style="text-align: center; padding: 10px;">
                    <div style="font-size: 3.5rem; margin-bottom: 15px; animation: pulse 2s infinite;">🛡️</div>
                    
                    <h3 style="color: #FFD600; font-size: 1.4rem; text-transform: uppercase; letter-spacing: 1px; margin: 0 0 15px 0; border-bottom: 1px solid rgba(255, 214, 0, 0.3); padding-bottom: 10px;">
                        Restauración Automática
                    </h3>
                    
                    <p style="color: #E0E5FF; font-size: 1rem; line-height: 1.6; margin-bottom: 20px;">
                        No se encontraron datos de ayer. El sistema recuperó el inventario del último cierre disponible:
                    </p>
                    
                    <!-- CAJA DE FECHA CON EL NOMBRE DEL DÍA -->
                    <div style="background: rgba(0, 224, 255, 0.08); border: 1px solid rgba(0, 224, 255, 0.3); border-radius: 12px; padding: 15px; box-shadow: 0 0 20px rgba(0, 224, 255, 0.15);">
                        
                        <!-- Aquí mostramos el día (Ej: Viernes) -->
                        <div style="font-size: 1.2rem; color: #FFFFFF; font-weight: bold; text-transform: uppercase; margin-bottom: 5px; text-shadow: 0 0 5px rgba(255,255,255,0.5);">
                            ${dayNameCap}
                        </div>

                        <!-- Aquí mostramos la fecha numérica -->
                        <strong style="font-size: 1.5rem; color: #00E0FF; font-family: 'Roboto Mono', monospace; text-shadow: 0 0 10px rgba(0, 224, 255, 0.5);">
                            ${searchDate}
                        </strong>
                    </div>
                </div>`, 
                "" 
            );
            
            showLoading("Aplicando inventario...");

            const prods = foundData.products.filter(p => p.isActive !== false).map(p => {
                const finalValue = (typeof p.finales === 'number') ? p.finales : (p.start || 0);
                return {
                    ...p,
                    start: finalValue,
                    entrada: 0,
                    finales: finalValue,
                    lastModified: new Date().toISOString()
                };
            });
            
            return {
                products: prods,
                gastos: [],
                // Agregamos también el nombre del día a las notas
                notas: `✅ RESTAURADO AUTOMÁTICAMENTE DESDE EL: ${dayNameCap} ${searchDate}`,
                categories: foundData.categories || [],
                predefinedNotes: {},
                pizzaCalcs: {},
                isClosed: false
            };
        }
    }

    console.log("No se encontraron datos previos. Iniciando en blanco.");
    const predefinedCategories = ['Aseo personal', 'Bebidas', 'Carnicos', 'Confituras Variadas', 'Dulces', 'Enlatados', 'Galletas', 'Nevera', 'Pastas', 'Peter', 'Rones', 'Sazones'];
    return { products: [], gastos: [], notas: "Inicio de sistema sin datos previos.", categories: predefinedCategories, predefinedNotes: {}, pizzaCalcs: {}, isClosed: false };
}
    // --- LOGIC & STATE ---
    function calculateProductMetrics(product) { const start = Number(product.start || 0); const entrada = Number(product.entrada || 0); const cost = Number(product.cost || 0); const price = Number(product.price || 0); const vendido = (typeof product.finales === 'number') ? Math.max(0, start + entrada - product.finales) : 0; const importe = vendido * price; const ganancias = importe - (vendido * cost); return { ...product, vendido, importe, ganancias }; }
    function calculateTotals(appData) { 
        if (!appData) return {}; 
        const { products = [], gastos = [] } = appData; 
        const totals = { totalImporte: 0, totalGanancias: 0, totalStockCost: 0, totalStockValue: 0, gastosOperativos: 0, recogidas: 0 }; 
        const categoriasIgnoradas = ['insumos', 'materia prima', 'uso interno', 'cocina', 'no venta', 'insumointerno']; 
        
        (products || []).filter(p => p.isActive !== false).forEach(p => { 
            const metrics = calculateProductMetrics(p); 
            const finales = typeof p.finales === 'number' ? p.finales : (p.start || 0); 
            const cat = (p.category || '').toLowerCase().trim(); 
            const esInsumo = categoriasIgnoradas.includes(cat); 
            
            // Los insumos no se suman al costo del stock ni al valor de stock de venta porque no se venden
            totals.totalStockCost += finales * (p.cost || 0); 
            if (!esInsumo) { 
                totals.totalImporte += metrics.importe; 
                totals.totalGanancias += metrics.ganancias; 
                totals.totalStockValue += finales * (p.price || 0); 
            } 
        }); 
        
        (gastos || []).filter(g => g.isActive !== false).forEach(g => { 
            if (g.type === 'recogida') totals.recogidas += g.amount || 0; 
            else totals.gastosOperativos += g.amount || 0; 
        }); 
        
        totals.gananciaNetaOperativa = totals.totalGanancias - totals.gastosOperativos; 
        totals.efectivoTeoricoCaja = totals.totalImporte - totals.gastosOperativos - totals.recogidas; 
        return totals; 
    }
    
    let appData = {}; let subscribers = [];
    const StateManager = { subscribe(callback) { subscribers.push(callback); }, _notify() { subscribers.forEach(callback => callback(structuredClone(appData))); }, getState() { return structuredClone(appData); }, setState(data) { appData = data || {}; this._notify(); }, triggerUpdate() { this._notify(); }, updateProductFieldById(productId, field, value) { if (appData.isClosed) return; let parsedValue = value; if (field === 'finales') parsedValue = value === '' ? null : Number(value); else if (['start', 'entrada'].includes(field)) parsedValue = Number(value) || 0; else if (['cost', 'price'].includes(field)) parsedValue = parseFloat(value) || 0; const newProducts = (appData.products || []).map(p => (String(p.id) === String(productId)) ? { ...p, [field]: parsedValue, lastModified: new Date().toISOString() } : p); appData = { ...appData, products: newProducts }; this._notify(); }, addProduct(details) { const newProducts = details.names.map(name => { const startValue = Number(details.start) || 0; return { id: generateUUID(), name, category: details.category, start: startValue, cost: Number(details.cost) || 0, price: Number(details.price) || 0, entrada: 0, finales: startValue, isActive: true, lastModified: new Date().toISOString() }; }); const updatedProducts = [...(appData.products || []), ...newProducts]; const updatedCategories = details.category && !(appData.categories || []).includes(details.category) ? [...(appData.categories || []), details.category] : (appData.categories || []); appData = { ...appData, products: updatedProducts, categories: updatedCategories }; this._notify(); }, addGasto(description, amount, type) { const newGasto = { id: generateUUID(), description, amount, type: type || 'gasto', isActive: true, lastModified: new Date().toISOString() }; appData = { ...appData, gastos: [...(appData.gastos || []), newGasto] }; this._notify(); }, deleteProductById(id) { appData = { ...appData, products: (appData.products || []).map(p => (String(p.id) === String(id)) ? { ...p, isActive: false, lastModified: new Date().toISOString() } : p) }; this._notify(); }, deleteSelectedProducts(ids) { appData = { ...appData, products: (appData.products || []).map(p => ids.has(String(p.id)) ? { ...p, isActive: false, lastModified: new Date().toISOString() } : p) }; this._notify(); }, deleteGastoById(id) { appData = { ...appData, gastos: (appData.gastos || []).map(g => (String(g.id) === String(id)) ? { ...g, isActive: false, lastModified: new Date().toISOString() } : g) }; this._notify(); }, closeDay() { appData = { ...appData, isClosed: true }; this._notify(); }, updateNotes(notes) { if (appData.notas !== notes) { appData = { ...appData, notas: notes }; this._notify(); } }, updateDiferenciaCaja(tipo, monto) { const montoVal = tipo === 'ninguna' ? 0 : parseFloat(monto) || 0; appData = { ...appData, predefinedNotes: { ...(appData.predefinedNotes || {}), diferenciaCaja: { tipo, monto: montoVal } } }; this._notify(); }, updatePizzaCalcs(pizzaData) { appData = { ...appData, pizzaCalcs: { ...pizzaData, lastModified: new Date().toISOString() } }; this._notify(); } };

    // --- UI ---
    let collapsedCategories = new Set(); let areAllCategoriesCollapsed = false; let isZeroStockHidden = false; const PREDEFINED_CATEGORIES = ['Aseo personal', 'Bebidas', 'Carnicos', 'Confituras Variadas', 'Dulces', 'Enlatados', 'Galletas', 'Nevera', 'Pastas', 'Peter', 'Rones', 'Sazones', 'Insumos'];
    const DOM = { appVersion: document.getElementById('app-version-display'), loadingOverlay: document.getElementById('loadingOverlay'), loadingMessage: document.getElementById('loadingMessage'), syncIndicator: document.getElementById('sync-indicator'), syncButton: document.getElementById('syncButton'), loginForm: document.getElementById('loginForm'), createForm: document.getElementById('createForm'), loginWrapper: document.getElementById('login-screen-wrapper'), header: document.getElementById('header'), container: document.getElementById('container'), businessTitle: document.getElementById('businessTitle'), notasDia: document.getElementById('notas-dia'), diferenciaTipo: document.getElementById('note-diferencia-tipo'), diferenciaMonto: document.getElementById('note-diferencia-monto'), productList: document.getElementById('product-list'), gastosList: document.getElementById('gastos-list'), totalImporte: document.getElementById("total-importe"), totalGanancias: document.getElementById("total-ganancias"), totalGastosOperativos: document.getElementById("total-gastos-operativos"), gananciaNetaOperativa: document.getElementById("ganancia-neta-operativa"), totalRecogidas: document.getElementById("total-recogidas"), efectivoTeoricoCaja: document.getElementById("efectivo-teorico-caja"), totalStockCost: document.getElementById("total-stock-cost"), totalStockValue: document.getElementById("total-stock-value"), categoryDropdown: document.getElementById('modal-product-category'), totalProductsCount: document.getElementById('total-products-count'), zeroStockCount: document.getElementById('zero-stock-count'), };
    
    function setAppVersion(version) { if (DOM.appVersion) DOM.appVersion.textContent = `Versión ${version}`; }
    function showLoading(msg) { if (DOM.loadingMessage) DOM.loadingMessage.textContent = msg || 'Procesando...'; if (DOM.loadingOverlay) DOM.loadingOverlay.style.display = 'flex'; }
    function hideLoading() { if (DOM.loadingOverlay) DOM.loadingOverlay.style.display = 'none'; }
    
    // --- LÓGICA DE NOTIFICACIONES MODIFICADA PARA ANDROID ---
    let hasNotifiedChanges = false; 

    function updateSyncIndicator(hasChanges, isSyncing = false) {
        if (DOM.syncIndicator) {
            DOM.syncIndicator.style.backgroundColor = isSyncing ? '#3498db' : (hasChanges ? '#f39c12' : '#28a745');
            DOM.syncIndicator.title = isSyncing ? 'Sincronizando...' : (hasChanges ? 'Cambios locales pendientes' : 'Sincronizado');
        }
        if (DOM.syncButton) DOM.syncButton.textContent = isSyncing ? 'Sincronizando...' : 'Sincronizar';

        // Disparo de notificaciones nativas
        if (isSyncing) {
            // No notificamos mientras sincroniza
        } else if (hasChanges) {
            if (!hasNotifiedChanges) {
                sendAndroidNotification("Sincronización Pendiente", "Tienes datos locales sin guardar en la nube. Toca Sincronizar.");
                hasNotifiedChanges = true;
            }
        } else {
            // Si ya no hay cambios (se completó la sync), reiniciamos el flag
            if (hasNotifiedChanges) {
                sendAndroidNotification("Sincronizado", "Todos tus datos se han guardado en la nube.");
                hasNotifiedChanges = false;
            }
        }
    }

    function switchLoginView(showCreate) { DOM.loginForm?.classList.toggle('hidden', showCreate); DOM.createForm?.classList.toggle('hidden', !showCreate); }
    function showMainApp() { DOM.loginWrapper?.classList.add('hidden'); DOM.header?.classList.remove('hidden'); DOM.container?.classList.remove('hidden'); }
    function showLoginScreen() { DOM.loginWrapper?.classList.remove('hidden'); DOM.header?.classList.add('hidden'); DOM.container?.classList.add('hidden'); }
    
    function renderApp(data, session) { 
        if (!data || !session || !session.businessName) return; 
        DOM.businessTitle.textContent = `IPV - ${session.businessName.replace(/_/g, ' ')}`; 
        if (DOM.notasDia && document.activeElement !== DOM.notasDia) { DOM.notasDia.value = data.notas || ''; } 
        const diferencia = data.predefinedNotes?.diferenciaCaja || { tipo: 'ninguna', monto: 0 }; 
        if (DOM.diferenciaTipo) { DOM.diferenciaTipo.value = diferencia.tipo; } 
        if (DOM.diferenciaMonto) { DOM.diferenciaMonto.value = diferencia.monto || ''; DOM.diferenciaMonto.disabled = data.isClosed || diferencia.tipo === 'ninguna'; } 
        renderProductTable(data.products || [], session.isAdmin, data.isClosed); 
        renderInsumosList(data.products || [], data.isClosed); // RENDERIZAR LISTA DE INSUMOS
        renderGastosList(data.gastos || [], data.isClosed); 
        renderTotals(data); 
        updateAdminVisibility(session.isAdmin); 
        populateCategoryDropdown(data.categories); 
    }

    function renderProductTable(products, isAdmin, isClosed) { 
        const tbody = DOM.productList; 
        if (!tbody) return; 
        // FILTRO: No mostrar Insumos Internos en la tabla principal
        let activeProducts = (products || []).filter(p => p.isActive !== false && p.category !== 'InsumoInterno'); 
        if (isZeroStockHidden) { activeProducts = activeProducts.filter(p => p.finales !== 0); } 
        const totalCount = activeProducts.length; 
        const zeroStockCount = activeProducts.filter(p => p.finales === 0).length; 
        if (DOM.totalProductsCount) { DOM.totalProductsCount.textContent = totalCount > 0 ? `(${totalCount})` : ''; } 
        if (DOM.zeroStockCount) { DOM.zeroStockCount.textContent = zeroStockCount > 0 ? `(${zeroStockCount})` : ''; } 
        if (activeProducts.length === 0) { tbody.innerHTML = `<tr><td colspan="11" style="text-align:center;padding:20px;">No hay productos que coincidan con los filtros.</td></tr>`; return; } 
        const productsByCategory = activeProducts.reduce((acc, p) => { (acc[p.category || "General"] = acc[p.category || "General"] || []).push(p); return acc; }, {}); 
        const sortedCategories = Object.keys(productsByCategory).sort((a, b) => a.localeCompare(b)); 
        tbody.innerHTML = ""; 
        sortedCategories.forEach(category => { 
            const isCollapsed = collapsedCategories.has(category); 
            const catRow = tbody.insertRow(); 
            catRow.className = "category-row"; 
            catRow.innerHTML = `<td colspan="11"><span class="toggle-icon">${isCollapsed ? "►" : "▼"}</span>${category}</td>`; 
            catRow.addEventListener('click', () => toggleCategory(category)); 
            productsByCategory[category].sort((a, b) => a.name.localeCompare(b.name)).forEach(p => { 
                const row = createProductRow(p, isAdmin, isClosed); 
                if (isCollapsed) row.classList.add('hidden'); 
                tbody.appendChild(row); 
            }); 
        }); 
    }

    function renderInsumosList(products, isClosed) {
        const listDiv = document.getElementById('insumos-list');
        if (!listDiv) return;
        listDiv.innerHTML = '';
        
        // Filtramos SOLO los insumos internos
        const insumos = (products || []).filter(p => p.isActive !== false && p.category === 'InsumoInterno');
        
        if (insumos.length === 0) {
            listDiv.innerHTML = '<p style="text-align:center; color: var(--text-secondary); font-style:italic;">No hay insumos retirados hoy.</p>';
            return;
        }

        const disabledAttr = isClosed ? 'disabled' : '';

        insumos.forEach(p => {
            const item = document.createElement('div');
            item.className = 'gasto-item';
            // Estilo visual diferenciado (borde azul cian en vez de magenta de gastos)
            item.style.borderLeft = '3px solid var(--primary-cyan)'; 
            
            item.innerHTML = `
                <span>
                    ${escapeHtml(p.name)} 
                    <span class="gasto-tag" style="background: rgba(0, 224, 255, 0.2); color: var(--primary-cyan);">
                        Retirado: ${p.entrada}
                    </span>
                </span>
                <button class="delete-button" data-action="deleteProduct" data-product-id="${p.id}" ${disabledAttr}>
                    &times;
                </button>
            `;
            listDiv.appendChild(item);
        });
    }

    function createProductRow(product, isAdmin, isClosed) { const row = document.createElement('tr'); row.dataset.productId = product.id; row.dataset.category = product.category || 'General'; const p = calculateProductMetrics(product); if (typeof p.finales === 'number' && p.finales > (Number(p.start || 0) + Number(p.entrada || 0))) { row.classList.add('fila-error'); } else if (typeof p.finales === 'number' && p.finales === 0) { row.classList.add('fila-stock-cero'); } const finalesDisplayValue = (p.finales === null || p.finales === undefined) ? '' : p.finales; const disabledAttr = isClosed ? 'disabled' : ''; let stockIndicator = ''; if (typeof getCachedWarehouseProduct === 'function') { const whData = getCachedWarehouseProduct(p.name); if (whData) { const stock = Number(whData.stock || 0); let colorClass = 'wh-ok'; if (stock <= 0) colorClass = 'wh-empty'; else if (stock < (whData.minStock || 5)) colorClass = 'wh-low'; stockIndicator = `<span class="wh-indicator ${colorClass}" data-stock="Almacén: ${stock} uds."></span>`; } } row.innerHTML = `<td><input type="checkbox" class="product-select-checkbox" ${disabledAttr}></td><td><div class="name-cell-wrapper"><span class="name-cell-text" title="${escapeHtml(p.name)}">${escapeHtml(p.name)}</span>${stockIndicator}</div></td><td><input type="number" value="${p.start}" data-field="start" data-product-id="${p.id}" ${disabledAttr}></td><td><input type="number" value="${p.entrada}" data-field="entrada" data-product-id="${p.id}" ${disabledAttr}></td><td><input type="number" value="${finalesDisplayValue}" data-field="finales" data-product-id="${p.id}" ${disabledAttr}></td><td>${p.vendido}</td><td class="admin-only"><input type="number" step="0.01" value="${(p.cost || 0).toFixed(2)}" data-field="cost" data-product-id="${p.id}" ${disabledAttr}></td><td><input type="number" step="0.01" value="${(p.price || 0).toFixed(2)}" data-field="price" data-product-id="${p.id}" ${disabledAttr}></td><td>${p.importe.toFixed(2)}</td><td class="admin-only">${p.ganancias.toFixed(2)}</td><td><button class="delete-button" data-action="deleteProduct" ${disabledAttr}>&times;</button></td>`; return row; }
    function renderGastosList(gastos, isClosed) { const listDiv = DOM.gastosList; listDiv.innerHTML = ''; const disabledAttr = isClosed ? 'disabled' : ''; (gastos || []).filter(g => g.isActive !== false).forEach((g) => { const item = document.createElement('div'); item.className = 'gasto-item'; const type = g.type || 'gasto'; const tagText = type === 'recogida' ? 'Recogida' : 'Gasto'; item.innerHTML = `<span>${escapeHtml(g.description || '')} <span class="gasto-tag gasto-type--${type}">${tagText}</span></span><span>$${(g.amount || 0).toFixed(2)}</span><button class="delete-button" data-action="deleteGasto" data-gasto-id="${g.id}" ${disabledAttr}>&times;</button>`; listDiv.appendChild(item); }); }
    function renderTotals(data) { const totals = calculateTotals(data); DOM.totalImporte.textContent = (totals.totalImporte || 0).toFixed(2); DOM.totalGanancias.textContent = (totals.totalGanancias || 0).toFixed(2); DOM.totalGastosOperativos.textContent = (totals.gastosOperativos || 0).toFixed(2); DOM.gananciaNetaOperativa.textContent = (totals.gananciaNetaOperativa || 0).toFixed(2); DOM.totalRecogidas.textContent = (totals.recogidas || 0).toFixed(2); DOM.efectivoTeoricoCaja.textContent = (totals.efectivoTeoricoCaja || 0).toFixed(2); DOM.totalStockCost.textContent = (totals.totalStockCost || 0).toFixed(2); DOM.totalStockValue.textContent = (totals.totalStockValue || 0).toFixed(2); }
    function updateAdminVisibility(isAdmin) { document.querySelectorAll(".admin-toggle-btn").forEach(btn => btn.classList.toggle("admin-active", isAdmin)); DOM.header?.classList.toggle("admin-mode-active", isAdmin); document.querySelectorAll(".admin-only-row").forEach(el => el.classList.toggle("hidden", !isAdmin)); document.querySelectorAll(".admin-only").forEach(el => el.classList.toggle("hidden", !isAdmin)); }
    function filterProducts(term) { const lowerCaseTerm = term.toLowerCase(); document.querySelectorAll('#product-list tr:not(.category-row)').forEach(row => { row.style.display = (row.cells[1]?.textContent.toLowerCase() || '').includes(lowerCaseTerm) ? '' : 'none'; }); }
    function populateCategoryDropdown(categories) { const select = DOM.categoryDropdown; if (!select) return; const baseList = ["General", "Insumos", ...PREDEFINED_CATEGORIES, ...(categories || [])]; const allCategories = [...new Set(baseList)].sort((a, b) => a.localeCompare(b)); select.innerHTML = allCategories.map(c => { if (c === 'Insumos') { return `<option value="${c}" style="color: #FFD600; font-weight: bold; background: rgba(255, 214, 0, 0.1);">${c} (No consta en los Totales)</option>`; } return `<option value="${c}">${c}</option>`; }).join(''); }
    function toggleCategory(category) { collapsedCategories.has(category) ? collapsedCategories.delete(category) : collapsedCategories.add(category); areAllCategoriesCollapsed = false; renderApp(StateManager.getState(), Session); }
    function toggleAllCategories() { areAllCategoriesCollapsed = !areAllCategoriesCollapsed; const allCategoriesFromState = new Set((StateManager.getState().products || []).filter(p => p.isActive !== false).map(p => p.category || 'General')); collapsedCategories = areAllCategoriesCollapsed ? new Set(allCategoriesFromState) : new Set(); renderApp(StateManager.getState(), Session); }
    function getSelectedProductIds() { const ids = new Set(); document.querySelectorAll('.product-select-checkbox:checked').forEach(checkbox => { const row = checkbox.closest('tr'); if (row && row.dataset.productId) ids.add(row.dataset.productId); }); return ids; }
    function toggleAllCheckboxes(checked) { document.querySelectorAll('.product-select-checkbox').forEach(checkbox => checkbox.checked = checked); }
    function escapeHtml(str) { return String(str).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;').replaceAll("'", '&#039;'); }
    function renderZeroStockList(products) { const list = document.getElementById('zeroStockList'); const copyBtn = document.getElementById('copyZeroStockBtn'); if (products.length > 0) { list.innerHTML = products.map(p => `<li>${escapeHtml(p.name)}</li>`).join(''); if (copyBtn) copyBtn.disabled = false; } else { list.innerHTML = '<li>No hay productos con stock cero.</li>'; if (copyBtn) copyBtn.disabled = true; } }
    function renderZeroCostList(products) { const container = document.getElementById('zeroCostListContainer'); container.innerHTML = products.length > 0 ? products.map(p => `<div class="gasto-item">${escapeHtml(p.name)} (Categoría: ${p.category})</div>`).join('') : '<p>¡Excelente! Todos los productos tienen un costo asignado.</p>'; }
    function renderAuditResults(history, productName) { const container = document.getElementById('audit-results'); if (history.length === 0) { container.innerHTML = `<p>No se encontraron registros para "${productName}".</p>`; return; } const metricsHistory = history.map(item => ({ ...item, product: calculateProductMetrics(item.product) })); let html = `<h4>Historial para "${escapeHtml(productName)}":</h4>`; metricsHistory.forEach(item => { html += `<div class="summary-card"><strong>${item.date}</strong><br>Inicio: ${item.product.start}, Entrada: ${item.product.entrada}, Final: ${item.product.finales ?? 'N/A'}<br>Vendido: ${item.product.vendido}, Importe: $${(item.product.importe || 0).toFixed(2)}</div>`; }); container.innerHTML = html; }
    function renderFinancialSummary(totals, dateInfo, isAdmin) { const container = document.getElementById('summary-content'); container.innerHTML = `<div class="summary-card"><h4>Ingresos Brutos</h4><p>$${totals.ingresos.toFixed(2)}</p></div><div class="summary-card"><h4>Gastos Totales</h4><p>$${totals.gastos.toFixed(2)}</p></div><div class="summary-card admin-only-row" style="display: ${isAdmin ? 'block' : 'none'}"><h4>Ganancia Bruta</h4><p>$${totals.ganancias.toFixed(2)}</p></div><div class="summary-card"><h4>Balance Neto</h4><p>$${(totals.ingresos - totals.gastos).toFixed(2)}</p></div><p style="text-align:center; font-size: 0.9em; color: var(--text-muted);">Resultados para ${dateInfo.dayCount} día(s).</p>`; }
    function renderPerformanceReport(reportData, start, end, isAdmin) { const container = document.getElementById('performance-content'); const sortedByVendido = [...reportData].sort((a, b) => b.totalVendido - a.totalVendido); const sortedByImporte = [...reportData].sort((a, b) => b.totalImporte - a.totalImporte); const sortedByGanancias = [...reportData].sort((a, b) => b.totalGanancias - a.totalGanancias); const renderList = (title, data, key) => `<h4>${title}</h4>${data.slice(0, 10).map(p => `<div class="gasto-item"><span>${escapeHtml(p.name)}</span><strong>${key === 'totalVendido' ? p[key] : '$' + p[key].toFixed(2)}</strong></div>`).join('') || '<p>No hay datos.</p>'}`; container.innerHTML = `<p style="text-align:center;">Mostrando reporte desde ${start} hasta ${end}</p><div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;"><div>${renderList('🏆 Top 10 Más Vendidos (Unidades)', sortedByVendido, 'totalVendido')}</div><div>${renderList('💰 Top 10 Más Ingresos', sortedByImporte, 'totalImporte')}</div><div class="admin-only-row" style="display: ${isAdmin ? 'block' : 'none'}">${renderList('💹 Top 10 Más Rentables', sortedByGanancias, 'totalGanancias')}</div></div>`; }
    function renderComparisonReport(data, dates, isAdmin) { const container = document.getElementById('comparison-results'); const { periodA, periodB } = data; const comparisonRow = (label, valA, valB) => { const diff = valB - valA; const percent = valA !== 0 ? (diff / Math.abs(valA)) * 100 : (valB > 0 ? 100 : 0); const color = diff >= 0 ? 'var(--success-color)' : 'var(--danger-color)'; const icon = diff >= 0 ? '▲' : '▼'; return `<div class="summary-card"><h4>${label}</h4><div style="display:flex; justify-content: space-between; align-items: center; flex-wrap: wrap;"><span>A: $${valA.toFixed(2)}</span><span>B: $${valB.toFixed(2)}</span><strong style="color:${color};">${icon} ${diff.toFixed(2)} (${percent.toFixed(1)}%)</strong></div></div>`; }; container.innerHTML = `<p style="text-align:center;"><strong>Periodo A:</strong> ${dates.a_start} a ${dates.a_end} (${periodA.dias} días) <br><strong>Periodo B:</strong> ${dates.b_start} a ${dates.b_end} (${periodB.dias} días)</p>${comparisonRow('Ingresos', periodA.ingresos, periodB.ingresos)}${comparisonRow('Gastos', periodA.gastos, periodB.gastos)}<div class="admin-only-row" style="display: ${isAdmin ? 'block' : 'none'}">${comparisonRow('Ganancias', periodA.ganancias, periodB.ganancias)}</div>`; }
    function renderWorkersDashboard(workers) { const tbody = document.getElementById('workers-list-tbody'); tbody.innerHTML = ''; if (!workers || workers.length === 0) { tbody.innerHTML = '<tr><td colspan="4">No hay trabajadores registrados. El primero que inicie sesión con un PIN quedará registrado.</td></tr>'; return; } workers.forEach(w => { const row = document.createElement('tr'); let actionsHtml = '<span>Acceso revocado</span>'; if (w.isActive) { actionsHtml = `<button class="btn-modal" style="background: var(--danger-color); color: white;" data-action="revoke-worker" data-worker-id="${w.workerId}">Desactivar</button>`; } row.innerHTML = `<td>${escapeHtml(w.name)}</td><td style="color: ${w.isActive ? 'var(--success-color)' : 'var(--danger-color)'}; font-weight: bold;">${w.isActive ? 'ACTIVO' : 'INACTIVO'}</td><td>${w.lastSeen}</td><td>${actionsHtml}</td>`; tbody.appendChild(row); }); }

    // --- CALCULATORS ---
    let billCounterHistory = []; const MAX_HIST = 10;
    function initializeCalculators(ui) { initializeStandardCalculator(); initializeBillCounter(ui); return { loadPizzaData: initializePizzaCalculator() }; }
    function initializeStandardCalculator() { const modal = document.getElementById('calculatorModal'); if (!modal) return; class Calculator { constructor(previousOperandEl, currentOperandEl) { this.previousOperandEl = previousOperandEl; this.currentOperandEl = currentOperandEl; this.clear(); } clear() { this.currentOperand = ''; this.previousOperand = ''; this.operation = undefined; this.updateDisplay(); } delete() { this.currentOperand = this.currentOperand.toString().slice(0, -1) || '0'; this.updateDisplay(); } appendNumber(number) { if (number === '.' && this.currentOperand.includes('.')) return; if (this.currentOperand === '0' && number !== '.') this.currentOperand = ''; this.currentOperand += number.toString(); } chooseOperation(operation) { if (this.currentOperand === '') return; if (this.previousOperand !== '') this.compute(); this.operation = operation; this.previousOperand = this.currentOperand; this.currentOperand = ''; } compute() { let computation; const prev = parseFloat(this.previousOperand); const current = parseFloat(this.currentOperand); if (isNaN(prev) || isNaN(current)) return; switch (this.operation) { case '+': computation = prev + current; break; case '-': computation = prev - current; break; case '×': computation = prev * current; break; case '÷': computation = prev / current; break; default: return; } this.currentOperand = computation; this.operation = undefined; this.previousOperand = ''; } getDisplayNumber(number) { const stringNumber = number.toString(); const integerDigits = parseFloat(stringNumber.split('.')[0]); const decimalDigits = stringNumber.split('.')[1]; let integerDisplay = isNaN(integerDigits) ? '' : integerDigits.toLocaleString('en', { maximumFractionDigits: 0 }); return decimalDigits != null ? `${integerDisplay}.${decimalDigits}` : integerDisplay; } updateDisplay() { this.currentOperandEl.innerText = this.getDisplayNumber(this.currentOperand) || '0'; this.previousOperandEl.innerText = this.operation != null ? `${this.getDisplayNumber(this.previousOperand)} ${this.operation}` : ''; } } const calculator = new Calculator(modal.querySelector('#calcPrevious'), modal.querySelector('#calcCurrent')); modal.querySelectorAll('[data-action]').forEach(button => button.addEventListener('click', () => { const { action } = button.dataset; const text = button.innerText; if (action === 'number') calculator.appendNumber(text); else if (action === 'operator') calculator.chooseOperation(text); else if (action === 'equals') calculator.compute(); else if (action === 'clear') calculator.clear(); else if (action === 'delete') calculator.delete(); calculator.updateDisplay(); })); }
    function initializeBillCounter(ui) { const modal = document.getElementById('billCounterModal'); if (!modal) return; const inputs = modal.querySelectorAll('input[type="number"]'); const toggles = modal.querySelectorAll('.bill-toggle'); loadBillCounterData(); inputs.forEach(i => { i.addEventListener('input', () => { saveBillInput(i); updateBillTotals(); }); i.addEventListener('click', () => i.select()); }); toggles.forEach(t => t.addEventListener('change', () => { updateBillRowStyle(t); saveBillToggle(t); updateBillTotals(); })); }
    function handleBillCounterActions(action, ui) { switch(action) { case 'bc_save': saveBillHistory(); break; case 'bc_history': showBillHistory(ui); break; case 'bc_clear_prompt': ui.toggleModal('bc_confirmModal', true); break; case 'bc_confirm_clear': clearBillCounter(ui); break; case 'bc_cancel_clear': ui.toggleModal('bc_confirmModal', false); break; } }
    function updateBillTotals() { const modal = document.getElementById('billCounterModal'); if (!modal) return; let active = 0, inactive = 0; const inputs = modal.querySelectorAll('input[type="number"]'); inputs.forEach(i => { const den = parseInt(i.id.replace('bc_bill', '')); const count = parseInt(i.value) || 0; const toggle = modal.querySelector(`#bc_toggle${den}`); const sub = den * count; modal.querySelector(`#bc_total${den}`).textContent = `$${sub.toLocaleString('es-MX')}`; if (toggle.checked) active += sub; else inactive += sub; }); const grand = active + inactive; modal.querySelector('#bc_total').textContent = `Activos: $${active.toLocaleString('es-MX')}`; modal.querySelector('#bc_inactiveTotal').textContent = `Inactivos: $${inactive.toLocaleString('es-MX')}`; modal.querySelector('#bc_grandTotal').textContent = `Total: $${grand.toLocaleString('es-MX')}`; modal.querySelector('[data-action="bc_save"]').disabled = grand === 0; }
    function loadBillCounterData() { const modal = document.getElementById('billCounterModal'); if (!modal) return; const inputs = modal.querySelectorAll('input[type="number"]'); inputs.forEach(i => { i.value = localStorage.getItem(i.id) || '0'; const toggle = modal.querySelector(`#bc_toggle${i.id.replace('bc_bill', '')}`); const savedState = localStorage.getItem(toggle.id); if (savedState !== null) toggle.checked = savedState === 'true'; updateBillRowStyle(toggle); }); billCounterHistory = JSON.parse(localStorage.getItem('billCounterHistory') || '[]'); updateBillTotals(); }
    function saveBillInput(inputElement) { localStorage.setItem(inputElement.id, inputElement.value); }
    function saveBillToggle(toggleElement) { localStorage.setItem(toggleElement.id, toggleElement.checked); }
    function updateBillRowStyle(toggle) { const row = document.getElementById(`bc_row${toggle.id.replace('bc_toggle', '')}`); if(row) row.classList.toggle('inactive', !toggle.checked); }
    function saveBillHistory() { const modal = document.getElementById('billCounterModal'); if (!modal) return; const details = []; let active = 0, inactive = 0; const inputs = modal.querySelectorAll('input[type="number"]'); inputs.forEach(i => { const den = parseInt(i.id.replace('bc_bill', '')); const count = parseInt(i.value) || 0; const toggle = modal.querySelector(`#bc_toggle${den}`); if (count > 0) details.push({ den, count, sub: den * count, isActive: toggle.checked }); if (toggle.checked) active += den * count; else inactive += den * count; }); if (details.length === 0) { showAlert("No hay nada que guardar."); return; } billCounterHistory.unshift({ id: Date.now(), date: new Date().toLocaleString('es-MX'), active, inactive, grand: active + inactive, details }); if (billCounterHistory.length > MAX_HIST) billCounterHistory.pop(); localStorage.setItem('billCounterHistory', JSON.stringify(billCounterHistory)); showAlert('Conteo guardado.'); }
    function showBillHistory(ui) { const list = document.getElementById('bc_historyList'); list.innerHTML = billCounterHistory.length === 0 ? '<li>No hay historial.</li>' : ''; billCounterHistory.forEach(e => { const li = document.createElement('li'); li.dataset.id = e.id; li.innerHTML = `<span class="date">${e.date}</span><span class="total">$${e.grand.toLocaleString('es-MX')}</span>`; li.addEventListener('click', () => showBillDetail(e.id, ui)); list.appendChild(li); }); ui.toggleModal('bc_historyModal', true); }
    function showBillDetail(id, ui) { const entry = billCounterHistory.find(h => h.id.toString() === id.toString()); if (!entry) return; const content = document.getElementById('bc_historyDetailContent'); let rows = entry.details.map(d => `<tr><td>${d.isActive ? 'Activo' : 'Inactivo'}</td><td>$${d.den.toLocaleString('es-MX')}</td><td>${d.count}</td><td>$${d.sub.toLocaleString('es-MX')}</td></tr>`).join(''); content.innerHTML = `<p><strong>Fecha:</strong> ${entry.date}</p><table><thead><tr><th>Estado</th><th>Denom.</th><th>Cant.</th><th>Subtotal</th></tr></thead><tbody>${rows}</tbody></table><div class="detail-totals"><p><strong>Total Activo:</strong> $${entry.active.toLocaleString('es-MX')}</p><p><strong>Total Inactivo:</strong> $${entry.inactive.toLocaleString('es-MX')}</p><p><strong>Total General:</strong> $${entry.grand.toLocaleString('es-MX')}</p></div>`; ui.toggleModal('bc_historyDetailModal', true); }
    function clearBillCounter(ui) { const modal = document.getElementById('billCounterModal'); if (!modal) return; const inputs = modal.querySelectorAll('input[type="number"]'); const toggles = modal.querySelectorAll('.bill-toggle'); inputs.forEach(i => { i.value = 0; localStorage.removeItem(i.id); }); toggles.forEach(t => { t.checked = true; localStorage.removeItem(t.id); updateBillRowStyle(t); }); updateBillTotals(); ui.toggleModal('bc_confirmModal', false); }
    function calculatePizzaMetrics(inputs) { const getVal = key => parseFloat(inputs[key]) || 0; const totalOtrosGastos = getVal('costoCarbon') + getVal('costoLevadura') + getVal('costoGrasa') + getVal('costoColor') + getVal('costoPolvoreo') + getVal('costoOtros'); const calculos = { totalOtrosGastos }; const inversionBasePizza = (getVal('jarrosHarina') * getVal('costoJarro')) + (getVal('librasQueso') * getVal('costoQueso')) + getVal('manoObra') + totalOtrosGastos; const ventasBasePizza = getVal('precioVenta') * getVal('cantidadPizzas'); calculos.gananciaPizza = ventasBasePizza - inversionBasePizza; const inversionJamon = getVal('librasJamon') * getVal('costoJamon'); const ventasJamon = getVal('cantidadPizzasJamon') * getVal('precioVentaJamon'); calculos.gananciaJamon = ventasJamon - inversionJamon; const inversionSalchicha = getVal('unidadesSalchicha') * getVal('costoUnidadSalchicha'); const ventasSalchicha = getVal('cantidadRacionesVendidas') * getVal('precioVentaRacion'); calculos.gananciaSalchicha = ventasSalchicha - inversionSalchicha; calculos.inversionTotal = inversionBasePizza + inversionJamon + inversionSalchicha; calculos.ventasTotales = ventasBasePizza + ventasJamon + ventasSalchicha; calculos.gananciaTotalBruta = calculos.gananciaPizza + calculos.gananciaJamon + calculos.gananciaSalchicha; calculos.costoPorPizza = getVal('cantidadPizzas') > 0 ? inversionBasePizza / getVal('cantidadPizzas') : 0; calculos.pizzasPorLibraQueso = getVal('librasQueso') > 0 ? getVal('cantidadPizzas') / getVal('librasQueso') : 0; calculos.pizzasPorJarroHarina = getVal('jarrosHarina') > 0 ? getVal('cantidadPizzas') / getVal('jarrosHarina') : 0; return calculos; }
    function displayPizzaResults(datos, destino) { if (!destino) return; if (!datos || (!datos.inversionTotal && !datos.ventasTotales)) { destino.innerHTML = `<p class="hint-text">Rellena los campos para ver los resultados.</p>`; return; } const p = v => parseFloat(v || 0).toFixed(2); destino.innerHTML = `<div class="result-grid"><div class="total-box grand-total income"><h3>Ganancia Total Bruta</h3><p>$${p(datos.gananciaTotalBruta)}</p></div><div class="total-box grand-total balance"><h3>Total Efectivo (Ventas)</h3><p>$${p(datos.ventasTotales)}</p></div><div class="total-box grand-total expense"><h3>Inversión Total</h3><p>$${p(datos.inversionTotal)}</p></div></div><hr class="result-divider"><h4>Desglose de Ganancias</h4><div class="result-grid"><div class="total-box small income"><h5>Ganancia (Pizza Base)</h5><p>$${p(datos.gananciaPizza)}</p></div><div class="total-box small income"><h5>Ganancia (Jamón)</h5><p>$${p(datos.gananciaJamon)}</p></div><div class="total-box small income"><h5>Ganancia (Salchicha)</h5><p>$${p(datos.gananciaSalchicha)}</p></div></div><hr class="result-divider"><h4>Métricas por Pizza</h4><div class="result-grid"><div class="total-box small expense"><h5>Costo por Pizza</h5><p>$${p(datos.costoPorPizza)}</p></div><div class="total-box small info"><h5>Pizzas / Lb Queso</h5><p>${p(datos.pizzasPorLibraQueso)}</p></div><div class="total-box small info"><h5>Pizzas / Jarro Harina</h5><p>${p(datos.pizzasPorJarroHarina)}</p></div></div>`; }
    function displayPizzaSummaryPreview(datos, destino) { if (!destino) return; if (!datos || (!datos.inversionTotal && !datos.ventasTotales && !datos.gananciaTotalBruta)) { destino.innerHTML = ''; return; } const p = v => parseFloat(v || 0).toFixed(2); destino.innerHTML = `<div class="summary-preview-item income"><span>Ganancia</span><strong>$${p(datos.gananciaTotalBruta)}</strong></div><div class="summary-preview-item balance"><span>Ventas</span><strong>$${p(datos.ventasTotales)}</strong></div><div class="summary-preview-item expense"><span>Inversión</span><strong>$${p(datos.inversionTotal)}</strong></div>`; }
    function initializePizzaCalculator() { const section = document.getElementById('pizza-calculator-section'); if (!section) return () => {}; const inputElements = [...section.querySelectorAll('input[type="number"]')].reduce((obj, input) => { obj[input.id.replace('pizza-', '')] = input; return obj; }, {}); const totalGastosPEl = document.querySelector('#pizza-total-gastos p'); const resultsContainer = document.querySelector('#pizza-results-container'); const summaryPreviewEl = document.querySelector('#pizza-summary-preview'); const readInputsFromDOM = () => Object.keys(inputElements).reduce((obj, key) => { obj[key] = inputElements[key].value; return obj; }, {}); function orchestrateCalculationAndDisplay() { const inputsData = readInputsFromDOM(); const results = calculatePizzaMetrics(inputsData); if (totalGastosPEl) { totalGastosPEl.textContent = `$${results.totalOtrosGastos.toFixed(2)}`; } displayPizzaResults(results, resultsContainer); displayPizzaSummaryPreview(results, summaryPreviewEl); return { inputs: inputsData, results }; } function calculateAndSave() { const { inputs, results } = orchestrateCalculationAndDisplay(); StateManager.updatePizzaCalcs({ inputs, results }); } async function clearPizzaForm() { if (await showConfirm("¿Borrar todos los campos de la calculadora de pizzas?")) { for (const key in inputElements) { if(inputElements[key]) inputElements[key].value = ''; } calculateAndSave(); } } document.getElementById('pizza-clear-btn')?.addEventListener('click', clearPizzaForm); Object.values(inputElements).forEach(input => input.addEventListener('input', calculateAndSave)); ['jamon', 'salchicha'].forEach(type => { const toggleButton = document.getElementById(`pizza-toggle-${type}`); const contentSection = document.getElementById(`pizza-${type}-section`); if (toggleButton && contentSection) { toggleButton.addEventListener('click', e => { const btn = e.currentTarget; const isOpen = contentSection.style.display !== 'none'; contentSection.style.display = isOpen ? 'none' : 'block'; btn.classList.toggle('active', !isOpen); }); } }); return (appData) => { const pizzaData = appData.pizzaCalcs; for (const key in inputElements) { if (inputElements[key]) { inputElements[key].value = (pizzaData?.inputs?.[key]) || ''; } } orchestrateCalculationAndDisplay(); }; }

    // --- ACTIONS & HANDLERS ---
    let Session_ReportHandlers; function init(session) { Session_ReportHandlers = session; }
    function handleAuditCosts() { const zeroCostProducts = StateManager.getState().products.filter(p => p.isActive !== false && (p.cost === 0 || p.cost === null || p.cost === undefined)); renderZeroCostList(zeroCostProducts); toggleModal('zeroCostModal', true); }
    async function runProductAudit() { const productName = document.getElementById('audit-product-name').value.trim().toLowerCase(); if (!productName) return showAlert('Por favor, escribe el nombre de un producto.'); showLoading('Buscando en el historial...'); const allData = getAllHistoricalData(Session_ReportHandlers.businessName); const history = []; allData.forEach(day => { (day.data.products || []).forEach(p => { if (p.name.toLowerCase().includes(productName)) { history.push({ date: day.date, product: p }); } }); }); renderAuditResults(history, productName); hideLoading(); }
    async function handleCopyReport() { const data = StateManager.getState(); const totals = calculateDayTotals(data); let report = `📋 REPORTE DEL DÍA: ${Session_ReportHandlers.currentDate}\n🧑‍💼 Dependiente: ${data.user || 'No asignado'}\n================================\n\n📊 RESUMEN FINANCIERO\n  - Ingresos Brutos: $${totals.totalImporte.toFixed(2)}\n`; if (Session_ReportHandlers.isAdmin) { report += `  - Ganancia Bruta (Productos): $${totals.totalGanancias.toFixed(2)}\n  - Gastos Operativos: $${totals.gastosOperativos.toFixed(2)}\n  - Ganancia Neta: $${totals.gananciaNetaOperativa.toFixed(2)}\n`; } report += `  - Total Recogidas: $${totals.recogidas.toFixed(2)}\n  - Efectivo en Caja (Teórico): $${totals.efectivoTeoricoCaja.toFixed(2)}\n\n📦 VENTAS DETALLADAS\n`; (data.products || []).forEach(p => { const metrics = calculateProductMetrics(p); if (p.isActive !== false && metrics.vendido > 0) { report += `  - ${p.name}: ${metrics.vendido} x $${p.price.toFixed(2)} = $${metrics.importe.toFixed(2)}\n`; } }); report += `\n`; const activeGastos = (data.gastos || []).filter(g => g.isActive !== false); const gastosOperativos = activeGastos.filter(g => g.type !== 'recogida'); const recogidas = activeGastos.filter(g => g.type === 'recogida'); if (gastosOperativos.length > 0) { report += `💸 GASTOS OPERATIVOS\n`; gastosOperativos.forEach(g => { report += `  - ${g.description}: $${g.amount.toFixed(2)}\n`; }); report += `\n`; } if (recogidas.length > 0) { report += `💰 RECOGIDAS DE EFECTIVO\n`; recogidas.forEach(g => { report += `  - ${g.description}: $${g.amount.toFixed(2)}\n`; }); report += `\n`; } if (data.notas) { report += `📝 NOTAS ADICIONALES\n${data.notas}\n\n`; } report += `================================\nSistema de Gestión IPV`; navigator.clipboard.writeText(report).then(() => showAlert("Reporte copiado al portapapeles."), () => showAlert("Error al copiar el reporte.")); }
    function handleExportDay() { const data = StateManager.getState(); const dataStr = JSON.stringify(data, null, 2); const blob = new Blob([dataStr], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `ipv_data_${Session_ReportHandlers.businessName}_${Session_ReportHandlers.currentDate}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }
    // --- FUNCIÓN PARA GENERAR PDF DE CONTEO ---
// --- FUNCIÓN PDF DOBLE COLUMNA (ESTRATEGIA DE GRUPOS) ---
async function handleGenerateStockPDF() {
    if (!window.jspdf) return showAlert("Librerías PDF no cargadas.");

    showLoading("Generando PDF...");

    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        const state = StateManager.getState();
        
        // 1. Filtrar productos
        const activeProducts = (state.products || [])
            .filter(p => p.isActive !== false && p.finales > 0)
            .sort((a, b) => a.name.localeCompare(b.name));

        if (activeProducts.length === 0) {
            hideLoading();
            return showAlert("No hay productos con stock.");
        }

        // --- CONFIGURACIÓN ESTRICTA ---
        // Reducimos a 55 para asegurar que no salte de página automáticamente
        const ROWS_PER_COLUMN = 55; 
        
        // Dividimos los productos en "grupos" de 55
        const chunks = [];
        for (let i = 0; i < activeProducts.length; i += ROWS_PER_COLUMN) {
            chunks.push(activeProducts.slice(i, i + ROWS_PER_COLUMN));
        }

        // --- FUNCIÓN PARA DIBUJAR UNA COLUMNA ---
        const drawTable = (data, xPos, yPos) => {
            doc.autoTable({
                startY: yPos,
                margin: { left: xPos },
                tableWidth: 92,
                head: [['PRODUCTO', 'STOCK', 'FISICO']],
                body: data.map(p => [
                    p.name.substring(0, 32), 
                    p.finales.toString(),
                    "" 
                ]),
                theme: 'grid',
                styles: { 
                    fontSize: 7.5,
                    cellPadding: 0.8, 
                    valign: 'middle',
                    lineColor: [150, 150, 150],
                    lineWidth: 0.1,
                    minCellHeight: 4.2
                },
                headStyles: {
                    fillColor: [220, 220, 220],
                    textColor: [0, 0, 0],
                    fontStyle: 'bold',
                    fontSize: 7,
                    halign: 'center'
                },
                columnStyles: {
                    0: { cellWidth: 'auto', halign: 'left' }, 
                    1: { cellWidth: 12, halign: 'center', fontStyle: 'bold' }, 
                    2: { cellWidth: 15 } 
                },
                // IMPORTANTE: Esto evita que la librería intente paginar por su cuenta
                pageBreak: 'avoid',
                showHead: 'everyPage'
            });
        };

        // --- BUCLE DE LLENADO ---
        let pageNumber = 1;
        
        // Recorremos los grupos (chunks)
        chunks.forEach((chunk, index) => {
            // Un índice par (0, 2, 4...) va a la IZQUIERDA
            // Un índice impar (1, 3, 5...) va a la DERECHA
            const isLeftColumn = index % 2 === 0;

            // Si es columna izquierda y NO es el primer grupo, necesitamos nueva hoja
            if (isLeftColumn && index > 0) {
                doc.addPage();
                pageNumber++;
            }

            // Encabezado (Solo lo dibujamos cuando estamos en la columna izquierda)
            if (isLeftColumn) {
                doc.setFontSize(10);
                doc.setFont("helvetica", "bold");
                doc.text(`CONTEO: ${Session.currentDate}`, 10, 8);
                doc.setFontSize(7);
                doc.setFont("helvetica", "normal");
                doc.text(`Hoja ${pageNumber} - Negocio: ${Session.businessName}`, 150, 8);
                
                // Línea separadora central (pre-dibujada para toda la hoja)
                doc.setDrawColor(200, 200, 200);
                doc.setLineWidth(0.2);
                doc.line(102, 12, 102, 285);
            }

            // Coordenadas
            const xPos = isLeftColumn ? 7 : 105;
            const yPos = 12;

            // Dibujar la tabla
            drawTable(chunk, xPos, yPos);
        });

        const filename = `Conteo_IPV_${Session.currentDate}.pdf`;
        doc.save(filename);
        
        hideLoading();
        if (!window.AndroidApp) showAlert(`PDF Generado: ${filename}`);

    } catch (error) {
        hideLoading();
        console.error(error);
        showAlert("Error PDF: " + error.message);
    }
}
    function handleImportDay() { const fileInput = document.getElementById('file-input'); fileInput.onchange = e => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = async event => { try { const importedData = JSON.parse(event.target.result); if (await showConfirm("Se cargará el archivo. Los datos actuales de este día se sobrescribirán. ¿Continuar?")) { StateManager.setState(importedData); await showAlert("Datos importados correctamente."); } } catch (err) { await showAlert("Error: El archivo no es un JSON válido."); } }; reader.readAsText(file); fileInput.value = ''; }; fileInput.click(); }
    function handleShowAbout() { const content = `<div style="text-align: center; margin-bottom: 20px;"><img src="./img/Logo.png" alt="Logo IPV" style="width: 60px; margin-bottom: 10px; filter: drop-shadow(0 0 10px var(--glow-cyan));"><h2>Gestión IPV</h2><h4 style="color: var(--text-secondary); font-weight: 500;">Versión ${APP_VERSION}</h4><p style="margin-top: 10px;">Tu asistente digital para el control de inventario, ventas y ganancias.</p><p style="font-size: 0.9em; margin-top: 5px;">Desarrollado por <strong>Erick Olivera</strong>.</p></div><div style="text-align: left;"><h4 style="color: var(--primary-cyan); border-bottom: 1px solid var(--border-glass); padding-bottom: 8px; margin-bottom: 10px;">Funcionalidades Clave</h4><ul style="list-style-type: '✓ '; padding-left: 20px; font-size: 0.95em; line-height: 1.6;"><li>Sincronización de datos en la nube.</li><li>Reportes financieros y de rendimiento.</li><li>Modo Administrador para proteger datos sensibles.</li><li>Herramientas integradas (Calculadora, Contador).</li><li>Diseño adaptable para PC, tablet o móvil.</li></ul><h4 style="color: var(--primary-cyan); border-bottom: 1px solid var(--border-glass); padding-bottom: 8px; margin-top: 20px; margin-bottom: 10px;">Últimas Actualizaciones</h4><ul style="list-style-type: '✨ '; padding-left: 20px; font-size: 0.95em; line-height: 1.6;"><li><strong>¡Nuevo!</strong> Sistema de notificaciones nativas de Android</li><li>PIN de administrador fijo y seguro</li></ul></div>`; showAlert(content, "Acerca de IPV Gestión", { className: 'promo-modal-cyber-neon' }); }
    function handleFinancialSummary(period = 'week') { const allData = getFilteredHistoricalData(null, null, Session_ReportHandlers.businessName); let totals = { ingresos: 0, gastos: 0, ganancias: 0 }; allData.forEach(day => { const dayTotals = calculateDayTotals(day.data); totals.ingresos += dayTotals.totalImporte; totals.ganancias += dayTotals.totalGanancias; totals.gastos += dayTotals.gastosOperativos; }); renderFinancialSummary(totals, { dayCount: allData.length }, Session_ReportHandlers.isAdmin); toggleModal('financialSummaryModal', true); }
    async function generatePerformanceReport() { const start = document.getElementById('perf-start-date').value; const end = document.getElementById('perf-end-date').value; if (!start || !end) return showAlert('Selecciona un rango de fechas.'); const data = getFilteredHistoricalData(start, end, Session_ReportHandlers.businessName); const productMap = new Map(); data.forEach(day => { (day.data.products || []).forEach(p => { const metrics = calculateProductMetrics(p); if (metrics.vendido > 0) { const existing = productMap.get(p.name) || { name: p.name, totalVendido: 0, totalImporte: 0, totalGanancias: 0 }; existing.totalVendido += metrics.vendido; existing.totalImporte += metrics.importe; existing.totalGanancias += metrics.ganancias; productMap.set(p.name, existing); } }); }); renderPerformanceReport(Array.from(productMap.values()), start, end, Session_ReportHandlers.isAdmin); }
    async function runComparison() { const a_start = document.getElementById('comp-a-start').value, a_end = document.getElementById('comp-a-end').value, b_start = document.getElementById('comp-b-start').value, b_end = document.getElementById('comp-b-end').value; if (!a_start || !a_end || !b_start || !b_end) return showAlert('Completa todos los rangos de fecha.'); const calculateTotalsForPeriod = (start, end) => { const data = getFilteredHistoricalData(start, end, Session_ReportHandlers.businessName); let totals = { ingresos: 0, gastos: 0, ganancias: 0, dias: data.length }; data.forEach(day => { const dayTotals = calculateDayTotals(day.data); totals.ingresos += dayTotals.totalImporte; totals.ganancias += dayTotals.totalGanancias; totals.gastos += dayTotals.gastosOperativos; }); return totals; }; renderComparisonReport({ periodA: calculateTotalsForPeriod(a_start, a_end), periodB: calculateTotalsForPeriod(b_start, b_end) }, { a_start, a_end, b_start, b_end }, Session_ReportHandlers.isAdmin); }
    const calculateDayTotals = calculateTotals;

    // --- MAIN LOGIC ---
    async function handleAddWorkerPrompt() { const newWorkerName = await showPrompt("Introduce el nombre completo del nuevo trabajador.", "Paso 1 de 2: Nombre"); if (!newWorkerName) return; const newWorkerPin = await showPrompt(`Crea un PIN de 4 o más dígitos para ${newWorkerName}.`, "Paso 2 de 2: PIN", "password"); if (!newWorkerPin || newWorkerPin.length < 4) { showAlert("El PIN es inválido. Debe tener al menos 4 dígitos."); return; } showLoading(`Creando al trabajador ${newWorkerName}...`); try { const response = await ApiClient.createWorker(Session.businessName, Session.password, newWorkerName, newWorkerPin); hideLoading(); if (response.status === 'success') { await showAlert(response.message, "Éxito"); showLoading("Actualizando panel..."); await openBusinessAdminPanel(); } else { throw new Error(response.message); } } catch (error) { hideLoading(); showAlert(`Error: ${error.message}`); } }
    async function openBusinessAdminPanel() { showLoading("Cargando lista de trabajadores..."); try { const response = await ApiClient.getWorkers(Session.businessName, Session.password); if (response.status === 'success') { renderWorkersDashboard(response.workers); toggleModal('businessAdminModal', true); } else { throw new Error(response.message); } } catch (error) { showAlert(`Error: ${error.message}`); } finally { hideLoading(); } }
    async function handleUpdateWorker(target) { const workerId = target.dataset.workerId; const workerName = target.closest('tr')?.cells[0]?.textContent || 'este trabajador'; if (await showConfirm(`¿Estás seguro de que quieres desactivar a '${workerName}'? Su acceso será revocado permanentemente.`)) { showLoading("Desactivando trabajador..."); try { const response = await ApiClient.deleteWorker(Session.businessName, Session.password, workerId); if (response.status === 'success') { await showAlert(response.message || 'Trabajador desactivado.', 'Éxito'); await openBusinessAdminPanel(); } else { throw new Error(response.message); } } catch (error) { hideLoading(); showAlert(`Error: ${error.message}`); } finally { hideLoading(); } } }
    
    // --- ESTA FUNCIÓN FALTABA O ESTABA FUERA DE ALCANCE ---
    async function handleChangePassword() { try { const oldPassword = await showPrompt("Introduce tu contraseña ACTUAL.", "Paso 1 de 3", "password"); if (oldPassword === null) return; const newPassword = await showPrompt("Introduce tu NUEVA contraseña.", "Paso 2 de 3", "password"); if (newPassword === null) return; if (!newPassword || newPassword.length < 4) return showAlert("La contraseña es muy corta.", "Error"); const confirmPassword = await showPrompt("Confirma tu NUEVA contraseña.", "Paso 3 de 3", "password"); if (confirmPassword === null) return; if (newPassword !== confirmPassword) return showAlert("Las contraseñas no coinciden.", "Error"); showLoading("Actualizando contraseña..."); const response = await ApiClient.changePassword(Session.businessName, oldPassword, newPassword); if (response.status !== 'success') { throw new Error(response.message || "No se pudo actualizar la contraseña."); } if (Session.encryptionKey) { showLoading("Re-encriptando clave de seguridad..."); const newEncryptedSecretKey = CryptoJS.AES.encrypt(Session.encryptionKey, newPassword).toString(); const updateKeyResponse = await ApiClient.updateEncryptedSecretKey(Session.businessName, newPassword, newEncryptedSecretKey); if (updateKeyResponse.status !== 'success') { throw new Error("La contraseña se cambió, pero falló la actualización de la clave de seguridad."); } } hideLoading(); Session.password = newPassword; Session.save(); await showAlert("¡Contraseña actualizada con éxito!", "Éxito"); } catch (error) { hideLoading(); await showAlert(`Error: ${error.message}`); } }

    async function handleChangePin() {
        showAlert("El PIN de administrador está definido en el código de la aplicación y no se puede cambiar desde aquí.", "Acción no permitida");
    }

    // --- FUNCIÓN MODIFICADA: VERIFICACIÓN DE PIN ESTÁTICA ---
    async function verifyPin() { 
        const pinInput = document.getElementById('pinInput'); 
        const pin = pinInput.value; 
        if (!pin) return; 

        showLoading("Verificando PIN...");
        
        // Simulación de espera para mejor experiencia
        await new Promise(r => setTimeout(r, 400));
        
        hideLoading();

        if (pin === STATIC_ADMIN_PIN) {
            Session.setAdmin(true); 
            updateAdminVisibility(true); 
            toggleModal('pinModal', false); 
            showAlert("Modo administrador activado.", "Acceso Concedido");
        } else {
            showAlert("PIN incorrecto.", "Error de Acceso");
        }
        
        pinInput.value = ''; 
    }

    async function handleLogin() { const businessName = document.getElementById('businessNameInput').value.trim(); const workerName = document.getElementById('workerNameInput').value.trim(); const passwordOrPin = document.getElementById('passwordInput').value; if (!businessName || !passwordOrPin) { return showAlert('El nombre del negocio y la contraseña/PIN son obligatorios.'); } showLoading('Iniciando sesión...'); try { let response; let isOwnerLogin = !workerName; let ownerPasswordForSession; let loggedInUserName; if (isOwnerLogin) { ownerPasswordForSession = passwordOrPin; response = await ApiClient.login(businessName, ownerPasswordForSession); if (response.status === 'success') { Session.isOwner = true; localStorage.setItem('ipv_is_owner', 'true'); loggedInUserName = "Administrador"; } } else { loggedInUserName = workerName; const deviceId = DeviceManager.getDeviceId(); response = await ApiClient.workerLogin(businessName, workerName, passwordOrPin, deviceId); if (response.status === 'success') { Session.isOwner = false; localStorage.removeItem('ipv_is_owner'); ownerPasswordForSession = response.bpHash; } } if (response.status !== 'success') { throw new Error(response.message || 'Credenciales incorrectas.'); } Session.businessName = businessName; Session.password = ownerPasswordForSession; sessionStorage.setItem('ipv_worker_name', loggedInUserName); if (isOwnerLogin) { let secretKey = localStorage.getItem(`ipv_secret_key_${businessName}`); if (!secretKey) { showLoading('Sincronizando clave de seguridad...'); const keyResponse = await ApiClient.getEncryptedSecretKey(businessName, ownerPasswordForSession); if (keyResponse.status === 'success' && keyResponse.isEncrypted && keyResponse.encryptedSecretKey) { try { const bytes = CryptoJS.AES.decrypt(keyResponse.encryptedSecretKey, ownerPasswordForSession); secretKey = bytes.toString(CryptoJS.enc.Utf8); if (!secretKey) throw new Error("Contraseña incorrecta para desencriptar."); localStorage.setItem(`ipv_secret_key_${businessName}`, secretKey); } catch (e) { throw new Error("No se pudo desencriptar la clave."); } } } if (secretKey) { Session.encryptionKey = secretKey; } } else { Session.encryptionKey = localStorage.getItem(`ipv_secret_key_${businessName}`); } Session.save(); window.location.reload(); } catch (error) { hideLoading(); showAlert(`Error al iniciar sesión: ${error.message}`); } }
    function logout() { StatusChecker.stop(); Session.clear(); sessionStorage.removeItem('ipv_worker_name'); window.location.reload(); }

    // --- ALMACEN CENTRAL & DISCREPANCIES ---
    let pendingCostUpdates = [];
    async function handleSyncWarehouseCatalog() { showLoading('Conectando con Almacén Central...'); try { const response = await ApiClient.getWarehouseData(Session.businessName, Session.password); if (response.status === 'success' && response.products) { localStorage.setItem(`ipv_warehouse_cache_${Session.businessName}`, JSON.stringify(response.products)); if (typeof updateWarehouseAutocomplete === 'function') { updateWarehouseAutocomplete(response.products); } const updates = checkCostDiscrepancies(response.products); hideLoading(); renderApp(StateManager.getState(), Session); if (updates.length > 0) { showCostUpdateModal(updates); } else { showAlert("Sincronizado correctamente. No hay cambios en los costos."); } } else { throw new Error(response.message || "No se recibieron datos."); } } catch (e) { hideLoading(); showAlert("Error al sincronizar: " + e.message); } }
   function showCostUpdateModal(updates) {
        pendingCostUpdates = updates;
        const listContainer = document.getElementById('costUpdateList');
        if (!listContainer) return;
        
        let html = `
            <div style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-glass); display:flex; align-items:center; gap: 10px;">
                <input type="checkbox" id="selectAllCosts" class="cost-update-checkbox" checked>
                <label for="selectAllCosts" style="cursor:pointer; color: var(--text-secondary); font-weight: 600;">Seleccionar Todos</label>
            </div>
        `;

        html += updates.map(u => `
            <div class="cost-change-item">
                <input type="checkbox" class="cost-update-checkbox item-cost-cb" data-id="${u.id}" checked>
                <div class="cost-change-name">${escapeHtml(u.name)}</div>
                <div class="cost-values">
                    <span class="old-cost">$${Number(u.oldCost).toFixed(2)}</span>
                    <span class="arrow-sep">➔</span>
                    <span class="new-cost">$${Number(u.newCost).toFixed(2)}</span>
                </div>
            </div>
        `).join('');

        listContainer.innerHTML = html;

        const selectAllCb = document.getElementById('selectAllCosts');
        if(selectAllCb) {
            selectAllCb.addEventListener('change', (e) => {
                const checkboxes = listContainer.querySelectorAll('.item-cost-cb');
                checkboxes.forEach(cb => cb.checked = e.target.checked);
            });
        }

        toggleModal('costUpdateModal', true);
    }
    function confirmCostUpdates() {
        const checkedBoxes = document.querySelectorAll('.item-cost-cb:checked');
        
        if (checkedBoxes.length === 0) {
            return showAlert("No has seleccionado ningún producto para actualizar.");
        }

        const selectedIds = new Set(Array.from(checkedBoxes).map(cb => cb.dataset.id));
        const updatesToApply = pendingCostUpdates.filter(u => selectedIds.has(String(u.id)));

        let count = 0;
        updatesToApply.forEach(u => {
            StateManager.updateProductFieldById(u.id, 'cost', u.newCost);
            count++;
        });

        toggleModal('costUpdateModal', false);
        
        if (count < pendingCostUpdates.length) {
            showAlert(`¡Éxito! Se actualizaron los costos de ${count} productos. (Ignorados: ${pendingCostUpdates.length - count})`);
        } else {
            showAlert(`¡Éxito! Se actualizaron los costos de ${count} productos.`);
        }
        
        pendingCostUpdates = [];
    }
    function updateWarehouseAutocomplete(whProducts) { const dataList = document.getElementById('warehouse-list'); if (!dataList) return; dataList.innerHTML = ''; whProducts.forEach(p => { const option = document.createElement('option'); option.value = p.name; option.label = `Stock: ${p.stock} | Costo: $${p.cost}`; dataList.appendChild(option); }); }
    function checkCostDiscrepancies(whProducts) { const localData = StateManager.getState(); const updates = []; const whMap = new Map(whProducts.map(p => [p.name.toLowerCase().trim(), p])); (localData.products || []).forEach(localProd => { if (localProd.isActive !== false) { const match = whMap.get(localProd.name.toLowerCase().trim()); if (match && Math.abs((localProd.cost || 0) - (match.cost || 0)) > 0.01) { updates.push({ id: localProd.id, name: localProd.name, oldCost: localProd.cost, newCost: match.cost }); } } }); return updates; }
    function getCachedWarehouseProduct(productName) { try { const raw = localStorage.getItem(`ipv_warehouse_cache_${Session.businessName}`); if (!raw) return null; const cache = JSON.parse(raw); return cache.find(p => p.name.toLowerCase().trim() === productName.toLowerCase().trim()); } catch (e) { return null; } }

    // --- NUEVA FUNCIÓN DE VALIDACIÓN DE NOMBRE ---
    function validateNameWithWarehouse(name) {
        const cache = localStorage.getItem(`ipv_warehouse_cache_${Session.businessName}`);
        if (!cache) return true; // Si no hay caché, no podemos validar, asumimos que está bien
        try {
            const products = JSON.parse(cache);
            // Buscamos coincidencia exacta (insensible a mayúsculas)
            return products.some(p => p.name.toLowerCase().trim() === name.toLowerCase().trim());
        } catch (e) {
            return true;
        }
    }

    async function handleCreateBusiness() { const businessName = document.getElementById('newBusinessName').value.trim().replace(/\s+/g, '_'); const password = document.getElementById('newPassword').value; const adminEmail = document.getElementById('newAdminEmail').value; const enableEncryption = document.getElementById('enableEncryption').checked; if (!businessName || !password || !adminEmail) { return showAlert('Todos los campos son obligatorios.'); } let encryptedSecretKey = null; if (enableEncryption) { const secretKey = generateUUID() + generateUUID(); localStorage.setItem(`ipv_secret_key_${businessName}`, secretKey); encryptedSecretKey = CryptoJS.AES.encrypt(secretKey, password).toString(); await showAlert('¡Encriptación activada!', 'Advertencia de Seguridad'); } showLoading('Creando negocio...'); try { const response = await ApiClient.createBusiness(businessName, password, adminEmail, enableEncryption, encryptedSecretKey); hideLoading(); if (response.status === 'success') { await showAlert(response.message || '¡Negocio creado con éxito! Ahora puedes iniciar sesión.'); document.getElementById('businessNameInput').value = businessName; switchLoginView(false); } else { throw new Error(response.message || 'No se pudo crear el negocio.'); } } catch (error) { hideLoading(); showAlert(`Error al crear: ${error.message}`); } }
    async function handleDeleteBusiness() { const businessName = document.getElementById('businessNameInput').value.trim(); if (!businessName) return showAlert('Por favor, escribe el nombre del negocio.'); if (!await showConfirm(`¿Estás SEGURO de que quieres eliminar "${businessName}"?`)) return; const creationKey = await showPrompt('Introduce la clave maestra para confirmar.'); if (!creationKey) return; showLoading('Eliminando negocio...'); try { const response = await ApiClient.deleteBusiness(businessName, creationKey); if (response.status === 'success') { await showAlert('Negocio eliminado.'); location.reload(); } else { throw new Error(response.message || 'Error al eliminar.'); } } catch (error) { showAlert(`Error: ${error.message}`); } finally { hideLoading(); } }
    async function toggleAdminMode() { if (Session.isAdmin) { Session.setAdmin(false); updateAdminVisibility(false); } else { toggleModal('pinModal', true); } }
    
    function startLocalMode() { Session.businessName = "local_mode"; Session.password = "local"; Session.setAdmin(true); Session.save(); window.location.reload(); }
    function changeDay(offset) { const dateInput = document.getElementById('dateInput'); const currentDate = new Date(dateInput.value + 'T12:00:00Z'); currentDate.setUTCDate(currentDate.getUTCDate() + offset); dateInput.value = currentDate.toISOString().split('T')[0]; dateInput.dispatchEvent(new Event('change')); }
    async function syncToCloud(button) { if (Session.businessName === "local_mode") return showAlert("El modo local no se sincroniza."); if (!navigator.onLine) return showAlert("Sin internet."); button.disabled = true; updateSyncIndicator(true, true); try { const dataToSync = StateManager.getState(); const encryptedPayload = encryptData(dataToSync, Session.encryptionKey); if (!encryptedPayload) throw new Error("Fallo encriptación."); const syncPayload = { isEncrypted: !!Session.encryptionKey, payload: encryptedPayload }; const response = await ApiClient.sync(Session.businessName, Session.password, Session.currentDate, syncPayload); if (response.status === 'success') { updateSyncIndicator(false); showAlert("Sincronización completada."); } else { throw new Error(response.message || 'Error servidor.'); } } catch (error) { showAlert(`Error: ${error.message}`); updateSyncIndicator(true); } finally { button.disabled = false; } }
    
    // --- MODIFICADO: Add Product con Validación ---
    async function addProduct() { 
        const namesInput = document.getElementById('modal-product-name'); 
        const names = namesInput.value.split(',').map(name => name.trim()).filter(Boolean); 
        
        if (names.length === 0) return showAlert('Introduce un nombre.'); 
        
        // Validación contra el Almacén
        const unknownProducts = names.filter(name => !validateNameWithWarehouse(name));
        
        if (unknownProducts.length > 0) {
            const msg = `Los siguientes productos no coinciden con el catálogo del Almacén:\n\n${unknownProducts.join(', ')}\n\n¿Deseas agregarlos de todas formas? (Esto podría causar duplicados)`;
            if (!(await showConfirm(msg))) {
                return; // Cancelar si el usuario dice NO
            }
        }

        StateManager.addProduct({ 
            names, 
            category: document.getElementById('modal-product-category').value, 
            start: document.getElementById('modal-product-start').value, 
            cost: document.getElementById('modal-product-cost').value, 
            price: document.getElementById('modal-product-price').value 
        }); 
        
        document.getElementById('addProductForm').reset(); 
        namesInput.focus(); 
    }

    function addGasto() { const description = document.getElementById('gastos-description').value; const amount = parseFloat(document.getElementById('gastos-amount').value); if (!description || isNaN(amount)) return showAlert('Faltan datos.'); StateManager.addGasto(description, amount, document.getElementById('gasto-type').value); toggleModal('gastos-modal', false); document.getElementById('addGastoForm').reset(); }
    async function handleDeleteProduct(target) { const productId = target.closest('tr')?.dataset.productId || target.dataset.productId; const row = target.closest('tr'); const div = target.closest('.gasto-item'); let productName = "Producto"; if (row) productName = row.cells[1].textContent; if (div) productName = div.querySelector('span').textContent.split('Retirado')[0].trim(); if (await showConfirm(`¿Eliminar "${productName}"?`)) StateManager.deleteProductById(productId); }
    async function handleDeleteGasto(target) { if (await showConfirm('¿Eliminar gasto?')) StateManager.deleteGastoById(target.dataset.gastoId); }
    async function handleDeleteSelected() { const idsToDelete = getSelectedProductIds(); if (idsToDelete.size === 0) return showAlert('Nada seleccionado.'); if (await showConfirm(`¿Eliminar ${idsToDelete.size} productos?`)) StateManager.deleteSelectedProducts(idsToDelete); }
    function handleShowZeroStock() { const zeroStockProducts = StateManager.getState().products.filter(p => p.finales === 0 && p.isActive); renderZeroStockList(zeroStockProducts); toggleModal('zeroStockModal', true); }
    function handleCopyZeroStockList() { const zeroStockProducts = StateManager.getState().products.filter(p => p.finales === 0 && p.isActive); if (zeroStockProducts.length === 0) return showAlert("Lista vacía."); const productNames = zeroStockProducts.map(p => p.name).join('\n'); navigator.clipboard.writeText(`Stock Cero:\n${productNames}`).then(() => showAlert("Copiado."), () => showAlert("Error al copiar.")); }
    async function handleResetDay() { if (await showConfirm('¿Reiniciar el día? Se borrarán entradas y finales.')) { const currentState = StateManager.getState(); const resetProducts = currentState.products.map(p => ({ ...p, entrada: 0, finales: p.start, lastModified: new Date().toISOString() })); StateManager.setState({ ...currentState, products: resetProducts, gastos: [], notas: '' }); } }
    async function handleEndOfDay() { if (await showConfirm('¿Cerrar día? No podrás editar.')) StateManager.closeDay(); }
    async function handleClearCache() { if (await showConfirm('Se borrarán datos locales. ¿Seguro?')) { const session = localStorage.getItem('ipv_session'); localStorage.clear(); if (session) localStorage.setItem('ipv_session', session); await showAlert('Caché limpia.'); location.reload(); } }
    function handleRefreshData() { loadDataForDate(Session.currentDate); }
    function toggleHideZeroStock(target) { isZeroStockHidden = !isZeroStockHidden; target.classList.toggle('active', isZeroStockHidden); const eyeIcon = document.getElementById('eye-icon'); if (eyeIcon) { eyeIcon.setAttribute('xlink:href', isZeroStockHidden ? '#icon-eye-off' : '#icon-eye'); } target.title = isZeroStockHidden ? "Mostrar todo" : "Ocultar stock cero"; renderApp(StateManager.getState(), Session); }
    async function handleManualStatusCheck() { showLoading('Verificando...'); try { await StatusChecker.check(); const modal = document.getElementById('payment-lock-modal'); if (modal && modal.style.display === 'flex') { showAlert("Acceso restringido.", "Aviso"); } } catch (error) { showAlert(`Error: ${error.message}`); } finally { hideLoading(); } }

    // --- MODIFICADO: Add Insumo con Validación ---
    async function handleAddInsumo() {
        const nameInput = document.getElementById('insumo-name');
        const qtyInput = document.getElementById('insumo-qty');
        
        const name = nameInput.value.trim();
        const qty = parseFloat(qtyInput.value);

        if (!name) return showAlert("Selecciona un insumo del almacén.");
        if (!qty || qty <= 0) return showAlert("Introduce una cantidad válida.");

        // Validación contra el Almacén
        if (!validateNameWithWarehouse(name)) {
            const msg = `El insumo "${name}" no aparece exactamente así en el catálogo del Almacén.\n\n¿Estás seguro de agregarlo con este nombre?`;
            if (!(await showConfirm(msg))) {
                return; // Cancelar si el usuario dice NO
            }
        }

        const newInsumo = {
            id: generateUUID(),
            name: name,
            category: 'InsumoInterno', 
            start: 0,
            cost: 0, 
            price: 0, 
            entrada: qty, 
            finales: 0,
            isActive: true,
            lastModified: new Date().toISOString()
        };

        const currentState = StateManager.getState();
        const updatedProducts = [...(currentState.products || []), newInsumo];
        const updatedCategories = currentState.categories || [];
        if (!updatedCategories.includes('InsumoInterno')) {
            updatedCategories.push('InsumoInterno');
        }

        StateManager.setState({ 
            ...currentState, 
            products: updatedProducts,
            categories: updatedCategories
        });

        nameInput.value = '';
        qtyInput.value = '';
        nameInput.focus();
        
        showAlert(`Retirado: ${qty} de ${name}`);
    }

    // --- HTML INJECTION FOR INSUMOS ---
    function injectInsumosHTML() {
        const existingSection = document.querySelector('#insumos-section-box');
        if(existingSection) return; 

        const container = document.getElementById('container');
        if(!container) return;

        const sections = container.querySelectorAll('.section-box');
        let referenceNode = null;
        if(sections.length > 0) {
            referenceNode = sections[0]; 
        }

        const section = document.createElement('section');
        section.className = 'section-box';
        section.id = 'insumos-section-box';
        section.innerHTML = `
            <h2>Consumo de Insumos (Descuento de Almacén)</h2>
            <p style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 15px;">
                Registra aquí materiales gastables (servilletas, cajas, nylon) para descontarlos del inventario sin afectar la venta.
            </p>
            <div id="insumos-list" class="gastos-list"></div>
            <div style="display: flex; gap: 10px; margin-top: 15px; align-items: center;">
                <div style="flex-grow: 1; position: relative;">
                    <!-- Se asegura el uso del datalist -->
                    <input type="text" id="insumo-name" class="form-input" placeholder="Nombre del insumo..." list="warehouse-list" autocomplete="off">
                </div>
                <input type="number" id="insumo-qty" class="form-input" placeholder="Cant." style="width: 80px;">
                <button id="addInsumoBtn" class="btn btn-primary" style="width: auto; padding: 10px 20px;">
                    <svg width="20" height="20" aria-hidden="true"><use xlink:href="#icon-add"></use></svg>
                </button>
            </div>
        `;

        if(referenceNode) {
            container.insertBefore(section, referenceNode);
        } else {
            container.appendChild(section);
        }
    }
function toggleTheme() {
        const isLight = document.body.classList.toggle('light-mode');
        
        // 1. Cargar CSS externo si no existe
        if (isLight && !document.getElementById('light-mode-sheet')) {
            const link = document.createElement('link');
            link.id = 'light-mode-sheet';
            link.rel = 'stylesheet';
            link.href = './light-mode.css'; // Asegúrate de que la ruta sea correcta
            document.head.appendChild(link);
        }

        // 2. Guardar preferencia
        localStorage.setItem('ipv_theme_preference', isLight ? 'light' : 'dark');
        
        // 3. Feedback visual (Opcional)
        if(typeof showAlert === 'function') {
            // Pequeña notificación no intrusiva
            const msg = isLight ? "Tema Claro Activado" : "Tema Oscuro Activado";
            // Usamos Toast nativo de Android si existe, si no, nada (para no molestar)
            if (typeof sendAndroidNotification === 'function') sendAndroidNotification("Tema", msg);
        }
    }

    // Función para inicializar el tema al cargar la app
    function initTheme() {
        const savedTheme = localStorage.getItem('ipv_theme_preference');
        if (savedTheme === 'light') {
            toggleTheme(); // Esto cargará el CSS y pondrá la clase
            // Corregir estado si toggle lo invirtió (caso raro de doble llamada)
            if(!document.body.classList.contains('light-mode')) document.body.classList.add('light-mode');
        }
    }
    const actionHandlers = { 'switchToCreate': () => switchLoginView(true), 'toggle-theme': toggleTheme, 'switchToLogin': () => switchLoginView(false), 'localMode': startLocalMode, 'deleteBusinessBtn': handleDeleteBusiness, 'addProductBtn': () => toggleModal("product-modal", true), 'deleteSelectedBtn': handleDeleteSelected, 'toggleAllBtn': toggleAllCategories, 'showZeroStockBtn': handleShowZeroStock, 'toggle-hide-zero-stock': toggleHideZeroStock, 'toggle-admin-mode': toggleAdminMode, 'openCalculatorBtn': () => toggleModal("calculatorModal", true), 'openBillCounterBtn': () => toggleModal("billCounterModal", true), 'refresh-data': handleRefreshData, 'deleteProduct': (target) => handleDeleteProduct(target), 'deleteGasto': (target) => handleDeleteGasto(target), 'addGastoBtn': () => toggleModal("gastos-modal", true), 'menu-sync-warehouse': handleSyncWarehouseCatalog, 'confirmCostUpdate': confirmCostUpdates, 'closeCostModal': () => toggleModal('costUpdateModal', false), 'menu-audit-costs': handleAuditCosts, 'menu-audit-products': () => toggleModal('dataAuditModal', true), 'menu-reset-day': handleResetDay, 'menu-end-of-day': handleEndOfDay, 'menu-clear-cache': handleClearCache, 'menu-change-pin': handleChangePin, 'menu-financial-summary': () => handleFinancialSummary(), 'menu-performance-report': () => toggleModal('performanceReportModal', true), 'menu-compare-periods': () => toggleModal('comparisonModal', true), 'menu-copy-report': handleCopyReport, 'menu-export-day': handleExportDay, 'menu-import-day': handleImportDay, 'menu-about': handleShowAbout, 'menu-change-password': handleChangePassword, 'runAuditBtn': runProductAudit, 'generatePerformanceReportBtn': generatePerformanceReport, 'runComparisonBtn': runComparison, 'copyZeroStockList': handleCopyZeroStockList, 'check-payment-status': handleManualStatusCheck, 'syncButton': (target) => syncToCloud(target), 'logoutBtn': logout, 'open-business-admin': openBusinessAdminPanel, 'toggle-worker': handleUpdateWorker, 'revoke-worker': handleUpdateWorker, 'menu-open-draft': handleOpenDraftModal, 'add-worker-prompt': handleAddWorkerPrompt };
    function setupEventListeners() { 
        document.body.addEventListener("submit", handleFormSubmit); 
        document.body.addEventListener("click", handleGlobalClick); 
        document.body.addEventListener("change", handleGlobalChange); 
        document.getElementById("searchInput")?.addEventListener("keyup", e => filterProducts(e.target.value)); 
        let notesTimeout; 
        document.getElementById("notas-dia")?.addEventListener("input", e => { clearTimeout(notesTimeout); notesTimeout = setTimeout(() => StateManager.updateNotes(e.target.value), 300); }); 
        document.getElementById('menu-toggle')?.addEventListener('change', e => { if (!e.target.checked) { document.querySelector('.header-menu')?.scrollTo(0, 0); } }); 
        document.getElementById('enableEncryption')?.addEventListener('change', (e) => { const warning = document.getElementById('encryptionWarning'); if (warning) { warning.classList.toggle('hidden', !e.target.checked); } }); 
        
        // Listeners para Insumos
        document.getElementById('addInsumoBtn')?.addEventListener('click', handleAddInsumo);
        document.getElementById('insumo-qty')?.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') handleAddInsumo();
        });
    }
    function handleGlobalClick(e) { if (e.target.matches('input[type="number"], input[type="text"]')) e.target.select(); const target = e.target.closest("[data-action], .modal-backdrop, .modal .close, .filter-buttons button"); if (!target) return; const action = target.dataset.action; if (action) { if (action.startsWith('bc_')) { handleBillCounterActions(action, { toggleModal }); return; } const handler = actionHandlers[action]; if (handler) { handler(target); return; } } else if (target.matches(".modal-backdrop, .modal .close")) { const modal = target.closest(".modal"); if (modal && !modal.classList.contains('is-persistent')) { const modalId = modal.id; if (modalId && !['alertModal', 'confirmModal', 'promptModal'].includes(modalId)) toggleModal(modalId, false); } } else if (target.matches(".filter-buttons button")) { const period = target.dataset.period; if (period) handleFinancialSummary(period); } }
    function handleGlobalChange(e) { const target = e.target; if (target.matches("#product-list input[data-field]")) { const { productId, field } = target.dataset; if (productId && field) StateManager.updateProductFieldById(productId, field, target.value); } else if (target.id === "selectAllCheckbox") { toggleAllCheckboxes(target.checked); } if (target.matches("#note-diferencia-tipo, #note-diferencia-monto")) { const tipo = document.getElementById("note-diferencia-tipo")?.value; const monto = document.getElementById("note-diferencia-monto")?.value; StateManager.updateDiferenciaCaja(tipo, monto); } }
    function handleFormSubmit(e) { e.preventDefault(); switch (e.target.id) { case 'loginForm': handleLogin(); break; case 'createForm': handleCreateBusiness(); break; case 'pinForm': verifyPin(); break; case 'addProductForm': addProduct(); break; case 'addGastoForm': addGasto(); break; } }
    
    // --- APP START ---
    console.log(`main.js: Módulo cargado. Versión ${APP_VERSION}`);
    let pizzaDataLoader;
    document.addEventListener('DOMContentLoaded', main);

    function checkInitialLockStatus() {
        const lockStatus = localStorage.getItem('ipv_lock_status');
        if (lockStatus === 'false') {
            StatusChecker.lockScreen();
            return true;
        }
        return false;
    }

    async function main() {
        initTheme();
        if (checkInitialLockStatus()) { console.log("Bloqueado al inicio."); return; }
        
        // Inyectar HTML de Insumos antes de inicializar la lógica
        injectInsumosHTML();

        setAppVersion(APP_VERSION); setupEventListeners();
        const calculatorFunctions = initializeCalculators({ toggleModal });
        pizzaDataLoader = calculatorFunctions.loadPizzaData;
        init(Session);
        StateManager.subscribe((data) => { if (!data || !Session.businessName) return; renderApp(data, Session); if (pizzaDataLoader) pizzaDataLoader(data); saveDataForCurrentDate(data); });
        if (Session.load()) {
            Session.isOwner = localStorage.getItem('ipv_is_owner') === 'true';
            showMainApp();
            if (typeof updateWarehouseAutocomplete === 'function') {
                const cachedWh = localStorage.getItem(`ipv_warehouse_cache_${Session.businessName}`);
                if (cachedWh) { try { updateWarehouseAutocomplete(JSON.parse(cachedWh)); } catch (e) {} }
            }
            const workerName = sessionStorage.getItem('ipv_worker_name');
            if (workerName) { const displayEl = document.getElementById('worker-name-display'); if (displayEl) { const spanEl = displayEl.querySelector('span'); if (spanEl) spanEl.textContent = workerName; displayEl.classList.remove('hidden'); } }
            if (Session.isOwner) { const ownerSection = document.getElementById('owner-admin-section'); if (ownerSection) ownerSection.classList.remove('hidden'); }
            StatusChecker.start();
            const dateInput = document.getElementById('dateInput');
            const lastDate = localStorage.getItem('ipv_last_selected_date') || new Date().toISOString().split('T')[0];
            if (dateInput) { dateInput.value = lastDate; dateInput.addEventListener('change', (e) => loadDataForDate(e.target.value)); }
            loadLocalDataAndThenSync(lastDate);
        } else { showLoginScreen(); }
        setupScrollAndHeaderListeners();
    }
    async function loadLocalDataAndThenSync(dateString) { showLoading('Cargando datos locales...'); Session.currentDate = dateString; const storageKey = `ipv_data_${Session.businessName}_${dateString}`; let localData = null; try { localData = JSON.parse(localStorage.getItem(storageKey)); } catch (e) { } if (!localData) { localData = await createNewDayDataFromPrevious(Session); } localStorage.setItem("ipv_last_selected_date", dateString); const finalData = normalizeData(localData, Session.businessName); StateManager.setState(finalData); hideLoading(); syncWithCloudInBackground(dateString); }
    async function syncWithCloudInBackground(dateString) { if (!navigator.onLine || Session.businessName === "local_mode") return; try { const cloudResponse = await ApiClient.getDailyData(Session.businessName, Session.password, dateString); if (cloudResponse.status === "success" && cloudResponse.data) { const currentLocalData = StateManager.getState(); const mergedData = normalizeData(mergeData(currentLocalData, cloudResponse.data), Session.businessName); StateManager.setState(mergedData); updateSyncIndicator(false); } } catch (error) { console.error("Fallo sync background:", error); } }
    async function loadDataForDate(dateString) { showLoading(`Cargando ${dateString}...`); Session.currentDate = dateString; localStorage.setItem("ipv_last_selected_date", dateString); let finalData = null; if (navigator.onLine && Session.businessName !== "local_mode") { try { const response = await ApiClient.getDailyData(Session.businessName, Session.password, dateString); if (response.status === "success" && response.data) { let cloudData = response.data; if (cloudData.isEncrypted) { if (!Session.encryptionKey) { hideLoading(); await showAlert("Sin clave de encriptación.", "Error"); return; } const decrypted = decryptData(cloudData.payload, Session.encryptionKey); if (decrypted && decrypted.error) { hideLoading(); await showAlert("Clave incorrecta.", "Error"); return; } cloudData = decrypted; } finalData = unwrapDataRecursively(cloudData); } } catch (error) {} } if (!finalData) { const storageKey = `ipv_data_${Session.businessName}_${dateString}`; try { const localRawData = JSON.parse(localStorage.getItem(storageKey)); finalData = unwrapDataRecursively(localRawData); } catch (e) {} } if (!finalData) { finalData = await createNewDayDataFromPrevious(Session); } finalData = normalizeData(finalData, Session.businessName); StateManager.setState(finalData); hideLoading(); updateSyncIndicator(false); }
    function unwrapDataRecursively(data) {
    if (!data) return null;
    
    // 1. PRIORIDAD AL PAYLOAD: Si existe payload, ignoramos cualquier basura (como products:[]) en la raíz
    if (typeof data === 'object' && data.payload) {
        try {
            return unwrapDataRecursively(JSON.parse(data.payload));
        } catch (e) {
            return null;
        }
    }

    // 2. Si es string, intentamos parsear
    if (typeof data === 'string') {
        try {
            return unwrapDataRecursively(JSON.parse(data));
        } catch (e) {
            return null;
        }
    }

    // 3. Solo si no hay payload, aceptamos el objeto directo
    if (typeof data === 'object' && data.products) return data;

    return null;
}
    function saveDataForCurrentDate(data) { if (!Session.businessName || !Session.currentDate) return; localStorage.setItem(`ipv_data_${Session.businessName}_${Session.currentDate}`, JSON.stringify(data)); updateSyncIndicator(true); }
    function mergeData(local, cloud) { if (!local) return cloud; if (!cloud) return local; const merged = { ...cloud, ...local }; const allProducts = new Map(); [...(cloud.products || []), ...(local.products || [])].forEach(p => { if (p && p.id) { const existing = allProducts.get(String(p.id)); if (!existing || new Date(p.lastModified || 0) > new Date(existing.lastModified || 0)) allProducts.set(String(p.id), p); } }); merged.products = Array.from(allProducts.values()); const allGastos = new Map(); [...(cloud.gastos || []), ...(local.gastos || [])].forEach(g => { if (g && g.id) { const existing = allGastos.get(String(g.id)); if (!existing || new Date(g.lastModified || 0) > new Date(existing.lastModified || 0)) allGastos.set(String(g.id), g); } }); merged.gastos = Array.from(allGastos.values()); const localPizza = local.pizzaCalcs; const cloudPizza = cloud.pizzaCalcs; if (localPizza && cloudPizza) merged.pizzaCalcs = new Date(localPizza.lastModified || 0) > new Date(cloudPizza.lastModified || 0) ? localPizza : cloudPizza; else merged.pizzaCalcs = localPizza || cloudPizza || {}; return merged; }
    function setupScrollAndHeaderListeners() { const header = document.getElementById('header'); if (!header) return; let lastScrollTop = 0; window.addEventListener('scroll', () => { let scrollTop = window.pageYOffset || document.documentElement.scrollTop; header.classList.toggle('header-hidden', scrollTop > lastScrollTop && scrollTop > 100); lastScrollTop = scrollTop <= 0 ? 0 : scrollTop; const scrollToTopBtn = document.getElementById('scrollToTopBtn'); const scrollToBottomBtn = document.getElementById('scrollToBottomBtn'); const scrollHeight = document.documentElement.scrollHeight; const clientHeight = document.documentElement.clientHeight; if (scrollToTopBtn) { scrollToTopBtn.classList.toggle('visible', scrollTop > 200); } if (scrollToBottomBtn) { scrollToBottomBtn.classList.toggle('visible', scrollTop + clientHeight < scrollHeight - 200); } }); document.getElementById('scrollToTopBtn')?.addEventListener('click', () => { window.scrollTo({ top: 0, behavior: 'smooth' }); }); document.getElementById('scrollToBottomBtn')?.addEventListener('click', () => { window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }); }); }

   // =========================================================
    // MÓDULO: BORRADOR DE CONTEO (V4 - FIXED WIDTHS)
    // =========================================================
    
    // =========================================================
    // MÓDULO: BORRADOR DE CONTEO (V5 - FULL SCREEN & ENTRIES)
    // =========================================================
    
    let draftCollapsedCategories = new Set();
    function getDraftKey() { return 'ipv_draft_data_v2'; } // Clave nueva para evitar conflictos

    // 1. ABRIR MODAL
    function handleOpenDraftModal() {
        const state = StateManager.getState();
        // Mostrar productos activos. Si inicio es 0, pero es un producto activo, lo mostramos para permitir entradas.
        const activeProducts = (state.products || []).filter(p => p.isActive !== false);

        if (activeProducts.length === 0) return showAlert("No hay productos activos.");

        const modalContent = document.querySelector('#draftModal .modal-content');
        if (modalContent) {
            // Reemplazamos TODO el contenido del modal para control total del layout
            modalContent.innerHTML = `
                <div class="draft-header-compact">
                    <div style="display:flex; gap:5px; flex-grow:1;">
                        <input type="text" id="draftSearchInput" placeholder="🔍 Buscar..." 
                               style="width: 100%; max-width: 140px; padding: 6px; background: var(--bg-primary); border: 1px solid var(--border-glass); color: white; border-radius: 4px; font-size: 0.85rem;"
                               onkeyup="window.filterDraftTable(this.value)">
                        
                        <button onclick="window.toggleAllDraftCategories()" class="btn-draft-compact" title="Expandir/Contraer">
                            ↕
                        </button>
                    </div>

                    <div class="draft-controls-group">
                        <button class="btn-draft-compact" onclick="window.clearDraftData()" style="color: var(--danger-color); border-color: var(--danger-color);">
                            🗑️
                        </button>
                        <button class="btn-draft-compact btn-draft-action" onclick="window.applyAllDraftCounts()">
                            ✅ Aplicar
                        </button>
                        <button class="close" style="position:static; margin-left:5px; width:30px; height:30px; font-size:24px;" onclick="document.getElementById('draftModal').style.display='none'; document.body.style.overflow='';">&times;</button>
                    </div>
                </div>
                
                <div class="modal-scrollable-content" style="padding: 0 !important; flex-grow: 1;">
                    <table class="responsive-table" id="draft-table">
                        <thead style="position: sticky; top: 0; z-index: 40; background: var(--bg-dark);">
                            <tr>
                                <th>PROD.</th>
                                <th>INI.</th>
                                <th>ENT.</th>
                                <th>FIN.</th>
                                <th>OK</th>
                            </tr>
                        </thead>
                        <tbody id="draft-table-body"></tbody>
                    </table>
                </div>
            `;
        }

        renderDraftRows(activeProducts);
        toggleModal('draftModal', true);
        // Pequeño hack para enfocar el input sin teclado en móviles si se desea, o solo dar foco visual
        // setTimeout(() => document.getElementById('draftSearchInput')?.focus(), 100);
    }

    // 2. RENDERIZAR FILAS
   // 2. RENDERIZAR FILAS (CON DATOS PRE-CARGADOS DEL IPV)
    function renderDraftRows(products) {
        const tbody = document.getElementById('draft-table-body');
        if (!tbody) return;
        tbody.innerHTML = '';

        const productsByCategory = products.reduce((acc, p) => {
            const cat = p.category || "General";
            if (!acc[cat]) acc[cat] = [];
            acc[cat].push(p);
            return acc;
        }, {});

        let savedDraft = {};
        try {
            const raw = localStorage.getItem(getDraftKey());
            if (raw) {
                const p = JSON.parse(raw);
                if (p.date === Session.currentDate && p.business === Session.businessName) savedDraft = p.counts || {};
            }
        } catch (e) {}

        const sortedCategories = Object.keys(productsByCategory).sort((a, b) => a.localeCompare(b));

        sortedCategories.forEach(category => {
            const isCollapsed = draftCollapsedCategories.has(category);
            const icon = isCollapsed ? '►' : '▼';

            // Fila Categoría
            const catRow = document.createElement('tr');
            catRow.className = "category-row";
            catRow.onclick = () => window.toggleDraftCategory(category);
            catRow.innerHTML = `<td colspan="5" style="text-align: left; padding: 10px 8px !important; font-weight: bold; background: var(--bg-primary); color: var(--primary-cyan); cursor: pointer; border-bottom: 1px solid var(--border-glass);">
                ${icon} ${category}
            </td>`;
            tbody.appendChild(catRow);

            productsByCategory[category].sort((a, b) => a.name.localeCompare(b.name)).forEach(p => {
                const data = savedDraft[p.id] || {};
                
                // === LÓGICA DE VISUALIZACIÓN ===
                // 1. Si existe un valor en el borrador (data.e/f), se usa ese (prioridad).
                // 2. Si no, se usa el valor actual del sistema (p.entrada / p.finales).
                // 3. Mostramos vacío ("") si es 0 en entradas para limpiar la vista, o el número si es > 0.
                
                // --- ENTRADAS ---
                let valEntrada;
                if (data.e !== undefined) {
                    valEntrada = data.e; // Valor modificado en borrador
                } else {
                    valEntrada = (p.entrada && p.entrada !== 0) ? p.entrada : ""; // Valor original del IPV
                }

                // --- FINALES (FÍSICO) ---
                let valFinales;
                if (data.f !== undefined) {
                    valFinales = data.f; // Valor modificado en borrador
                } else {
                    // Si p.finales es null o undefined, mostramos vacío. Si es 0, mostramos 0 (stock agotado).
                    valFinales = (p.finales !== undefined && p.finales !== null) ? p.finales : "";
                }

                // Colorear solo si el valor del borrador es diferente al del sistema
                // Nota: Usamos '!=' para no discriminar entre 0 y "0"
                const diffClassE = (data.e !== undefined && data.e != (p.entrada || 0)) ? 'differs' : '';
                const diffClassF = (data.f !== undefined && data.f != (p.finales || 0)) ? 'differs' : '';

                const tr = document.createElement('tr');
                tr.dataset.id = p.id;
                tr.className = "product-draft-row";
                if (isCollapsed) tr.style.display = "none";

                tr.innerHTML = `
                    <td title="${escapeHtml(p.name)}">${escapeHtml(p.name)}</td>
                    <td style="color: var(--text-secondary);">${p.start}</td>
                    <td>
                        <input type="number" class="draft-input input-entrada ${diffClassE}" value="${valEntrada}" placeholder="-" 
                               oninput="window.saveSingleDraftInput(this, '${p.id}', 'e')">
                    </td>
                    <td>
                        <input type="number" class="draft-input ${diffClassF}" value="${valFinales}" placeholder="-" 
                               oninput="window.saveSingleDraftInput(this, '${p.id}', 'f')">
                    </td>
                    <td>
                        <button class="btn-icon-apply" onclick="window.applySingleDraftRow('${p.id}')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        });
    }

    // 3. FUNCIONES GLOBALES
    window.toggleDraftCategory = function(cat) {
        if (draftCollapsedCategories.has(cat)) draftCollapsedCategories.delete(cat); else draftCollapsedCategories.add(cat);
        const state = StateManager.getState();
        const s = document.getElementById('draftSearchInput')?.value || "";
        renderDraftRows((state.products||[]).filter(p=>p.isActive!==false)); // Mostrar todos
        if(s) window.filterDraftTable(s);
    };

    window.toggleAllDraftCategories = function() {
        const state = StateManager.getState();
        const active = (state.products||[]).filter(p=>p.isActive!==false);
        if (draftCollapsedCategories.size > 0) draftCollapsedCategories.clear();
        else draftCollapsedCategories = new Set(active.map(p => p.category || "General"));
        renderDraftRows(active);
    };

    window.filterDraftTable = function(q) {
        const t = q.toLowerCase();
        const rows = document.querySelectorAll('#draft-table-body tr');
        let curHeader = null, showHeader = false;
        
        if (!t) {
            const state = StateManager.getState();
            renderDraftRows((state.products||[]).filter(p=>p.isActive!==false));
            return;
        }

        rows.forEach(r => {
            if (r.classList.contains('category-row')) {
                if (curHeader) curHeader.style.display = showHeader ? '' : 'none';
                curHeader = r; showHeader = false;
            } else if (r.classList.contains('product-draft-row')) {
                if (r.cells[0].textContent.toLowerCase().includes(t)) {
                    r.style.display = ''; showHeader = true;
                } else { r.style.display = 'none'; }
            }
        });
        if (curHeader) curHeader.style.display = showHeader ? '' : 'none';
    };

    // type: 'e' (entrada) o 'f' (finales)
    window.saveSingleDraftInput = function(inp, id, type) {
        inp.classList.toggle('differs', inp.value !== "");
        let d = { date: Session.currentDate, business: Session.businessName, counts: {} };
        
        try { 
            const r = localStorage.getItem(getDraftKey()); 
            if(r) { 
                const p = JSON.parse(r); 
                if(p.date===Session.currentDate) d=p; 
            } 
        } catch{}

        // Inicializar objeto para este producto si no existe
        if (!d.counts[id]) d.counts[id] = {};

        // Guardar valor
        if (inp.value === "") {
            delete d.counts[id][type]; // Eliminar clave si está vacío
            // Si el objeto queda vacío, borrarlo del mapa principal
            if (Object.keys(d.counts[id]).length === 0) delete d.counts[id];
        } else {
            d.counts[id][type] = parseFloat(inp.value);
        }
        
        localStorage.setItem(getDraftKey(), JSON.stringify(d));
    };

    window.applySingleDraftRow = function(id) {
        const row = document.querySelector(`#draft-table-body tr[data-id="${id}"]`); if (!row) return;
        const inputE = row.querySelector('.input-entrada');
        const inputF = row.querySelector('.draft-input:not(.input-entrada)');
        
        let changed = false;

        // Aplicar Entrada
        if (inputE && inputE.value !== "") {
            StateManager.updateProductFieldById(id, 'entrada', inputE.value);
            changed = true;
        }

        // Aplicar Finales
        if (inputF && inputF.value !== "") {
            StateManager.updateProductFieldById(id, 'finales', inputF.value);
            changed = true;
        }

        if(!changed) return showAlert("Escribe cantidad en Entrada o Final.");

        row.style.opacity="0.5"; row.style.pointerEvents="none";
        const btn = row.querySelector('.btn-icon-apply');
        if(btn) { 
            btn.style.background="var(--success-color)"; 
            btn.style.borderColor="var(--success-color)"; 
            btn.style.color="#000"; 
            btn.innerHTML = "✓";
        }
        if(navigator.vibrate) navigator.vibrate(50);
    };

    window.applyAllDraftCounts = async function() {
        // Recuperar datos guardados
        let savedDraft = {};
        try {
            const raw = localStorage.getItem(getDraftKey());
            if (raw) savedDraft = JSON.parse(raw).counts || {};
        } catch (e) { return showAlert("Error leyendo borrador."); }

        const ids = Object.keys(savedDraft);
        if(ids.length === 0) return showAlert("Borrador vacío.");

        if(!await showConfirm(`¿Aplicar cambios a ${ids.length} productos?`)) return;
        
        showLoading("Aplicando...");
        
        ids.forEach(id => {
            const data = savedDraft[id];
            if (data.e !== undefined) StateManager.updateProductFieldById(id, 'entrada', data.e);
            if (data.f !== undefined) StateManager.updateProductFieldById(id, 'finales', data.f);
        });

        // Marcar visualmente como completado
        ids.forEach(id => {
            const row = document.querySelector(`#draft-table-body tr[data-id="${id}"]`);
            if (row) {
                row.style.opacity="0.5"; 
                const btn = row.querySelector('.btn-icon-apply');
                if(btn) { btn.innerHTML = "✓"; btn.style.background="var(--success-color)"; btn.style.color="black";}
            }
        });

        hideLoading(); 
        showAlert("Datos aplicados correctamente.");
        // Opcional: Cerrar modal automáticamente
        // setTimeout(() => toggleModal('draftModal', false), 1000);
    };

    window.clearDraftData = async function() {
        if(await showConfirm("¿Borrar todos los datos del borrador?")) { 
            localStorage.removeItem(getDraftKey()); 
            handleOpenDraftModal(); // Recargar vista
        }
    };
    // =========================================================
    // INICIALIZACIÓN
    // =========================================================
    
    // Agregamos las nuevas acciones al diccionario de handlers
    // NOTA: Combinamos esto con los handlers existentes
    Object.assign(actionHandlers, {
        'menu-open-draft': handleOpenDraftModal,
        'menu-generate-stock-pdf': handleGenerateStockPDF
    });

    })(); // <--- CIERRE CORRECTO DE LA APP


</script>

</body>
</html>
